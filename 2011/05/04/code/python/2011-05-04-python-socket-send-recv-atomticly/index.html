<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico">
  <link rel="mask-icon" href="/icon.svg" color="#222">
  <meta name="google-site-verification" content="hcdiytqUGPoTW0eAaN6TWAmRfiv7IWFIIc9DKNr7Eno">
  <meta name="yandex-verification" content="eb8f01295fdccb3d">
  <meta name="baidu-site-verification" content="QoJxa8tZnO">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Times+New+Roman:300,300italic,400,400italic,700,700italic%7CRaleway:300,300italic,400,400italic,700,700italic%7COswald:300,300italic,400,400italic,700,700italic%7CWork+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chillyc.info","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":20,"unescape":false,"preload":false}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/config.min.js"></script>

    <meta name="description" content="first we write simplest client and server.  in client.py 123456789101112131415161718import socketclass Client:    def __init__(self, host , port, bufsize &#x3D; 1024, timeout &#x3D; 10):        self.cl">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Socket Send and Recv Atomticly ">
<meta property="og:url" content="http://chillyc.info/2011/05/04/code/python/2011-05-04-python-socket-send-recv-atomticly/">
<meta property="og:site_name" content="帐前卒专栏">
<meta property="og:description" content="first we write simplest client and server.  in client.py 123456789101112131415161718import socketclass Client:    def __init__(self, host , port, bufsize &#x3D; 1024, timeout &#x3D; 10):        self.cl">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2011-05-03T16:00:00.000Z">
<meta property="article:modified_time" content="2024-05-16T16:12:27.021Z">
<meta property="article:author" content="帐前卒">
<meta property="article:tag" content="有意思的代码，有意思的架构, 有趣的小说, 好看的故事, code, software, articles, novel, architect">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chillyc.info/2011/05/04/code/python/2011-05-04-python-socket-send-recv-atomticly/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://chillyc.info/2011/05/04/code/python/2011-05-04-python-socket-send-recv-atomticly/","path":"2011/05/04/code/python/2011-05-04-python-socket-send-recv-atomticly/","title":"Python Socket Send and Recv Atomticly "}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Python Socket Send and Recv Atomticly  | 帐前卒专栏</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="帐前卒专栏" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <!-- Global site tag (gtag.js) - Google Analytics start -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11621532-3"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6565392687771630"
     crossorigin="anonymous"></script>
<script>
  window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-11621532-3');
</script>
 <!-- Global site tag (gtag.js) - Google Analytics end -->
  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">帐前卒专栏</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">code, software architect, articles and novels.<br/>代码，软件架构，博客和小说</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-feeds"><a href="/rss2.xml" rel="section"><i class="fa fa-feed fa-fw"></i>feeds</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#in-clientpy"><span class="nav-number">1.</span> <span class="nav-text"> in client.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in-serverpy"><span class="nav-number">2.</span> <span class="nav-text"> in server.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in-client_startpy"><span class="nav-number">3.</span> <span class="nav-text"> in client_start.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in-server_startpy"><span class="nav-number">4.</span> <span class="nav-text"> in server_start.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in-run-function-of-server-in-serverpy"><span class="nav-number">5.</span> <span class="nav-text"> in “run” function of Server in server.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#change-run-function-and-add-a-new-function-called-servicewaiting"><span class="nav-number">6.</span> <span class="nav-text"> change run function and add a new function called “serviceWaiting”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#we-should-change-a-function-in-our-former-code"><span class="nav-number">7.</span> <span class="nav-text"> we should change a function in our former code:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#then-we-should-add-two-function-for-sending-and-receive-objects"><span class="nav-number">8.</span> <span class="nav-text"> then we should add two function for sending and receive objects</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#in-connection-function-of-client-in-clientpy"><span class="nav-number">9.</span> <span class="nav-text"> in connection function of Client in client.py</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="帐前卒"
      src="/icon.svg">
  <p class="site-author-name" itemprop="name">帐前卒</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">798</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoaWxseQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chilly"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9jY3R0XzE=" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;cctt_1"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLW5kLzQuMC8="><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/big/by_nc_nd.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2011/05/04/code/python/2011-05-04-python-socket-send-recv-atomticly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Python Socket Send and Recv Atomticly  | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Python Socket Send and Recv Atomticly 
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2011-05-04 00:00:00" itemprop="dateCreated datePublished" datetime="2011-05-04T00:00:00+08:00">2011-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-05-17 00:12:27" itemprop="dateModified" datetime="2024-05-17T00:12:27+08:00">2024-05-17</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><meta name="_edit_last" content="1" />
<meta name="_su_rich_snippet_type" content="none" />
<meta name="Mood" content="soso" />
<meta name="Weather" content="cloudy" />
<meta name="Doing" content="paper, write c/c++ code and play games" />
<meta name="_su_description" content="this is describe how to create server and client in python. And how to fix bug in simplest server and client." />
<meta name="_su_keywords" content="python,socket,server,client,send,recv" />
<meta name="_su_title" content="python,socket,server,client,send,recv" />
<meta name="views" content="1808" />
first we write simplest client and server.
<h2 id="in-clientpy"><a class="markdownIt-Anchor" href="#in-clientpy"></a> in <span class="exturl" data-url="aHR0cDovL2NsaWVudC5weQ==">client.py<i class="fa fa-external-link-alt"></i></span></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Client</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host , port, bufsize = <span class="number">1024</span>, timeout = <span class="number">10</span></span>):</span><br><span class="line">        self.client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port  = port</span><br><span class="line">        self.bufsize = bufsize</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.client.connect((self.host,self.port))</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        self.client.close()</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, string</span>):</span><br><span class="line">        self.client.send(<span class="built_in">bytes</span>(string,<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.client.recv(self.bufsize),encoding=<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="in-serverpy"><a class="markdownIt-Anchor" href="#in-serverpy"></a> in <span class="exturl" data-url="aHR0cDovL3NlcnZlci5weQ==">server.py<i class="fa fa-external-link-alt"></i></span></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,port,listen = <span class="number">5</span>,timeout = <span class="number">10</span>, buf = <span class="number">4096</span>, queueSize = <span class="number">10</span></span>):</span><br><span class="line">        self.host = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">        self.port = port</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.listen = listen</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, conn, string</span>):</span><br><span class="line">        conn.send(<span class="built_in">bytes</span>(string,encoding=<span class="string">&quot;utf8&quot;</span>))       </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self, conn</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(conn.recv(self.bufsize),encoding=<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;server start, port:&quot;</span>,self.port,<span class="string">&quot;listen num:&quot;</span>,self.listen)</span><br><span class="line">        self.sock.bind((self.host, self.port))</span><br><span class="line">        self.sock.listen(self.listen)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            connection, address = self.sock.accept()</span><br><span class="line">            message = self.recv(connection)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;message&#x27;</span>,message)</span><br><span class="line">            self.send(connection,<span class="string">&#x27;OK&#x27;</span>)</span><br><span class="line">            connection.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>next I will write some code to run client and server. Here is :</p>
<h2 id="in-client_startpy"><a class="markdownIt-Anchor" href="#in-client_startpy"></a> in client_start.py</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> client <span class="keyword">import</span> Client</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    c = Client(<span class="string">&#x27;localhost&#x27;</span>,<span class="number">7777</span>)</span><br><span class="line">    c.connect()</span><br><span class="line">    c.send(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">    message = c.recv()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;message&#x27;</span>,message)</span><br></pre></td></tr></table></figure>
<h2 id="in-server_startpy"><a class="markdownIt-Anchor" href="#in-server_startpy"></a> in server_start.py</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> server <span class="keyword">import</span> Server</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    s = Server(<span class="number">7777</span>, listen = <span class="number">1000</span>)</span><br><span class="line">    s.run()</span><br></pre></td></tr></table></figure>
<p>Run server_start.py firstly and then run client_start.py. You will find both client and server print messages. Then client is shut down, but server is still running. Yup. Server should not shut down in order to supply services. And shut client down to close socket connection and save resources of server. These code runs perfectly. But we still should make some improvement. Server can server many clients. When it servers one client connection, it should server other connections and not be held by the former connection. Now multi-thread is considered.</p>
<h2 id="in-run-function-of-server-in-serverpy"><a class="markdownIt-Anchor" href="#in-run-function-of-server-in-serverpy"></a> in “run” function of Server in <span class="exturl" data-url="aHR0cDovL3NlcnZlci5weQ==">server.py<i class="fa fa-external-link-alt"></i></span></h2>
<h2 id="change-run-function-and-add-a-new-function-called-servicewaiting"><a class="markdownIt-Anchor" href="#change-run-function-and-add-a-new-function-called-servicewaiting"></a> change run function and add a new function called “serviceWaiting”</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">serviceWaiting</span>(<span class="params">self, connection, address</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;connection:&quot;</span>,<span class="built_in">id</span>(connection),<span class="string">&quot;address:&quot;</span>,<span class="built_in">str</span>(address),<span class="string">&quot; connect...&quot;</span>)</span><br><span class="line">    message = self.recv(connection)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;message&#x27;</span>,message)</span><br><span class="line">    self.send(connection,<span class="string">&#x27;OK&#x27;</span>)</span><br><span class="line">    connection.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;server start, port:&quot;</span>,self.port,<span class="string">&quot;listen num:&quot;</span>,self.listen)</span><br><span class="line">    self.sock.bind((self.host, self.port))</span><br><span class="line">    self.sock.listen(self.listen)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        connection, address = self.sock.accept()</span><br><span class="line">        serverThread = Thread(target = self.serviceWaiting, args=(connection, address))</span><br><span class="line">        serverThread.start()</span><br></pre></td></tr></table></figure>
<p>Ok, done! Now server can server multi-clients in the same time. But only sending and receiving string is not enough for our applications.  Sending and receiving objects should be considered.<br />
Here we add two functions in <span class="exturl" data-url="aHR0cDovL2NsaWVudC5weQ==">client.py<i class="fa fa-external-link-alt"></i></span> and <span class="exturl" data-url="aHR0cDovL3NlcnZlci5weQ==">server.py<i class="fa fa-external-link-alt"></i></span>.</p>
<h2 id="we-should-change-a-function-in-our-former-code"><a class="markdownIt-Anchor" href="#we-should-change-a-function-in-our-former-code"></a> we should change a function in our former code:</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self, n= -<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> n == -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.client.recv(self.bufsize),encoding=<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self.client.recv(n),encoding=<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="then-we-should-add-two-function-for-sending-and-receive-objects"><a class="markdownIt-Anchor" href="#then-we-should-add-two-function-for-sending-and-receive-objects"></a> then we should add two function for sending and receive objects</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">def</span> <span class="title function_">recvObj</span>(<span class="params">self</span>):</span><br><span class="line">        OK = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">        obj = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            buffer = []</span><br><span class="line">            totalsize = self.recv()</span><br><span class="line"><span class="comment">#            print(&#x27;client:totalsize&#x27;,totalsize,&#x27;len:&#x27;,len(totalsize))</span></span><br><span class="line">            totalsize = <span class="built_in">int</span>(totalsize)</span><br><span class="line">            self.send(OK)</span><br><span class="line"><span class="comment">#            print(&#x27;client:send length ok&#x27;)</span></span><br><span class="line">            <span class="keyword">while</span> totalsize !=<span class="number">0</span>:</span><br><span class="line"><span class="comment">#                print(&#x27;client: receiving&#x27;)</span></span><br><span class="line">                tBuff = self.client.recv(self.bufsize)</span><br><span class="line">                totalsize -= <span class="built_in">len</span>(tBuff)</span><br><span class="line"><span class="comment">#                print(&#x27;client:tBuff len:&#x27;,len(tBuff))</span></span><br><span class="line">                buffer.extend(tBuff) </span><br><span class="line">            buffer = <span class="built_in">bytes</span>(buffer)</span><br><span class="line"><span class="comment">#            print(&#x27;client:buff len&#x27;,len(buffer))</span></span><br><span class="line">            obj = pickle.loads(buffer)</span><br><span class="line"><span class="comment">#            print(&#x27;client:server receiving done&#x27;)</span></span><br><span class="line"><span class="comment">#            print(&#x27;client:obj&#x27;,obj)</span></span><br><span class="line">            self.send(OK)</span><br><span class="line"><span class="comment">#            print(&#x27;client:send ok&#x27;)</span></span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&quot;client:time out&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> socket.timeout</span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;client:buff&#x27;</span>,buffer)</span><br><span class="line">            <span class="keyword">raise</span> EOFError</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sendObj</span>(<span class="params">self,  obj</span>):</span><br><span class="line">        OK = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            totalbytes = pickle.dumps(obj)</span><br><span class="line">            totalsize = <span class="built_in">len</span>(totalbytes)</span><br><span class="line"><span class="comment">#            print(&#x27;client:will send totalsize&#x27;)</span></span><br><span class="line">            self.send(<span class="built_in">str</span>(totalsize))</span><br><span class="line"><span class="comment">#            print(&#x27;client:send totalsize done&#x27;)</span></span><br><span class="line">            <span class="keyword">if</span> self.recv()== OK:</span><br><span class="line"><span class="comment">#                print(&#x27;client:send totalsize success and recv ok&#x27;)</span></span><br><span class="line">                self.client.sendall(totalbytes)</span><br><span class="line"><span class="comment">#                print(&#x27;client:send object done&#x27;)</span></span><br><span class="line">                string = self.recv(<span class="number">1</span>) </span><br><span class="line"><span class="comment">#                print(&#x27;client: recv string&#x27;,string)</span></span><br><span class="line">                <span class="keyword">if</span> string == OK:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;client:send object success, and recv ok&#x27;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;client:send object error&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;client:send object error&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;client:send object Exception&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Here I will explain these code.</p>
<ul>
<li>In sendObj(), first transform object to bytes and send the length of object. Then wait to receive “OK” message(string ‘Y’). If get OK message, then use sendall() function to send all bytes out. Then wait to receive another OK message. Here we use recv(1) to only get one char in receiving queue. We should not use recv to get more information which may not be used by sendObj() function.</li>
<li>In recvObj(), first receive the length of object. Then send OK message back. Receive bytes by fixed buffer each time. And receiv many times until we received all bytes of object. Then transform bytes to objects and send OK message back.<br />
Ok. Now we should consider if the we can not connect server at first time. How do we solve this problem? The simplest idea is try many times until we connected server successfully.We should change connection() function.</li>
</ul>
<h2 id="in-connection-function-of-client-in-clientpy"><a class="markdownIt-Anchor" href="#in-connection-function-of-client-in-clientpy"></a> in connection function of Client in <span class="exturl" data-url="aHR0cDovL2NsaWVudC5weQ==">client.py<i class="fa fa-external-link-alt"></i></span></h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">connect</span>(<span class="params">self, count = -<span class="number">1</span></span>):</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    success = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span> flag:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;connect...&#x27;</span>,self.host, self.port)</span><br><span class="line">            </span><br><span class="line">            self.client.connect((self.host,self.port))</span><br><span class="line">            self.client.settimeout(self.timeout)</span><br><span class="line">            success = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            count -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count == <span class="number">0</span>:</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> success</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>OK. Here we solved many problems, such as multi-clients, sending and receiving objects, and connection failed.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechat_pay.jpg" alt="帐前卒 WeChat Pay">
        <span>WeChat Pay</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="帐前卒 Alipay">
        <span>Alipay</span>
      </div>
      <div>
        <img src="/images/paypal.png" alt="帐前卒 PayPal">
        <span>PayPal</span>
      </div>
      <div>
        <img src="/bitcoin.png" alt="帐前卒 Bitcoin">
        <span>Bitcoin</span>
      </div>

  </div>
</div>

          <div class="followme">
  <span>Welcome to my other publishing channels</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="https://twitter.com/cctt_1">
            <span class="icon">
              <i class="fab fa-twitter"></i>
            </span>

            <span class="label">Twitter</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2011/05/03/6386670/" rel="prev" title="Python中引用的问题">
                  <i class="fa fa-angle-left"></i> Python中引用的问题
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2011/05/10/2011-05-10-rpg-maker-xp/" rel="next" title="RPG Maker XP 制作的游戏无法运行">
                  RPG Maker XP 制作的游戏无法运行 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">帐前卒</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">24:23</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/bookmark.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/search/local-search.min.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha256-3574TpfThVfeAhg+I4+N39EJiLN3QUkuEsMVe8hWAR4=" crossorigin="anonymous">


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"chilly/blog_comments","issue_term":"url","theme":"github-dark"}</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/comments/utterances.min.js"></script>

</body>
</html>
