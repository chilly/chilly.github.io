<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico">
  <link rel="mask-icon" href="/icon.svg" color="#222">
  <meta name="google-site-verification" content="hcdiytqUGPoTW0eAaN6TWAmRfiv7IWFIIc9DKNr7Eno">
  <meta name="yandex-verification" content="eb8f01295fdccb3d">
  <meta name="baidu-site-verification" content="QoJxa8tZnO">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Times+New+Roman:300,300italic,400,400italic,700,700italic%7CRaleway:300,300italic,400,400italic,700,700italic%7COswald:300,300italic,400,400italic,700,700italic%7CWork+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chillyc.info","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":20,"unescape":false,"preload":false}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/config.min.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="帐前卒专栏">
<meta property="og:url" content="http://chillyc.info/">
<meta property="og:site_name" content="帐前卒专栏">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="帐前卒">
<meta property="article:tag" content="有意思的代码，有意思的架构, 有趣的小说, 好看的故事, code, software, articles, novel, architect">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chillyc.info/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>帐前卒专栏 - code, software architect, articles and novels.<br/>代码，软件架构，博客和小说</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="帐前卒专栏" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <!-- Global site tag (gtag.js) - Google Analytics start -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11621532-3"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6565392687771630"
     crossorigin="anonymous"></script>
<script>
  window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-11621532-3');
</script>
 <!-- Global site tag (gtag.js) - Google Analytics end -->
  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">帐前卒专栏</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">code, software architect, articles and novels.<br/>代码，软件架构，博客和小说</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-feeds"><a href="/rss2.xml" rel="section"><i class="fa fa-feed fa-fw"></i>feeds</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="帐前卒"
      src="/icon.svg">
  <p class="site-author-name" itemprop="name">帐前卒</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">796</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">754</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoaWxseQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chilly"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9jY3R0XzE=" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;cctt_1"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLW5kLzQuMC8="><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/big/by_nc_nd.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2024/04/12/prometheus-java-client-usage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/12/prometheus-java-client-usage/" class="post-title-link" itemprop="url">Prometheus-Java-Client-Usage</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-12 17:55:33" itemprop="dateCreated datePublished" datetime="2024-04-12T17:55:33+08:00">2024-04-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-04-15 21:25:59" itemprop="dateModified" datetime="2024-04-15T21:25:59+08:00">2024-04-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/prometheus/" itemprop="url" rel="index"><span itemprop="name">prometheus</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-prometheus-介绍"><a class="markdownIt-Anchor" href="#1-prometheus-介绍"></a> 1. prometheus 介绍</h1>
<p>Prometheus 是一种开源的系统监控和警报工具，最初由 SoundCloud 开发，现在由 Cloud Native Computing Foundation (CNCF) 维护。它专门设计用于在动态环境中监控大规模的分布式系统。</p>
<p>以下是 Prometheus 的一些主要特点和功能：</p>
<ol>
<li>多维数据模型：Prometheus 使用多维数据模型来存储时间序列数据，每个时间序列由指标名称和一组标签组成，使得数据可以灵活地被查询和聚合。</li>
<li>灵活的查询语言：PromQL 是 Prometheus 的查询语言，它允许用户对时间序列数据进行高级查询、聚合和操作，以生成自定义的监控指标和警报条件。</li>
<li>持久化存储：Prometheus 使用本地存储引擎来持久化时间序列数据，可以配置多种存储后端，包括本地磁盘、远程对象存储等。</li>
</ol>
<h1 id="2-prometheus-如何接入及示例代码"><a class="markdownIt-Anchor" href="#2-prometheus-如何接入及示例代码"></a> 2. prometheus 如何接入及示例代码</h1>
<h2 id="maven依赖"><a class="markdownIt-Anchor" href="#maven依赖"></a> maven依赖</h2>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_httpserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="指标项"><a class="markdownIt-Anchor" href="#指标项"></a> 指标项</h2>
<ol>
<li>
<p>计数器（Counter）：</p>
<ul>
<li>用途：计数器用于累积值，通常用于表示累积事件的总数，如请求数、任务完成数等。计数器的值只能增加，不能减少或重置。</li>
<li>示例：表示请求数的总数。</li>
</ul>
</li>
<li>
<p>计量器（Gauge）：</p>
<ul>
<li>用途：计量器用于表示可变值，它可以增加、减少或重置。通常用于表示动态变化的数据，如内存使用量、并发连接数等。</li>
<li>示例：表示当前活跃用户数。内存占用数等</li>
</ul>
</li>
<li>
<p>直方图（Histogram）：</p>
<ul>
<li>用途：直方图用于度量观察值的分布情况，并提供一组用于汇总这些观察值的统计信息，如总数、均值、分位数等。</li>
<li>示例：表示请求延迟的分布情况。</li>
</ul>
</li>
<li>
<p>摘要（Summary）：</p>
<ul>
<li>用途：摘要与直方图类似，也用于度量观察值的分布情况。不同之处在于，摘要提供一组用于汇总这些观察值的统计信息，如总数、平均值、标准差等。</li>
<li>示例：表示响应时间的摘要信息。p99耗时统计等</li>
</ul>
</li>
</ol>
<h3 id="指标项counter"><a class="markdownIt-Anchor" href="#指标项counter"></a> 指标项Counter</h3>
<p>java代码示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.CollectorRegistry;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.Counter;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.HTTPServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">requestsTotal</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">            .name(<span class="string">&quot;myapp_requests_total&quot;</span>)</span><br><span class="line">            .help(<span class="string">&quot;Total number of requests.&quot;</span>)</span><br><span class="line">            .labelNames(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">            .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// Expose Prometheus metrics at http://localhost:9090/metrics</span></span><br><span class="line">        <span class="type">HTTPServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTTPServer</span>(<span class="number">9090</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Simulate a request and increment the counter</span></span><br><span class="line">        simulateRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wait for server to stop (not needed if you have other shutdown mechanisms)</span></span><br><span class="line">        server.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">simulateRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Increment the requestsTotal counter</span></span><br><span class="line">        requestsTotal.labels(<span class="string">&quot;simulate&quot;</span>).inc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这代码中count就是一直增加，在未来图表中，可以用当前时间的数字减去1分钟前的数字，就能得到当前1分钟内请求数。</p>
<p>另外需要注意的是<code>labelNames()</code>函数和<code>labels()</code>函数。这两个是配合使用的。这里可以增加任意的维度。未来搜索或者作图可以更好地展现。</p>
<p>例如，我希望统计不同路径的访问请求。<br />
那么我在<code>labels('不同的path')</code>, 这样就能分路径进行统计了。</p>
<p>如果你想统计不同的路径，不同的客户端请求数量。那么在注册Counter时，需要这样调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Counter</span> <span class="variable">requestsTotal</span> <span class="operator">=</span> Counter.build()</span><br><span class="line">        .name(<span class="string">&quot;myapp_requests_total&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Total number of requests.&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;path&quot;</span>, <span class="string">&quot;clientType&quot;</span>)</span><br><span class="line">        .register();</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"><span class="comment">// 然后在需要增加计数时这样处理.</span></span><br><span class="line">requestsTotal.labels(<span class="string">&quot;请求的URI&quot;</span>, <span class="string">&quot;iOS&quot;</span>).inc();</span><br><span class="line">requestsTotal.labels(<span class="string">&quot;请求的URI&quot;</span>, <span class="string">&quot;Android&quot;</span>).inc();</span><br></pre></td></tr></table></figure>
<h3 id="指标项gauge"><a class="markdownIt-Anchor" href="#指标项gauge"></a> 指标项Gauge</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.HTTPServer;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.Gauge;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApp</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Gauge</span> <span class="variable">myGauge</span> <span class="operator">=</span> Gauge.build()</span><br><span class="line">        .name(<span class="string">&quot;my_gauge&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;Example of a Gauge metric&quot;</span>)</span><br><span class="line">        .labelNames(<span class="string">&quot;label1&quot;</span>, <span class="string">&quot;label2&quot;</span>) <span class="comment">// 这里label非常重要。注意一定是有限集（可枚举，数量要有限制）</span></span><br><span class="line">        .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 启动 Prometheus HTTP 服务器，暴露指标数据</span></span><br><span class="line">        <span class="type">HTTPServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTTPServer</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟应用程序中的指标更新</span></span><br><span class="line">        updateMetrics();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟更新指标数据</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateMetrics</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 假设这是您应用程序的一部分，定期更新 Gauge 指标的值</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 更新 Gauge 指标的值，可以基于应用程序的状态或性能指标进行设置</span></span><br><span class="line">            myGauge.labels(<span class="string">&quot;value1&quot;</span>, <span class="string">&quot;value2&quot;</span>).set(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在这里进行其他业务逻辑和操作</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 休眠一段时间，模拟指标数据的定期更新</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">5000</span>); <span class="comment">// 5秒钟</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="指标项histogram"><a class="markdownIt-Anchor" href="#指标项histogram"></a> 指标项Histogram</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.HTTPServer;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.Histogram;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyApp</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Histogram</span> <span class="variable">requestDuration</span> <span class="operator">=</span> Histogram.build()</span><br><span class="line">        .name(<span class="string">&quot;http_request_duration_seconds&quot;</span>)</span><br><span class="line">        .help(<span class="string">&quot;HTTP request duration in seconds&quot;</span>)</span><br><span class="line">        .buckets(<span class="number">0.1</span>, <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>) <span class="comment">// 定义 Histogram 的 buckets</span></span><br><span class="line">        .register();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 启动 Prometheus HTTP 服务器，暴露指标数据</span></span><br><span class="line">        <span class="type">HTTPServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTTPServer</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 模拟应用程序中的请求处理</span></span><br><span class="line">        handleRequest();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模拟处理 HTTP 请求，并记录响应时间</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 假设这是您应用程序的一部分，处理 HTTP 请求并记录响应时间</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理 HTTP 请求，执行一些业务逻辑</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 响应时间为处理开始到结束之间的时间差</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录响应时间到 Histogram 中</span></span><br><span class="line">            requestDuration.observe(duration / <span class="number">1000.0</span>); <span class="comment">// 将毫秒转换为秒并记录</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在这里进行其他业务逻辑和操作</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的buckets定义了不同桶<br />
<code>[0, 0.1), [0.1, 0.5), [0.5, 1), [1, 2), [2, 5) [5, 正无穷)</code><br />
当耗时0.3秒被记录时，Prometheus将增加<code>[0, 0.1), [0.1, 0.5)</code>两个桶的值。</p>
<h3 id="指标项summary"><a class="markdownIt-Anchor" href="#指标项summary"></a> 指标项Summary</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.Summary;</span><br><span class="line"><span class="keyword">import</span> io.prometheus.client.CollectorRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个 Summary 指标</span></span><br><span class="line"><span class="type">Summary</span> <span class="variable">requestLatency</span> <span class="operator">=</span> Summary.build()</span><br><span class="line">    .name(<span class="string">&quot;http_request_duration_seconds&quot;</span>)</span><br><span class="line">    .help(<span class="string">&quot;HTTP request latency in seconds.&quot;</span>)</span><br><span class="line">    .quantile(<span class="number">0.5</span>, <span class="number">0.05</span>) <span class="comment">// 统计50%分位数，最大允许误差为 ±5%</span></span><br><span class="line">    .quantile(<span class="number">0.9</span>, <span class="number">0.01</span>)</span><br><span class="line">    .quantile(<span class="number">0.99</span>, <span class="number">0.001</span>)</span><br><span class="line">    .register();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在请求处理过程中记录持续时间</span></span><br><span class="line">Summary.<span class="type">Timer</span> <span class="variable">requestTimer</span> <span class="operator">=</span> requestLatency.startTimer();</span><br><span class="line"><span class="comment">// 执行请求处理逻辑</span></span><br><span class="line"><span class="comment">// 记录请求处理结束时间</span></span><br><span class="line">requestTimer.observeDuration();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可使用</span></span><br><span class="line">requestLatency.observe(cost_in_seconds)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="3-prometheus-检查是否成功"><a class="markdownIt-Anchor" href="#3-prometheus-检查是否成功"></a> 3. prometheus 检查是否成功</h1>
<p>这其实要看设置的监听端口是多少。例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.prometheus.client.exporter.HTTPServer;</span><br><span class="line">...</span><br><span class="line"><span class="type">HTTPServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HTTPServer</span>(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure>
<p>那么上述代码的启动后，且有指标生成后，访问<code>http://localhost:8080/metrics</code>就能看到相应的指标。</p>
<h1 id="4-使用注意事项"><a class="markdownIt-Anchor" href="#4-使用注意事项"></a> 4. 使用注意事项</h1>
<ol>
<li><code>labels(&quot;value1&quot;, &quot;value2&quot;)</code>中的<code>value1</code>和<code>value2</code>需要可数，不一定是枚举类型，但是数量是有限的。</li>
<li><code>buckets(0.1, 0.5, 1, 2, 5)</code>, 这里的值越多，统计性能就越低，占用的内存就越大</li>
<li>Histogram用于统计分布，Summary用来统计多少分位的数据。</li>
<li>Counter每次放入的是inc()或者inc(number)，放入的是增量。 Gauge每次放入的是当前的数据。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2024/04/02/how-to-use-tampermonkey/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/02/how-to-use-tampermonkey/" class="post-title-link" itemprop="url">How to Use Tampermonkey</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-02 18:04:16" itemprop="dateCreated datePublished" datetime="2024-04-02T18:04:16+08:00">2024-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-04-15 21:27:04" itemprop="dateModified" datetime="2024-04-15T21:27:04+08:00">2024-04-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/tampermonkey/" itemprop="url" rel="index"><span itemprop="name">tampermonkey</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>2 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-下载油猴tampermonkey"><a class="markdownIt-Anchor" href="#1-下载油猴tampermonkey"></a> 1. 下载油猴tampermonkey</h1>
<p>首先去chrome webstore下载<code>tampermonkey</code>,就是众所周知的油猴。</p>
<p>这东西还是要从专门的渠道下载。因为如果你要做免登录脚本，那么用户名，密码不可能避免的需要被这些脚本知道。</p>
<p>如果是恶意制作的油猴插件，可能这些脚本就会被传送的特殊的服务器上去。用户名及密码就可能被拿到。</p>
<p>我这里最近在尝试学习油猴插件来制作某些网站的免登录脚本。</p>
<p><strong>具体方法如下:</strong></p>
<ol>
<li>先找到要登录的网站</li>
<li>点击油猴的插件图标</li>
<li>选择<code>create a new script...</code></li>
<li>进入后修改<code>@name</code> 和 <code>@match</code> 一个是这个脚本文件的名字，一个是脚本会在哪个url下执行。 @match支持<code>*</code>通配符</li>
<li>然后在 <code>// Your code here...</code> 处编写代码</li>
</ol>
<h1 id="2-记录一下各个网站的登录脚本"><a class="markdownIt-Anchor" href="#2-记录一下各个网站的登录脚本"></a> 2. 记录一下各个网站的登录脚本</h1>
<h2 id="1-xxl-job-admin"><a class="markdownIt-Anchor" href="#1-xxl-job-admin"></a> 1. xxl-job-admin</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;:text&quot;</span>)[<span class="number">0</span>].<span class="property">value</span>=<span class="string">&quot;your name&quot;</span>;</span><br><span class="line">$(<span class="string">&quot;:password&quot;</span>)[<span class="number">0</span>].<span class="property">value</span>=<span class="string">&#x27;your password&#x27;</span>;</span><br><span class="line">$(<span class="string">&quot;:checkbox&quot;</span>)[<span class="number">0</span>].<span class="property">checked</span>=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> loginButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;button[type=&#x27;submit&#x27;]&quot;</span>);</span><br><span class="line">loginButton.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-gitlab"><a class="markdownIt-Anchor" href="#2-gitlab"></a> 2. gitlab</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>).<span class="property">value</span>=<span class="string">&quot;your name&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>).<span class="property">value</span>=<span class="string">&quot;your password&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.btn-confirm&#x27;</span>).<span class="title function_">click</span>();</span><br></pre></td></tr></table></figure>
<h2 id="3-grafana"><a class="markdownIt-Anchor" href="#3-grafana"></a> 3. grafana</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> userId = <span class="string">&#x27;your name&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> password = <span class="string">&#x27;your password&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> userInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[name^=user]&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> passwordInput= <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input[name^=password]&#x27;</span>);</span><br><span class="line">   </span><br><span class="line"><span class="keyword">var</span> loginButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.css-3coq9d-button&#x27;</span>);</span><br><span class="line"></span><br><span class="line">userInput.<span class="property">value</span> = userId;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">userInput.<span class="title function_">blur</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">passwordInput.<span class="property">value</span> = password;</span><br><span class="line"></span><br><span class="line">passwordInput.<span class="title function_">blur</span>();</span><br><span class="line"><span class="comment">// grafana 是非常奇怪的，这里需要两次click, 缺少任何一次都无法正常登录</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    </span><br><span class="line">    loginButton.<span class="title function_">click</span>();</span><br><span class="line">    &#125;,<span class="number">1200</span>);</span><br><span class="line">&#125;,<span class="number">1200</span>);</span><br><span class="line"></span><br><span class="line">loginButton.<span class="title function_">click</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4-rancher"><a class="markdownIt-Anchor" href="#4-rancher"></a> 4. rancher</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 这个rancher 需要等待 document load 出来。也就是说他渲染界面有点慢。</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> userInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;div.labeled-input.edit input[type=&#x27;text&#x27;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> passwordInput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;div.labeled-input.edit input[type=&#x27;password&#x27;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> loginButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;div.col.span-12.text-center button[type=&#x27;submit&#x27;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> user = <span class="string">&#x27;your name&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> pass = <span class="string">&#x27;your password&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        userInput.<span class="property">value</span> = user;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> event = <span class="variable language_">document</span>.<span class="title function_">createEvent</span>(<span class="string">&#x27;HTMLEvents&#x27;</span>);</span><br><span class="line">        event.<span class="title function_">initEvent</span>(<span class="string">&quot;input&quot;</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        event.<span class="property">eventType</span> = <span class="string">&#x27;message&#x27;</span>;</span><br><span class="line">        <span class="comment">// 调度事件</span></span><br><span class="line">        userInput.<span class="title function_">dispatchEvent</span>(event);</span><br><span class="line"></span><br><span class="line">        passwordInput.<span class="property">value</span>=pass;</span><br><span class="line"></span><br><span class="line">        passwordInput.<span class="title function_">dispatchEvent</span>(event);</span><br><span class="line"></span><br><span class="line">        loginButton.<span class="title function_">click</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5-jenkins"><a class="markdownIt-Anchor" href="#5-jenkins"></a> 5. jenkins</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;input[type=&#x27;text&#x27;]&quot;</span>).<span class="property">value</span>=<span class="string">&quot;your name&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;input[type=&#x27;password&#x27;]&quot;</span>).<span class="property">value</span>=<span class="string">&#x27;your password&#x27;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;input[type=&#x27;checkbox&#x27;]&quot;</span>).<span class="property">checked</span>=<span class="literal">true</span>;</span><br><span class="line"><span class="keyword">var</span> loginButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;button[type=&#x27;submit&#x27;]&quot;</span>);</span><br><span class="line">loginButton.<span class="title function_">click</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="3-总结"><a class="markdownIt-Anchor" href="#3-总结"></a> 3. 总结</h1>
<ol>
<li>有些非常简单，只需要<code>input</code>组件<code>value</code>正确, 点击<code>button</code>就可以发请求，但有些就需要控制组件失焦， 还有一些需要模拟动作。</li>
<li>有些input非常容易获取到，可以通过id属性来找，有些就只能通过input子属性才能获取到。</li>
<li>每个网站的界面做的都大同小异，但是写脚本仍然非常头疼。登录这部分没有标准。</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2023/11/03/clash-for-windows-download/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/03/clash-for-windows-download/" class="post-title-link" itemprop="url">Clash-for-Windows-Download</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-11-03 01:16:02 / Modified: 01:23:41" itemprop="dateCreated datePublished" datetime="2023-11-03T01:16:02+08:00">2023-11-03</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>182</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天听说clash-for-windows这应用的主人删库跑路了。所以这里减少大家盲目search的时间。直接贴一下下载地址：<br />
<span class="exturl" data-url="aHR0cHM6Ly9jbGFzaGZvcndpbmRvd3MubmV0L2ZpbGVzL0NsYXNoLmZvci5XaW5kb3dzLlNldHVwLjAuMjAuMzAuZXhl">download<i class="fa fa-external-link-alt"></i></span></p>
<p>这个现在是不带病毒的，后续是否带病毒，就不知道了。怕带病毒的话，需要自行编译, 源码地址详见：<br />
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoaWxseS9DbGFzaC1mb3ItV2luZG93c19DaGluZXNl">github地址<i class="fa fa-external-link-alt"></i></span></p>
<p>不过这个编译后的是否有后门就不清楚了。大家自行看源码吧。</p>
<p>既然来了，你在等待下载的时间要不要看看我的其他blog呀？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2023/10/08/hexo-markdown-template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/08/hexo-markdown-template/" class="post-title-link" itemprop="url">Hexo Is Not Support Markdown Template, So I Write One!</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-08 16:46:56 / Modified: 20:26:47" itemprop="dateCreated datePublished" datetime="2023-10-08T16:46:56+08:00">2023-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I update Hexo last stable version (6.3.0). And I change node/npm version to v18.18.0/9.8.1.<br />
I found the changes in Hexo is quite big. I found images can not be displayed properly.</p>
<p>Old version image is like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/1.jpg)</span><br><span class="line">**figure 1.1**</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>It can not be rendered properly.Then I changed the format of html like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span></span><br><span class="line"></span><br><span class="line">![1.jpg](https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/1.jpg)</span><br><span class="line"></span><br><span class="line">**figure 1.1**</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Then it worked. I think it is hexo <strong>incompatibility</strong> issue.</p>
<p>Every time I add a centered picture and picture title, I write like the above code. It’s too complicated. If hexo support markdown template,m, I will write like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image_mid &#x27;/image/a.png&#x27;  &#x27;Figure1.1&#x27;  &#x27;1.jpg&#x27; %&#125;</span><br></pre></td></tr></table></figure>
<p>But there is no plugin in Hexo can implement this functionality. And theme <code>_partials</code> and <code>_macro</code> is njk can not used in markdown.</p>
<p>So I write my own plugin <code>image-mid</code>.</p>
<p>In <code>node_modules/hexo/lib/plugins/tag</code>, add new file called <code>image_mid.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> img = <span class="built_in">require</span>(<span class="string">&#x27;./img&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; encodeURL, escapeHTML &#125; = <span class="built_in">require</span>(<span class="string">&#x27;hexo-util&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Asset image tag</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Syntax:</span></span><br><span class="line"><span class="comment"> *   &#123;% image_mid path [figure] [text] %&#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">path</span></span></span><br><span class="line"><span class="comment"> *   1. support post_asset</span></span><br><span class="line"><span class="comment"> *   1. support relative path like /images/a.jpg, will find in &quot;source&quot; folder =&gt; sources/images/a.jpg</span></span><br><span class="line"><span class="comment"> *   1. support http:// and https:// </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">figure</span></span></span><br><span class="line"><span class="comment"> *   Optional parameter, is image title which is below the image.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">text</span></span></span><br><span class="line"><span class="comment"> *   Optional parameter, will be displayed when the image fails to load</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImage</span>(<span class="params">id, path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> image = <span class="title function_">getImageFromAsset</span>(id, path, text, ctx);</span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        image = <span class="title function_">getImageFromRelativePath</span>(path, text, ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        image = <span class="title function_">getImageFromInternalPath</span>(path, text, ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;can not render image tag. By path:&#x27;</span>, path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromAsset</span>(<span class="params">id, path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">PostAsset</span> = ctx.<span class="title function_">model</span>(<span class="string">&#x27;PostAsset&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> asset = <span class="title class_">PostAsset</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">post</span>: id, <span class="attr">slug</span>: path&#125;);</span><br><span class="line">    <span class="keyword">if</span> (asset) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(<span class="title function_">resolve</span>(<span class="string">&#x27;/&#x27;</span>, asset.<span class="property">path</span>)), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">urlConcat</span>(<span class="params">base, path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (base.<span class="title function_">endsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">startsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> base.<span class="title function_">substring</span>(<span class="number">0</span>, base.<span class="property">length</span>-<span class="number">1</span>) + path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> base + path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">startsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> base + path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base + <span class="string">&#x27;/&#x27;</span> + path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeLastSlash</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">endsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> path.<span class="title function_">substring</span>(<span class="number">0</span>, path.<span class="property">length</span>-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromRelativePath</span>(<span class="params">path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> base_path = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> image_path = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>.<span class="property">cdn_url_prefix</span>) &#123;</span><br><span class="line">            base_path = <span class="title function_">removeLastSlash</span>(ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>.<span class="property">cdn_url_prefix</span>) +<span class="string">&#x27;@master/&#x27;</span>;</span><br><span class="line">            image_path = <span class="title function_">urlConcat</span>(base_path, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!image_path) &#123;</span><br><span class="line">        image_path = <span class="title function_">resolve</span>(base_path, path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(image_path), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromInternalPath</span>(<span class="params">path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(<span class="string">&#x27;http://&#x27;</span>) &gt; <span class="number">0</span> || path.<span class="title function_">indexOf</span>(<span class="string">&#x27;https://&#x27;</span>) &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(path), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> =  <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">assetImgMidTag</span>(<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = args.<span class="property">length</span>;</span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;image path is not set. args:&#x27;</span>, args, <span class="string">&#x27;file:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">full_source</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> path = args[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">var</span> figure = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> text = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        figure = escapeHTML(args[<span class="number">1</span>]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> === <span class="number">3</span>) &#123;</span><br><span class="line">        text = escapeHTML(args[<span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// Find image html tag</span></span><br><span class="line">      <span class="keyword">var</span> image = <span class="title function_">getImage</span>(<span class="variable language_">this</span>.<span class="property">_id</span>, path, text, ctx);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`&lt;div align=center&gt;&lt;br/&gt;<span class="subst">$&#123;image&#125;</span>&lt;br/&gt;&lt;strong&gt;<span class="subst">$&#123;figure&#125;</span>&lt;/strong&gt;&lt;br/&gt;&lt;/div&gt;`</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>In file <code>node_modules/hexo/lib/plugins/tag/index.js</code>, add the following code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;image_mid&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;./image_mid&#x27;</span>)(ctx));</span><br><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;img_mid&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;./image_mid&#x27;</span>)(ctx));</span><br></pre></td></tr></table></figure>
<p>Then in your markdown file. Write like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image_mid &#x27;/image/a.png&#x27;  &#x27;Figure1.1&#x27;  &#x27;1.jpg&#x27; %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>It will generate the html like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div align=&quot;center&quot;&gt;&lt;br&gt;&lt;img src=&quot;/image/a.png&quot; class=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;&lt;/strong&gt;&lt;br&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>If you install <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JlbnppYmVpL2hleG8tY2RuLWpzZGVsaXZyL2Jsb2IvbWFzdGVyL3JlYWRtZS1jbi5tZA==">jsdelivr_cdn plugin<i class="fa fa-external-link-alt"></i></span>. And you write your _config.yml in Hexo root like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jsdelivr_cdn:</span></span><br><span class="line">  <span class="attr">use_cdn:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">cdn_url_prefix:</span> <span class="string">write</span> <span class="string">your_cdn_root_path</span> <span class="string">like</span> <span class="string">&#x27;https://cdn.jsdelivr.net/gh/&lt;username for github&gt;/&lt;assets repo name&gt;/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>The html will be generated like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/&lt;username for github&gt;/&lt;assets repo name&gt;@master/image/a.png&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The effect is as follows:</p>
<div align=center><br/><img src="https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/2.png" class="" alt="2.png"><br/><strong>在4旁边生成4</strong><br/></div>
<p>The image tag is generated as CDN path.</p>
<p>This <code>image_mid</code> is support:</p>
<ul>
<li>post asset path</li>
<li>relative path</li>
<li>http/https path</li>
<li>And post asset path and relative path can be generated as CDN path.</li>
</ul>
<p>Use it and write your comments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/18/Architect-week4-hashmap/hashmap-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/18/Architect-week4-hashmap/hashmap-design/" class="post-title-link" itemprop="url">HashMap Design (1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-18 14:39:57" itemprop="dateCreated datePublished" datetime="2017-10-18T14:39:57+08:00">2017-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 11:29:21" itemprop="dateModified" datetime="2023-10-06T11:29:21+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="before"><a class="markdownIt-Anchor" href="#before"></a> Before</h1>
<p>Thanks for inviting me to answer the question: “Design a HashMap”. The description of the question is here:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Design methods like *put, get, containsKey, </span><br><span class="line">containsValue, remove* etc and answer the *complexity*.</span><br></pre></td></tr></table></figure>
<p>All of us knows “HashMap”. It is not “HashTable” see <strong>Figure 1.1</strong>. It means there does not exist a big array to store all of data.</p>
<div align=center>
<p><img src="/images/Architect-week4-hashmap/hashtable.png" alt="hashtable.png" /></p>
<p><strong>Figure 1.1</strong> hashtable</p>
</div>
<p>Compute hash(key) and put the value into array[hash(key)]. If array[hash(key)] is stored by other data, you <strong>must not</strong> put it into another slot. See <strong>Figure 1.2</strong>. You should create space for storing your new data.</p>
<div align=center>
<p><img src="/images/Architect-week4-hashmap/hashmap.png" alt="hashmap.png" /></p>
<p><strong>Figure 1.2</strong> hashmap</p>
</div>
<h1 id="complexity"><a class="markdownIt-Anchor" href="#complexity"></a> Complexity</h1>
<p>How to design it? We should have a hash function. And create an array/list called <strong>slot/bucket</strong> to store pointers/references which point to real data. Simple? But we should not implement the code immediately. Consider the functions and <strong>complexity</strong> first.</p>
<p>I assume complexity of hash function is <strong>O(hash)</strong>. And the complexity of Operator is <strong>T(n)</strong>. It means doing the operator n times. We look at <strong>put</strong> function. O(hash) often is done in constant time as O(1). But in special case like hash(Big Integer or Long String), the complexity of hash function will be O(x), x is related with the length of Big Integer or Long String. Em…Those are extreme cases, and we don’t care! So we just consider O(hash) as O(1).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">put(key,value)</span><br><span class="line"></span><br><span class="line">T(n) = O(hash) + O(create one space) + O(insert into new space) + T(n-1)</span><br><span class="line">O(create one space) is O(1) </span><br><span class="line">so</span><br><span class="line">T(n) = O(1) + O(insert into new space) + T(n-1)</span><br></pre></td></tr></table></figure>
<p>So what’s the O(insert into new space) ? I don’t know. If it is a single linklist, it will be O(1). We can insert the data into the head of linklist. But if we use other data structures? I will not discuss here. I should list other operaters first.</p>
<p>We assume our hash function is extreme good. The function will decentralize keys homogeneously. According to <strong>pigeon hole principle</strong>, the length of every space is no more than (N/m + 1). <strong>N</strong> is the total number of your data. <strong>m</strong> is the number of slots.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">get(key)</span><br><span class="line"></span><br><span class="line">T(n) = O(hash) + O(look up key from space) + O(return value) + T(n-1)</span><br><span class="line">If key is bind with value, so you find the key, and you also find the value.</span><br><span class="line">So complexity is no more than</span><br><span class="line">T(n) &lt;= O(hash) + O(N/m + 1) +O(1) + T(n-1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if m &gt;&gt; n (m is much bigger than n), then</span><br><span class="line">T(n) &lt;= O(1)+O(1) + T(n-1) = O(1) + T(n-1)</span><br><span class="line"></span><br><span class="line">if n &gt;&gt; m, then</span><br><span class="line">T(n) &lt;= O(1) + O(N) + T(n-1) = O(N) + T(n-1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>and containsKey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containsKey(key)</span><br><span class="line">T(n) = O(hash) + O(look up key from space) + T(n-1)</span><br></pre></td></tr></table></figure>
<p>Emm…The complexity of containsKey is similar with that of get(key). <em>contain(key)</em> is equal with <em>get(key)</em> ? Maybe.<br />
and next is <em>containsValue</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">containsValue(value)</span><br><span class="line"></span><br><span class="line">T(n) = O(find value in all space) + T(n-1) </span><br></pre></td></tr></table></figure>
<p>In the simple hashmap, there dose not exist value -&gt; key mappings. so the complexity is O(n). We should iterator all values to find the target one.</p>
<p>And next is remove</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">remove(key)</span><br><span class="line"></span><br><span class="line">T(n)  = O(hash) + O(look up key from space) + O(remove key-value) + T(n-1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>If in put(key,value), we use single linklist and insert key-value into head every time. We find the key-value is O(N/m +1) and remove it is O(1). So</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">remove(key)</span><br><span class="line"></span><br><span class="line">T(n) = O(N/m + 1) + T(n-1)</span><br></pre></td></tr></table></figure>
<h1 id="optimize"><a class="markdownIt-Anchor" href="#optimize"></a> Optimize?</h1>
<p>Can we use other data structures to optimize some operation? Yes. But we should consider other factors. like <strong>More complex, more bugs.</strong> and <strong>Effect of optimizing operation</strong>. For example, we consider the operation <strong>containsValue(value)</strong> is bad performance O(n). We can use another kind of hashmap structure to store value -&gt; key mapping. So if we call containsValue(value), we will first call getKey(value) to get key, and then call get(key) to find the value. It sounds good! But how often we will call containsValue(value)? Maybe in every 1000 operations, only 1 operation is containsValue(value) and 999 are <em>containsKey/put/get/remove</em>. There is a little better effect <strong>vs</strong> more complex code. Which do you choose? And if you don’t optimize containsValue, will user think your application is too slow to use?</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87/" class="post-title-link" itemprop="url">Lambda表达式与图灵完备</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-12 21:34:25" itemprop="dateCreated datePublished" datetime="2017-10-12T21:34:25+08:00">2017-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-05 23:27:54" itemprop="dateModified" datetime="2023-10-05T23:27:54+08:00">2023-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="引子"><a class="markdownIt-Anchor" href="#引子"></a> 引子</h1>
<p>这篇还是用中文写吧。我基本上没有看到中文的推导过程。当然英文的也各种缺失推导过程。有空的话再用英文写一篇（我肯定没有空）。</p>
<p>首先是lambda表达式。用过Python, Java, JS的，都应该知道。否则意味着你肯定没有好好学。</p>
<p>我是从国外的视频中看到lambda表达式和图灵机等价这一观点的。然后人家就进行了简单的推导。然而我根本就看不懂。我很怀疑我的英语水平，于是又仔细看了几遍视频，仍然不懂。我觉得我需要研究一下，因为视频中的很多推导都明白了。但是就有一步推导，讲解者说了这过程比较复杂，然后就带过了。我非常想知道这推导过程怎么来的。所以搜索了许多资料，加上自己的思考，写了下面的文字。</p>
<h1 id="图灵完备"><a class="markdownIt-Anchor" href="#图灵完备"></a> 图灵完备</h1>
<p>图灵完备是个什么意思？通俗的意思就是能实现正整数加减法，if判断跳转，while循环，以及可以构造简单数据结构的都称为图灵完备。图灵完备的语言无法处理停机问题。具备图灵完备的假象机器就是图灵机。你认为正整数加减法，if判断跳转，while循环很简单，所以你这个人也是图灵机的一种。</p>
<p>所有编程语言都会将图灵完备作为最基础的目标。你看比特币智能合约这么火，它也说自己是图灵完备的。这样看来图灵完备是检测这门编程语言是否能通用的前提。当然Java、Python、JS等等都是图灵完备的。</p>
<h1 id="lambda表达式"><a class="markdownIt-Anchor" href="#lambda表达式"></a> lambda表达式</h1>
<p>在推导之前先看看什么是lambda表达式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">f</span>(x) -&gt; x</span><br><span class="line"><span class="title function_">f</span>(x,y) -&gt; x</span><br></pre></td></tr></table></figure>
<p>我认为以上都是lambda表达式。其中f,x都是变量，不光可以代表值还可以代表函数。f(x)代表一次f对x的调用。<strong>-&gt;</strong> 是说最终得到x, 或者结果为x.</p>
<h1 id="lambda表达式图灵完备推导"><a class="markdownIt-Anchor" href="#lambda表达式图灵完备推导"></a> lambda表达式图灵完备推导</h1>
<p>下面开始推导，首先的前提条件是赋值和等价这两个操作是最初存在的。为什么要提这个事情呢？因为不提这个事情就无法进行if的判断，也没有办法得到结果。其实图灵机的定义中其实也暗含了赋值和等价判断这两个基础操作。所有人都认为理所当然，只有我特意将这两个操作提出来。</p>
<p>推导之前我们必须有的基础操作</p>
<ul>
<li>赋值</li>
<li>判断等价</li>
<li>调用，使用**()<strong>表示，也可以使用</strong>.**表示</li>
</ul>
<p>另外我们还应该清楚一件事，就是单参lambda完全等价于多参lambda表达式。在最初的1920+年Church这伟大的人物提出来lambda的时候就是使用的单参。但是我们为了推导方便，我故意使用多参。</p>
<p>问题: 多参为什么等价于单参lambda?</p>
<p>答:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">f(x,y) -&gt; z</span><br><span class="line">t -&gt; (x,y) 这里的括号无二义的时候可以去掉，就是 t -&gt; x,y</span><br><span class="line"></span><br><span class="line">所以 f(t) -&gt; z</span><br><span class="line">证毕</span><br></pre></td></tr></table></figure>
<p>下面开始真正的推导：</p>
<p>首先定义True与False</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">False: x -&gt; x  , 这样写你是不是更明白? (f,x) -&gt; x</span><br><span class="line">True: f,x -&gt; f  这样写你是不是更明白?  (f,x) -&gt; f</span><br></pre></td></tr></table></figure>
<p>然后就可以定义IF判断了。你看看False的定义是不是就是<code>False ? f : x</code>. True的定义是不是<code>True ? f : x</code>.所以False返回了x,而True返回f.我们将IF定义为多元组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IF(False,f,x) -&gt; x</span><br><span class="line">IF(True, f,x) -&gt; f</span><br><span class="line">同时认为</span><br><span class="line">Fst(f,x) -&gt; f 等同于IF(True,f,x)</span><br><span class="line">Snd(f,x) -&gt; x 等同于IF(False,f,x)</span><br><span class="line">这其实就是投影操作。</span><br></pre></td></tr></table></figure>
<p>下面我们再来定义正整数。False在我们计算机界经常被认为是0.所以我们0的定义就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: f,x -&gt; x</span><br></pre></td></tr></table></figure>
<p>正整数1的定义，我们认为调用了一次f,即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1: f,x -&gt; f(x)</span><br></pre></td></tr></table></figure>
<p>下面正整数2，3…，n的定义就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2: f,x -&gt; f(f(x))</span><br><span class="line">3: f,x -&gt; f(f(f(x)))</span><br><span class="line">...</span><br><span class="line">n: f,x -&gt; f(f(...f(x)...)) 这里应有有n个f调用</span><br></pre></td></tr></table></figure>
<p>我们下面为了更加方便我们这样简写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2: f,x -&gt; 2.f(x)</span><br><span class="line">3: f,x -&gt; 3.f(x)</span><br><span class="line">...</span><br><span class="line">n: f,x -&gt; n.f(x)</span><br></pre></td></tr></table></figure>
<p>我们下面来定义加法操作。例如n + m. 这个问题不好想，所以先想特例。例如5 = 2 + 3, 那么怎么得到5呢，就是5次函数调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5: f,x -&gt; f(f(f(f(f(x))))) == f(f(f(2.f(x)))) == 3.f(m) == 3.f(2.f(x))  其中2.f(x) 替换成m，然后再替换回来。</span><br><span class="line">替换一下</span><br><span class="line">n+m: f,x -&gt; n.f(m.f(x))</span><br></pre></td></tr></table></figure>
<p>定义下乘法操作.例如n*m. 同样先想特例： 6 = 3 * 2. 怎么得到6呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6: f,x -&gt; f(f(f(f(f(f(x)))))) == 2.f(2.f(2.f(x))) == 3.2.f(x)  其中2.f(x)替换为z所以就变成了3.z(x) 再替换回来就是3.2.f(x)</span><br></pre></td></tr></table></figure>
<p>下面是定义n++操作，这个在数学上叫做Successor,所以我叫这个lambda为Succ. 其实从n到n+1是很简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Succ: n,f,x -&gt; f(n.f(x))  就是多调一次f就行了</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面是定义n–操作，这个在数学上叫做Predecessor. 这个是最复杂的。我看视频就是没看懂这里。问题是怎么从n变成n-1。我知道n-1怎么变成n。那有没有方法将n-1带入公式，最后再同时消除呢？就这么干！当年Church可是苦想n天。我辈比较幸运，直接知道人家的想法了。看这篇文章的你们就更加幸运，因为我把所有被省略的推理过程也写出来了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">先定义： PSucc(n) -&gt; (Snd n,Succ(Snd n))</span><br><span class="line">那么PSucc((0,0)) -&gt; (0,1)</span><br><span class="line">那么我们对PSucc(0)做n次操作就是</span><br><span class="line">n.PSucc((0,0)) = PSucc(PSucc(...PSucc((0,1))...)) 记住这里只有n-1个PSucc调用，因为其中一个PSucc((0,0))已经变成了(0,1)了</span><br><span class="line">               = (n-1, n)</span><br><span class="line"></span><br><span class="line">那我们定义</span><br><span class="line">Pred(n) -&gt; Fst n.PSucc((0,0)) = n-1</span><br><span class="line">Pred就是Predecessor</span><br></pre></td></tr></table></figure>
<p>现在好办了，只要有了加减法，所有的一切操作就都好办了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">n-m的减法就是执行n--操作m次。</span><br><span class="line">SUB(n,m) -&gt; m.Pred(n)</span><br></pre></td></tr></table></figure>
<p>下面再定义一些AND,OR,NOT就非常简单了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AND(a,b) -&gt; IF(a,b,False) 这个意思就是如果a是真的，那就看b是不是真的。否则，那一定返回False.</span><br><span class="line">OR(a,b) -&gt; IF(a,True,b) </span><br><span class="line">NOT(a) -&gt; IF(a,False,True)</span><br></pre></td></tr></table></figure>
<p>下面再定义while循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHILE(n,f) -&gt; n.f</span><br></pre></td></tr></table></figure>
<p>再来定义点简单的数据结构，例如链表, 这里还是学习了一下Lisp</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>)</span><br><span class="line">&gt; x</span><br><span class="line">(<span class="number">1</span> . <span class="number">2</span> )</span><br><span class="line">这创建了一个头是<span class="number">1</span>，尾是<span class="number">2</span>的cons对象。</span><br><span class="line">对cons的操作有两个，car及cdr，分别是读取cons的头和尾元素：</span><br><span class="line">&gt; (<span class="name">car</span> (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; (<span class="name">cdr</span> (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>cons代表的是构建一个链表。 car代表是前一个节点，cdr代表的是后一个节点。那么我们用lambda表达式也写一个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">构造链表cons: cons(a,b) -&gt; (a,b)</span><br><span class="line">获取前一个节点car: car(a,b) -&gt; a</span><br><span class="line">获取后一个节点cdr: cdr(a,b) -&gt; b</span><br></pre></td></tr></table></figure>
<p>我们将0判断、False判断、null判断这三种操作认为是等价的。文章开始也说了，等价判断是先决条件。所以0判断一定是预先存在的。所以lambda表达式图灵完备了。</p>
<p>再说一点，图灵完备，意味着无法停机。停机证明不是本文的重点，不再证明。(对对对，就是笔者不会证明。你们随便吐槽)</p>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>看了这篇文章你能学习到什么？你能证明1+2 == 3 ？还是会写链表了？lambda证明到底有什么用？根本就没有编程来的实在！你说的太对了。我也这样认为。那这篇文章到底有什么用？</p>
<pre><code>就是为了装逼呀!!!
</code></pre>
<p>你看blockchain智能合约这么火，最后还不忘加上<code>图灵完备</code>字样。为啥？为了装逼呀~~~学计算机的这么多人，懂得图灵完备没有几个，懂得怎么证明图灵完备估计也没有几个。以后你们大可以吹嘘自己知道如何证明图灵完备。</p>
<p>看到一条微博，说：<strong>“太难了，我大脑停机了。”</strong> 就回复：“你竟然不是图灵完备的!!”</p>
<p>以后有谁再说**“我无法思考了”**,你们就接话：“你竟然不是图灵完备的!!”</p>
<p>对，以后谁在你们面前装逼说自己会图灵完备的证明，你们就接话：“我也会!!”</p>
<p><strong>这才是这篇文章的正确打开方式。</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/07/jdk9/Java9-modular-feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/07/jdk9/Java9-modular-feature/" class="post-title-link" itemprop="url">Java9:modular Feature</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-07 10:04:15" itemprop="dateCreated datePublished" datetime="2017-10-07T10:04:15+08:00">2017-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 12:12:55" itemprop="dateModified" datetime="2023-10-06T12:12:55+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="起源"><a class="markdownIt-Anchor" href="#起源"></a> 起源</h1>
<p>这次写写JAVA9的modular，俗称模块化。这个应该是Java9的最出彩的地方。之前Java的那个项目叫做Jigsaw。 为什么会有这个项目呢？原因在于之前Java使用package作为管理的。大家为了图省事，里面写的class都是public class。 也就是说包外都可用。大家都使用各种包管理工具ivy, maven, gradle啥的，A依赖C的1.0版本, B依赖于C的2.0版本。然后A,B又被自己的工程所依赖。C的1.0版本和2.0版本中有相同的类，不同的函数定义。见下图：</p>
<div align=center>
<p><img src="/images/jdk9/modular/modular_jar_hell.png" alt="jarhell.png" /></p>
<p><strong>图 1</strong> 运行时依赖不同版本的类</p>
</div>
<p>这就会导致JVM运行时不知道该用哪个类，这就是jar hell问题。不过jar hell还有许多种,这个只是比较常见的一种。</p>
<p>之前jdk自身的package也有许多，写着写着自己都搞不明白到底谁依赖谁了。然后大家就都需要依赖整个jdk的jar。但现在不一样了，只需要依赖一部分模块就行了。module是package的集合。而一个module可以依赖其他的module, 例如所有的module都依赖于java.base这个基础的module。</p>
<h1 id="使用ideintellij"><a class="markdownIt-Anchor" href="#使用ideintellij"></a> 使用IDE，Intellij</h1>
<p>说了这么多，不会用还是白搭。首先我们先用Intellij搭一个java9的工程。目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">    |</span><br><span class="line">    module name</span><br><span class="line">        |</span><br><span class="line">        src</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">			|</span><br><span class="line">			module-info.java</span><br><span class="line">    |</span><br><span class="line">    module name</span><br><span class="line">        |</span><br><span class="line">        src</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">			|</span><br><span class="line">			module-info.java</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里有一个module-info.java。是写什么呢？首先我们将第一个module name写为one, 第二个module写为two. <span class="exturl" data-url="aHR0cDovL3huLS1wYWNrYWdlY2hpbGx5Yy00NjZ2bXUyMDgzYTg2dmQuaW5mbw==">第一个package是chillyc.info<i class="fa fa-external-link-alt"></i></span>。第二个package name是info.chillyc.我们写一个最简单的Hello World代码，在代码里chillyc.info.Hello依赖于info.chillyc.World</p>
<p>Hello.java的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> chillyc.info;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> info.chillyc.World.WORLD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;chillyc.info.Hello&quot;</span> + WORLD);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>World.java的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> info.chillyc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WORLD</span> <span class="operator">=</span> <span class="string">&quot;WORLD&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>one的module-info.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> one &#123;</span><br><span class="line">    <span class="keyword">requires</span> two;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>two的module-info.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> two &#123;</span><br><span class="line">    <span class="keyword">exports</span> info.chillyc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呃，上面这些写成多个package，也不需要写module-info.java, 不是更省事吗？是是是，的确更省事，这些是为了整个java的生态环境。你一个人爽不叫爽，大家一起爽才行。</p>
<p>顺便一提，在IDE中Project上右键出来New…可以new出来新的module(自动带上了module-info.java)。 这个使用起来更加方便。我记得很久以前其实有package-info.java这个东西的。但是因为只是用来做文档声明的，大家嫌麻烦，都弃之不用了。我并不担心大家不用module-info.java. 因为这个东西还可以严格限制模块外可以调用哪些类。而且必须写模块依赖才行。所以如果你使用了module，那未来你一定有再次用到module的时候. 另外使用了module之后，你打成的最终jar应该更小巧。</p>
<p>仔细的研究一下module-info.java文件，里面有requires和exports。requires是依赖，exports是导出。这点倒是和JS很像。这两句任何一句缺失，你的程序编译时都会报错。错误类似：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">只注释掉exports info.chillyc; 报错：</span><br><span class="line">The module &#x27;two&#x27; does not export the package &#x27;info.chillyc&#x27; to module &#x27;one&#x27;</span><br><span class="line"></span><br><span class="line">只注释掉require two; 报错：</span><br><span class="line">The module &#x27;one&#x27; does not have the module &#x27;two&#x27; in requirements</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>讲完了。你会用了吗？是不是很简单？…的确很简单。但是我觉得这依旧没有什么用。别人使用我的类的时候，如果我没有在module-info中exports出来，那他们要么重新写一个；要么让我改一下代码。</p>
<p>但是module的确让我们的工程代码更加清晰。不过怕就怕你把整个工程的package全部都exports出来，那这东西就没有什么用了。很多时候，我们封装好一个component,只希望暴露出少量的几个类。但是因为测试或者内部调用的方便，一般都会将class定义为public的。那这个时候使用module就可以很好的解决这个问题。</p>
<h1 id="更实用的"><a class="markdownIt-Anchor" href="#更实用的"></a> 更实用的</h1>
<p>对了，写点更加实用的。我们希望将各个module打成jar包，以后就可以单独使用某些module。这部分不能使用Intellij的IDE，因为它还没有支持。首先将Project的目录树变为如下的模样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">    |</span><br><span class="line">    src</span><br><span class="line">        |</span><br><span class="line">        module name</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">            |</span><br><span class="line">            module-info.java</span><br><span class="line">    	|</span><br><span class="line">    	module name</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">            |</span><br><span class="line">            module-info.java</span><br></pre></td></tr></table></figure>
<p>然后开始敲命令了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">首先确定你的javac, java, jlink什么的是不是java9的版本。</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> mods</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javac -d mods --module-source-path src $(find src -name <span class="string">&quot;*.java&quot;</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行完之后就可以看到mods里面存放了编译好的class文件。继续执行打包命令,注意jar是jdk9里的才行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> mlib</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jar --create --file=mlib/two@1.0.jar --module-version=1.0 -C modt/two .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jar --create --file=mlib/one@1.0.jar --module-version=1.0 --main-class=chillyc.info.Hello -C modt/one .</span></span><br></pre></td></tr></table></figure>
<p>执行jar文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -p mlib -m one</span></span><br></pre></td></tr></table></figure>
<p>这个问题在于我每次执行就需要带上一个mlib的文件。这个文件很容易被被人直接拿去了反编译了。现在有更好的解决方案了：编译成一个image.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jlink --module-path jmods:mlib --add-modules one --output oneapp</span></span><br><span class="line">但是实际上上面这个要看你的Path是否正确，如果写成绝对路径应该像下面这样：</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home/bin/jlink --module-path /Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home/jmods:mlib --add-modules one --output oneapp</span></span><br></pre></td></tr></table></figure>
<p>这样就有一个oneapp目录。这个目录里面你再也找不到你的one@1.0.jar这个东西了。如果你要执行，敲下面的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java -m one</span></span><br></pre></td></tr></table></figure>
<p>通过如下命令可以看一下bin/java这里的modules</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java --list-modules</span></span><br><span class="line">结果:</span><br><span class="line">java.base@9</span><br><span class="line">one@1.0</span><br><span class="line">two@1.0</span><br></pre></td></tr></table></figure>
<p>java.base其实就是java9的默认模块，所有模块都会依赖java.base。上面打包成oneapp中的jmods就是java的基础模块。我觉得这个东西还是比较有用的。另外bin/java中里面暗含了这些模块，所以也可以直接执行刚才的jar。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java -jar [你的相对路径]/one@1.0.jar</span> </span><br></pre></td></tr></table></figure>
<h1 id="结束"><a class="markdownIt-Anchor" href="#结束"></a> 结束</h1>
<p>嗯。modular…其实也没有真正解决Jar Hell的问题。不过如果出现冲突，那么java9的提示会比较友好。另外没有一堆的classpath,这样ps命令时不会眼痛。编译成模块image这点对防止反编译还是有点用处的。但是这个image不能直接放到一个没有Java的环境中使用。那就是说，编译好的image, 仍然达不到开箱即用的效果。希望image这东西在Java10可以开箱即用，不再依赖OS和Jdk。(虽然官方文档说，编译出来的image文件可以放在没有JVM环境的地方使用。但是我Mac下编译出来的，为什不能在linux上使用呢？一点都不跨平台。这至少说明image依赖于OS…)</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmpldGJyYWlucy5jb20vaWRlYS8yMDE3LzAzL3N1cHBvcnQtZm9yLWphdmEtOS1tb2R1bGVzLWluLWludGVsbGlqLWlkZWEtMjAxNy0xLw==">Intellij的官方教程<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvcHJvamVjdHMvamlnc2F3L3F1aWNrLXN0YXJ0">Jigsaw quick start<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvcHJvamVjdHMvamlnc2F3L3RhbGtzL2ludHJvLW1vZHVsYXItZGV2LWoxLTIwMTYucGRm">modular开发手册 2016年版<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvamVwcy8yMjA=">modular images<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/29/jdk9/Java9-Flow-feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/29/jdk9/Java9-Flow-feature/" class="post-title-link" itemprop="url">Java9:Flow Feature</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-29 21:00:04" itemprop="dateCreated datePublished" datetime="2017-09-29T21:00:04+08:00">2017-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 12:12:17" itemprop="dateModified" datetime="2023-10-06T12:12:17+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>LP强烈要求用中文写。嗯，好吧，用中文写吧。</p>
<h1 id="flow-简介"><a class="markdownIt-Anchor" href="#flow-简介"></a> Flow 简介</h1>
<p>今天试用了一下jdk9, 最主要关注Flow这个新增的功能。结果发现，这个Flow其实是一个final class，构造函数还是private,没有任何正常方法将其实例化。这个是新功能？我抱着学习的心态看了一下java doc. 发现主要是几个interface. Interface…都是接口，到底有没有实现？</p>
<p>然后不知道怎么查到了reactive-stream, 其实Java的JVM Flow就是按照reactive-stream的API规范写的。</p>
<p>reactive-stream是什么？就是反向压力流（back pressure），其实你称其为反向控制流也行。官方说法是：一个异步非阻塞反向控制流处理的标准。嗯，相当拗口。</p>
<p>什么是反向控制？这里还是抄袭一下别人的图吧。图的出处在<span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkub3JhY2xlLmNvbS9kb2NzL0RPQy0xMDA2NzM4">这里<i class="fa fa-external-link-alt"></i></span>。</p>
<div align=center>
<p><img src="/images/jdk9/flow/flow1.png" alt="flow1.png" /></p>
<p><strong>图 1</strong> 正常流处理</p>
</div>
<p>下面是反向的流处理：</p>
<div align=center>
<p><img src="/images/jdk9/flow/flow2.png" alt="flow2.png" /></p>
<p><strong>图 2</strong> 反向流处理</p>
</div>
<p>看到了吧，反向的流处理<strong>图 2</strong>是Subcriber需要多少数据，就给多少数据。不要不给。正常的流处理<strong>图 1</strong>是管你要多少，我有多少给你多少。图1的问题就导致数据在管道里积压，或者在Subscriber里面积压。所以正常的流一般处理时要么数据就丢弃掉了，要么JVM就OOM了。所以反向的流好棒好棒的!</p>
<p>嗯，感觉也不是，因为有可能反向的流在Publisher的地方挤压了…其实你的程序性能不行，处理不完，积压不可避免。所以这反向的鬼东西有什么用呢？除非你的Publisher是根据你处理的数据的性能来生产数据。这听起来很酷，这很像当年教务系统的排队选课，以及魔兽世界中的等等等…其实就是处理性能不行，只能反推给最初的生产者<strong>人</strong>。当然还有一种使用场景是消除峰值，当大量数据瞬间涌入时会造成整个系统崩溃。但如果你的系统在限定的时间内慢慢处理这些数据，还是完全没有问题的。这样就增加了系统的稳定性。</p>
<p>Java9其实只是将这个标准写入了JVM中而已。我顺便看了一下Publisher以及Subscriber的实现类，很多都是incubate包的(即实验中)。只有一个类是特别的存在：SubmissionPublisher。</p>
<h1 id="flow-使用"><a class="markdownIt-Anchor" href="#flow-使用"></a> Flow 使用</h1>
<p>这个Flow使用起来，真的好麻烦。最初我知道Flow这个Feature的时候，我以为只需要将数据push到流里，然后有一个default的Consumer获取到数据。这个Flow自己给我搞定了反向控制。No,No,No. Java9啥都没有做。啥都需要你自己写。如果没有SubmissionPublisher，那你需要根据那几个Interface自己去实现。这是什么鬼，我是不是可以宣布我写了一个可以实现全世界所有功能的框架呢？我的框架就是下面这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Everything</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doEverything</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是非常棒?! Java9宣称的Flow就和我上面宣称的没有啥区别,只是它的接口更多而已。好了，它还是给出了一个SubmissionPublisher。 我就先原谅它吧… 可是怎么使用呢？我再次抄袭了<span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkub3JhY2xlLmNvbS9kb2NzL0RPQy0xMDA2NzM4">这边的blog的代码<i class="fa fa-external-link-alt"></i></span>。我也不知道为啥变得这么厚颜无耻，不知脸红的抄袭，可能是跟腾讯阿里学的吧。</p>
<h2 id="publisher和subscriber简单示例"><a class="markdownIt-Anchor" href="#publisher和subscriber简单示例"></a> Publisher和Subscriber简单示例</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySubscriber</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Flow</span>.Subscriber&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">            subscription.request(<span class="number">1</span>); <span class="comment">//这里要使用Long.MAX_VALUE就会被认为获取无穷的数据。</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T item)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Got : &quot;</span> + item);</span><br><span class="line">            subscription.request(<span class="number">1</span>); <span class="comment">//这里也可以使用Long.MAX_VALUE</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Register Subscriber</span></span><br><span class="line">        MySubscriber&lt;String&gt; subscriber = <span class="keyword">new</span> <span class="title class_">MySubscriber</span>&lt;&gt;();</span><br><span class="line">        publisher.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Publish items</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Publishing Items...&quot;</span>);</span><br><span class="line">        String[] items = &#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;x&quot;</span>&#125;;</span><br><span class="line">        Arrays.asList(items).stream().forEach(i -&gt; publisher.submit(i));</span><br><span class="line">        publisher.close();</span><br><span class="line">        Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要的函数是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反向控制获取数据个数。</span></span><br><span class="line"><span class="comment">//代码里两处request(1)都不能丢，否则数据无法正常获取</span></span><br><span class="line">subscription.request(<span class="number">1</span>)</span><br><span class="line"><span class="comment">// 发布数据，相当于数据输入</span></span><br><span class="line">publisher.submit(i)</span><br><span class="line"><span class="comment">// 关闭publisher，没有该函数则Subscriber.onComplete()不会被调用。</span></span><br><span class="line">publisher.close()  </span><br><span class="line"><span class="comment">// 因为是异步的流处理</span></span><br><span class="line"><span class="comment">// 所以没能提供同步的接口，可以自己在Subcriber中加入同步策略</span></span><br><span class="line"><span class="comment">// 我这里简化了,如果你去掉这段代码，那你可能什么都看不到</span></span><br><span class="line">Thread.sleep(<span class="number">20000</span>);</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Publishing Items...</span><br><span class="line">Got : 1</span><br><span class="line">Got : x</span><br><span class="line">Got : 2</span><br><span class="line">Got : x</span><br><span class="line">Got : 3</span><br><span class="line">Got : x</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>
<h2 id="flow的processor接口"><a class="markdownIt-Anchor" href="#flow的processor接口"></a> Flow的Processor接口</h2>
<p>Flow还有一个重要的Processor接口，这个其实就是函数变换。其实一般的函数变换操作都可以在Subscriber中实现，Processor并没有什么卵用。不过如果让我去定义接口，我仍然会给出Processor. 为啥？这样会防止别人来喷我…嗯，其实给出了Processor接口，一样有人来喷，例如我…</p>
<p>看下图就知道我在说什么了。竟然无图可盗了…</p>
<div align=center>
<p><img src="/images/jdk9/flow/withProcessor.png" alt="withProcessor.png" /></p>
<p><strong>图 3</strong> 带有Processor的流</p>
</div>
<div align=center>
<p><img src="/images/jdk9/flow/withoutProcessor.png" alt="withoutProcessor.png" /></p>
<p><strong>图 4</strong> 没有Processor的流</p>
</div>
<p>如果增加另外一个流，就可以完全实现Processor的功能。所以表达流的<strong>最小原语</strong>不应该存在Processor这东西。但是Reactive-Stream说：我的这个就是规范。那好吧，就加一个吧。不过增加Processor的好处在于：你可以只写一个流，里面有很多Processor。而不是写很多流，将Subscriber和Publisher混在一起写。虽然你已经在Processor中将Publisher,Subscriber混在一起写了…嗯…呃…总而言之，你一定要相信规范，Processor存在一定有它的道理。</p>
<p>下面也给一个Process的例子：是过滤用的Processor.(这段代码是我自己写的，在Oracle官方文档中本应存在这段代码，但是他们不小心忘记写了…忘记写了…我看到的官方文档最后由 Bob Rhubart-Oracle 于 2016-9-26 下午2:03修改,版本号为6)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyFilterProcessor</span>&lt;T,K <span class="keyword">extends</span> <span class="title class_">T</span>&gt; <span class="keyword">extends</span> <span class="title class_">SubmissionPublisher</span>&lt;K&gt; <span class="keyword">implements</span> <span class="title class_">Flow</span></span><br><span class="line">            .Processor&lt;T, K&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Function&lt;? <span class="built_in">super</span> T, Boolean&gt; function;</span><br><span class="line">        <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyFilterProcessor</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, Boolean&gt; function)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">            <span class="built_in">this</span>.function = function;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">            subscription.request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T item)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="type">boolean</span>) function.apply(item)) &#123;</span><br><span class="line"></span><br><span class="line">                submit((K)item);</span><br><span class="line">            &#125;</span><br><span class="line">            subscription.request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//Create Publisher</span></span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Create Processor and Subscriber</span></span><br><span class="line">        MyFilterProcessor&lt;String, String&gt; filterProcessor = <span class="keyword">new</span> <span class="title class_">MyFilterProcessor</span>&lt;&gt;(s -&gt; s.equals(<span class="string">&quot;x&quot;</span>));</span><br><span class="line"></span><br><span class="line">        MySubscriber&lt;Integer&gt; subscriber = <span class="keyword">new</span> <span class="title class_">MySubscriber</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Chain Processor and Subscriber</span></span><br><span class="line">        publisher.subscribe(filterProcessor);</span><br><span class="line">        filterProcessor.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Publishing Items...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] items = &#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;x&quot;</span>&#125;;</span><br><span class="line">        Arrays.asList(items).stream().forEach(i -&gt; publisher.submit(i));</span><br><span class="line">        publisher.close();</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Publishing Items...</span><br><span class="line">Got : 1</span><br><span class="line">Got : 2</span><br><span class="line">Got : 3</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>
<p>重要的代码片段是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(<span class="type">boolean</span>) function.apply(item)) &#123;</span><br><span class="line">	submit((K)item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的submit就是数据再发布，相信大家都能看懂，不再叙述。</p>
<h1 id="flow-性能测试"><a class="markdownIt-Anchor" href="#flow-性能测试"></a> Flow 性能测试</h1>
<p>到底这个东西性能怎么样？我是不是随便写一个Flow的实现都比它快？如果它性能差，我按它这个规范写有什么意义？为了好看吗？<br />
好吧。我自己用无锁队列实现了一下。功能就是简单的计数，看看各自的最强性能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">无锁队列执行结果：</span><br><span class="line">class chillyc.info.speed.old.XFlow:27qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:171629qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:7586111qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:8095748qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:7640866qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6845523qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6516655qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6191659qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:5742711qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6657964qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:5720992qps</span><br></pre></td></tr></table></figure>
<p>JVM jdk9 Flow执行结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Concurrent.Flow 测试结果： 设置无穷索取, request(Long.MAX_VALUE)</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:39688qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6798618qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6556238qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6506791qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6545895qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:7129085qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:7005827qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6818252qps</span><br></pre></td></tr></table></figure>
<p>性能对比图：</p>
<div align=center>
<p><img src="/images/jdk9/flow/speed.png" alt="性能对比" /></p>
<p><strong>图 5</strong> 性能对比图</p>
</div>
<p>个人感觉前两次都可以忽略不计，无锁队列的实现中，前两次线程还没有完全启动，数据还没有完全填充。不过从另外一个侧面反映出jdk9 Flow启动效率非常高。我们除去前两次计算一下平均值。看到两者相差不大:无锁队列比jdk9 Flow平均快了17000+qps.</p>
<p>实验和数据量，buffer大小都有关系，变量太多，没有一一实验，并且两者的qps都是六七百万量级，所以我认为两者差别不大。JDK9的Flow实现的挺不错的，竟然能和我顺手写的性能差不多。我心中不由的赞叹一番。</p>
<h1 id="flow-bug"><a class="markdownIt-Anchor" href="#flow-bug"></a> Flow bug</h1>
<p>因为测试了jdk9 Flow的无限索取时的性能。我想再测测每次取一个导致的最差性能（request(1)）。结果就发现了bug.<br />
测试输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:55296qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br></pre></td></tr></table></figure>
<p>从结果上分析，经过一段时间之后，jdk9的Flow就无法处理数据了。这…真的能用吗？</p>
<h1 id="结束语"><a class="markdownIt-Anchor" href="#结束语"></a> 结束语</h1>
<p>本来应该带着虔诚敬畏的心态学习JDK9的…结果变成了吐槽大会了…罪过罪过，实在不该这样…顺便一提，jshell非常好用，tab功能提示很强大，就是我机器性能有点差，感觉很卡顿…</p>
<p>对了，不要以为我只会讨论jdk9…那是因为ReactJS 16发布的比较晚。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/24/Architect-week3-whatsapp/Class-Diagram/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/24/Architect-week3-whatsapp/Class-Diagram/" class="post-title-link" itemprop="url">Class-Diagram-Architect-Week3-Whatsapp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-24 22:18:23" itemprop="dateCreated datePublished" datetime="2017-09-24T22:18:23+08:00">2017-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:42:44" itemprop="dateModified" datetime="2023-10-06T20:42:44+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I will write an article to design Class Diagram. <a href="../../Architect-week3-whatsapp/">In before article, I draw some usecases and component diagrams.</a></p>
<h1 id="4-transform-component-diagram-into-class-diagram"><a class="markdownIt-Anchor" href="#4-transform-component-diagram-into-class-diagram"></a> 4. Transform component diagram into class diagram</h1>
<h2 id="41-mark-noun-as-entity"><a class="markdownIt-Anchor" href="#41-mark-noun-as-entity"></a> 4.1 Mark noun as entity</h2>
<p>I like OOM(Object Oriented Model). Because our world is built by things. And we describe those things as noun, like sky, bird, hand, clothes. In OOD(Object Oriented Design), things are object/class entities. So there is the equation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">things == noun == entities     (4.1.1)</span><br></pre></td></tr></table></figure>
<p>Here, I will describe our system again. <strong>Clients</strong> will send <strong>message</strong> to our “Messager Service”. <strong>User</strong> will chat with someone. User can chat with many people in one <strong>chat room</strong>. <strong>Chatting</strong> is real-time. But if all clients of user are offline, system will send offline <strong>messages</strong> to one of user’s mobile client.</p>
<p>Why mobile client? Because web/pc client are hardly woke up. Emmm…Should we add a constraint? <strong>“User only use one client to login/chat.”</strong> Without this constraint, system should boradcast chat messages?</p>
<p>But here our key point is marking noun. I already marking them as <strong>“BOLD”</strong>. But <strong>client</strong> is not in “Server” rectangle in component diagram. I will draw client class diagram later.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init.png" alt="class-init.png" /></p>
<p><strong>Figure 4.1.1</strong> init classes</p>
</div>
<h2 id="42-add-relationship-between-entities"><a class="markdownIt-Anchor" href="#42-add-relationship-between-entities"></a> 4.2 Add relationship between entities</h2>
<p>In Figure 4.1.1 Chatting class is the most important class. But Chatting means a chat message. So I change it to be “ChatMsg”. In ChatMsg class, there should be who send the message, who will receive it, and what’s the status of the message. Many users will receive the same ChatMsg Object. And one ChatMsg only contain one Message. If one ChatMsg is not exist, can the Message in it be exist? I think there should be strong relationship between Message and ChatMsg. And I call the relationship as “co-exist”. I draw solid diamond line between ChatMsg and Message. Other relationship with ChatMsg is not co-exist, but without User, the ChatMsg is meaningless. So I draw hollow diamond line between User and ChatMsg. Status is addition feature of ChatMsg. Without Status, we can not show chat status to our users. I draw arrow line between them. Now we draw Figure 4.2.1</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init2.png" alt="class-init.png" /></p>
<p><strong>Figure 4.2.1</strong> init classes 2</p>
</div>
<p>Emmm…Does ChatRoom relate with ChatMsg? Yes. We consider users chat with each other in one chat room. When one chat message generated, the system will send it to the users who are in the ChatRoom. So I put Collection<User> into ChatRoom. So here it is:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init3.png" alt="class-init.png" /></p>
<p><strong>Figure 4.2.2</strong> init classes 3</p>
</div>
<h2 id="43-think-twice"><a class="markdownIt-Anchor" href="#43-think-twice"></a> 4.3 Think twice</h2>
<p>Here, another problem should be considered. If we join/leave ChatRoom, the users of ChatRoom will be changed. Can we see ChatMsg even if we leave the ChatRoom?  If the status of ChatMsg is sent, and then someone join the chatroom, should  the ChatMsg be delivered to him? Can new comer see old ChatMsgs?<br />
There are many requirements:</p>
<ol>
<li>new comer can see old chat messages. But someone quit the room, he can not see any chat messages be occurred in the room.</li>
<li>new comer can not see old chat messages. And someone quit the room, he will see nothing chat messages.</li>
<li>new comer can not see old chat messages. But even someone quit the room, he can see chat messages before he left in any time.</li>
</ol>
<p>And there will be corresponding solutions too!</p>
<ol>
<li>Do nothing, the class digram supports the requirements 1.</li>
<li>If ChatRoom is changed, we log it. So ChatRoom should contain version. The solution also supports requirement 1 and 3. But the performance of the system will be lower than 1 or 3.</li>
<li>We store Collection&lt;User&gt; in each ChatMsg Object, and Collection&lt;User&gt; is only the snapshot of ChatRoom. It seems there is no relationship between ChatMsg and ChatRoom. And it will cost more spaces (memory/disk) than 1 or 2.</li>
</ol>
<p>I will choose solution 2. The solution can adapt many requirements, and it stores the relationship between ChatRoom and ChatMsg. And I fill more field of Class Message and User. I call “ChatRoom history” as “ChatRoomSnapshot”. When ChatRoom is changing, the system will generate ChatRoomSnapshot to store old ChatRoom. The id of ChatRoomSnapshot and related ChatRoom must be the same. So the relationship between ChatRoom and ChatRoomSnapshot is weak. I just draw a line between them. In Message, I prefer JSONObject as its content.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init4.png" alt="class-init.png" /></p>
<p><strong>Figure 4.3.1</strong> init classes 4</p>
</div>
<p>All of above are our system “Server” entities. Is it enough? Those entities seem like static or immutable. And in component diagram, there are many components. Which component is related with the class diagram? The answer is none. Figure 4.3.1 only draw basic entities. Those entities will be used in each components. And now, I will draw details of each component, and “give life” to those entities.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/13/Architect-week3-whatsapp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/13/Architect-week3-whatsapp/" class="post-title-link" itemprop="url">Architect:week3-Whatsapp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-13 20:06:17" itemprop="dateCreated datePublished" datetime="2017-09-13T20:06:17+08:00">2017-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:55:07" itemprop="dateModified" datetime="2023-10-06T20:55:07+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="origin"><a class="markdownIt-Anchor" href="#origin"></a> Origin</h1>
<p>I joined leetcode system design group to discuss how to design software. This is week3 topic:</p>
<p><strong>Messenger service like What’s App</strong> with the following functionalities</p>
<ol>
<li>One to One text messaging</li>
<li>Group Chat, Storage</li>
<li>Read/Delivery/Sent status</li>
</ol>
<p>Gist:</p>
<ol>
<li>We are having a conversation between two parties. A -&gt; B. Think of this process. What happens and how do you explain to interviewer</li>
<li>Asynchronous - meaning, “You are on a flight and you receive messages once you land. So those messages were waiting some where!” (Hope you got it). How would you design it</li>
<li>Horizontal scaling, Load Balancer</li>
<li>For Read/Delivery/Sent status -&gt; 3 way handshake protocol can give you an idea.</li>
</ol>
<p>This is a good topic. I will try to design it.</p>
<h1 id="scenario"><a class="markdownIt-Anchor" href="#scenario"></a> Scenario</h1>
<p>First of all, what’s the scenarios? The scenarios will correct my design. The scenario is in which way people use our software. So let’s think scenario first. The scenario should be atomic, and can not split into two or more scenarios. The scenario is a completed interaction. For example, The scenario like:</p>
<ol>
<li>User A send message to the system.</li>
<li>The system send message to User B.</li>
</ol>
<p>Step 1 or Step 2 is not a scenario. Step 1 with Step 2 is a completed scenario.<br />
And our chat system will be like:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/init-system.png" alt="init-system" /></p>
<p><strong>Figure 2.1</strong> init system</p>
</div>
<p>Er…It’s too simple…So let’s write more scenarios:</p>
<h2 id="scenario-1-send-and-get-message-in-realtime"><a class="markdownIt-Anchor" href="#scenario-1-send-and-get-message-in-realtime"></a> Scenario 1: send and get message in realtime</h2>
<ol>
<li>User A send message to the system.</li>
<li>The system send message to user B.</li>
</ol>
<h2 id="scenario-2-send-message-and-get-it-after-a-while-because-user-is-offline"><a class="markdownIt-Anchor" href="#scenario-2-send-message-and-get-it-after-a-while-because-user-is-offline"></a> Scenario 2: send message and get it after a while, because user is offline.</h2>
<ol>
<li>User A send message to the system.</li>
<li>At this time, user B is offline.</li>
<li>User B is online.</li>
<li>The system send message to User B.</li>
</ol>
<h3 id="scenario-3-read-old-messages"><a class="markdownIt-Anchor" href="#scenario-3-read-old-messages"></a> Scenario 3: read old messages</h3>
<ol>
<li>User can read old messages of chat in receive-time order.</li>
</ol>
<h2 id="scenario-4-group-chat-in-realtime"><a class="markdownIt-Anchor" href="#scenario-4-group-chat-in-realtime"></a> Scenario 4: group chat in realtime</h2>
<ol>
<li>User A, B, and C join a chat group</li>
<li>A send message to the system</li>
<li>B and C receive the message from system.</li>
</ol>
<h2 id="scenario-5-group-chat-when-someone-is-offline"><a class="markdownIt-Anchor" href="#scenario-5-group-chat-when-someone-is-offline"></a> Scenario 5: group chat when someone is offline</h2>
<ol>
<li>User A, B, and C join a chat group</li>
<li>User A send message to the system.</li>
<li>C will receive the message in realtime.</li>
<li>At this time, user B is offline.</li>
<li>When User B is online, the system send message to User B in create-time order.</li>
</ol>
<h2 id="scenario-6-chat-status-changing"><a class="markdownIt-Anchor" href="#scenario-6-chat-status-changing"></a> Scenario 6: chat status changing</h2>
<ol>
<li>User A chat with B</li>
<li>When A is typing words, B will get “A is typing…” message from system.</li>
<li>When A press “send” button, A will get “the message is sending” from system.</li>
<li>When B’s app receive the message in background, A will get “the message is delivered”.</li>
<li>When B open the chat with A, and scroll to the message, A will get “the message has been read.”</li>
</ol>
<p>Here, scenario 5 and 4 is similar to 2 and 1. So can we consider scenario 2 and 1 are group chat with only one person? Can I chat with myself? And there should be more scenarios be considered. For example:</p>
<ol>
<li>User sign in</li>
<li>User sign up</li>
<li>User quit</li>
<li>Invite other user to use the app</li>
<li>Find a user</li>
<li>Add relationship with other user, family, friends, enemy, lover, couple, and so on. Others should comfire the relationship.</li>
<li>Break the relationship.</li>
<li>Rebuild the relationship with the same user. Er…Are you crazy? …Trust me, most of lovers will repeat break-rebuild relationship scenarios. If you don’t believe it, you must be younger than me.</li>
<li>Build a chat group, or invite other user one by one to join chat/group chat.</li>
<li>Exit a chat group, but can not exit one-one chat, unless breaking the relationship.</li>
<li>Type message with emoji, gif, png, voice, and other rich text.</li>
<li>Search old messages</li>
<li>Delete old messages.</li>
<li>Set/Show online/offline or other user status to one or more users.</li>
<li>Can we chat face to face?</li>
<li>Change user own info</li>
</ol>
<p>In this article, we can not talk all above. It’s too complicated. I will only focus on group chat and chat status changing scenarios.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/scenarios.png" alt="scenarios" /></p>
<p><strong>Figure 2.2</strong> scenarios relationship</p>
</div>
<p>Like Figure 2.2 describles, one-one chat is a special case of group chat. So here use inherit arrow. The interaction of scenario 6 will be included from group chat scenarios. But scenario 3 is alone. If scenario 3 is discarded, our message service will be like “Snapchat”. And I use “User” actor instead of “User A” or “User B”. Why I always write a rectangle as “Messager service”? Because the rectangle warns us, our service has its own boundary! We will not consider other scenarios. If those scenarios inside of rectangle do not be implemented, our service is useless. And if you want to add more functionalities, the rectangle will be bigger and bigger. So thinking about your limit time and money, can you add more functionalities? The correct thing is creating worked well service, notwriting piles and piles of functionalities. Mmmmm…sound like: I use your “Messager service”, will you add “beautify photo”? <strong>NO!!!</strong></p>
<h1 id="how-to-design"><a class="markdownIt-Anchor" href="#how-to-design"></a> How to design?</h1>
<p>Seems like we always talk about how user use our messager service. Er…Correct! So here I will write something about how to design it. I don’t know how to build the system. I only knows there should be a client and a server…So like that:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/init-components.png" alt="init-components" /></p>
<p><strong>Figure 3.1</strong> init components</p>
</div>
<p>Now, we have first components diagram. Let’s do more thinking. If we store data, we will have database. If we connect with others, there should have a channel mananger. My chat groups should be controlled by group manager. If some user is offline, can we send offline message to them by APNS? Adding schedule component for sending message to offline user is a good idea. There should have a component for transforming “chat message” to service data, and doing reverse. And another component called “chat service” controls all component to work togather.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/more-components.png" alt="more-components" /></p>
<p><strong>Figure 3.2</strong> decompose components</p>
</div>
<p>In Figure 3.2, I decompose “Client” into “Interface”, “Transform” and “Channel”, and decompose “Server” into other small components. How to use line to connect those components? The answer is if the connection between components exists, connecting them. It’s nosense!! And another way to deal with the connections is following data flows. In Message services, there exists at least two data flows.</p>
<ol>
<li>User -&gt; Client Interface -&gt; Transform message to bytes/data -&gt; send to Channel -&gt; Server Channel Mgr receive bytes/data -&gt; Transfrom into server data -&gt; according to data, pull group data from Group Mgr and store message into Database.</li>
<li>According to group info, sending message to other group members -&gt;  Transfrom server data into bytes -&gt; send to Channel Mgr -&gt; delivery message to Client Channel -&gt; Transform bytes to message -&gt; display message to User.</li>
<li>Schedule reading what cannot be deliveried -&gt; send message through Chat Service -&gt; Transfrom server data into bytes …</li>
</ol>
<p>Er…Can we connect Group Mgr with DAO? <strong>YES</strong>. One point is you can change all diagrams in any time. And another point is, if you don’t draw line between Group Mgr and DAO, you can implement the system as well. For example,</p>
<ol>
<li>we can store group info into files</li>
<li>we use Chat Service as proxy to store group info. Chat Service will call DAO to store group info, if chat exist. If the group members are all silence, the group will be destroyed after a while.</li>
</ol>
<p>Is there a formal way to draw those components and lines? <strong>NO.</strong> This is why the software is attractive. <strong>Every software is artwork.</strong> Do you remember your first program? Always print: “Hello World!” It’s boring! Can we make the world different?</p>
<p>End? No. I will write how to decompose conponent into classes later.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/80/">80</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">帐前卒</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">24:18</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/bookmark.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/search/local-search.min.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha256-3574TpfThVfeAhg+I4+N39EJiLN3QUkuEsMVe8hWAR4=" crossorigin="anonymous">


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"chilly/blog_comments","issue_term":"url","theme":"github-dark"}</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/comments/utterances.min.js"></script>

</body>
</html>
