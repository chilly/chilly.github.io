<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.ico">
  <link rel="mask-icon" href="/icon.svg" color="#222">
  <meta name="google-site-verification" content="hcdiytqUGPoTW0eAaN6TWAmRfiv7IWFIIc9DKNr7Eno">
  <meta name="yandex-verification" content="eb8f01295fdccb3d">
  <meta name="baidu-site-verification" content="QoJxa8tZnO">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Times+New+Roman:300,300italic,400,400italic,700,700italic%7CRaleway:300,300italic,400,400italic,700,700italic%7COswald:300,300italic,400,400italic,700,700italic%7CWork+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"chillyc.info","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":true,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":20,"unescape":false,"preload":false}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/config.min.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="帐前卒专栏">
<meta property="og:url" content="http://chillyc.info/">
<meta property="og:site_name" content="帐前卒专栏">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="帐前卒">
<meta property="article:tag" content="有意思的代码，有意思的架构, 有趣的小说, 好看的故事, code, software, articles, novel, architect">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://chillyc.info/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>帐前卒专栏 - code, software architect, articles and novels.<br/>代码，软件架构，博客和小说</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/rss2.xml" title="帐前卒专栏" type="application/rss+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <!-- Global site tag (gtag.js) - Google Analytics start -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-11621532-3"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6565392687771630"
     crossorigin="anonymous"></script>
<script>
  window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-11621532-3');
</script>
 <!-- Global site tag (gtag.js) - Google Analytics end -->
  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">帐前卒专栏</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">code, software architect, articles and novels.<br/>代码，软件架构，博客和小说</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-feeds"><a href="/rss2.xml" rel="section"><i class="fa fa-feed fa-fw"></i>feeds</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="帐前卒"
      src="/icon.svg">
  <p class="site-author-name" itemprop="name">帐前卒</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">794</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">751</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoaWxseQ==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chilly"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9jY3R0XzE=" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;cctt_1"><i class="fab fa-twitter fa-fw"></i>Twitter</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLW5kLzQuMC8="><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/big/by_nc_nd.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2023/11/03/clash-for-windows-download/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/11/03/clash-for-windows-download/" class="post-title-link" itemprop="url">Clash-for-Windows-Download</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-11-03 01:16:02 / Modified: 01:23:41" itemprop="dateCreated datePublished" datetime="2023-11-03T01:16:02+08:00">2023-11-03</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>182</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>1 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>今天听说clash-for-windows这应用的主人删库跑路了。所以这里减少大家盲目search的时间。直接贴一下下载地址：<br />
<span class="exturl" data-url="aHR0cHM6Ly9jbGFzaGZvcndpbmRvd3MubmV0L2ZpbGVzL0NsYXNoLmZvci5XaW5kb3dzLlNldHVwLjAuMjAuMzAuZXhl">download<i class="fa fa-external-link-alt"></i></span></p>
<p>这个现在是不带病毒的，后续是否带病毒，就不知道了。怕带病毒的话，需要自行编译, 源码地址详见：<br />
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoaWxseS9DbGFzaC1mb3ItV2luZG93c19DaGluZXNl">github地址<i class="fa fa-external-link-alt"></i></span></p>
<p>不过这个编译后的是否有后门就不清楚了。大家自行看源码吧。</p>
<p>既然来了，你在等待下载的时间要不要看看我的其他blog呀？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2023/10/08/hexo-markdown-template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/08/hexo-markdown-template/" class="post-title-link" itemprop="url">Hexo Is Not Support Markdown Template, So I Write One!</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-08 16:46:56 / Modified: 20:26:47" itemprop="dateCreated datePublished" datetime="2023-10-08T16:46:56+08:00">2023-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/hexo/" itemprop="url" rel="index"><span itemprop="name">hexo</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I update Hexo last stable version (6.3.0). And I change node/npm version to v18.18.0/9.8.1.<br />
I found the changes in Hexo is quite big. I found images can not be displayed properly.</p>
<p>Old version image is like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span></span><br><span class="line">![](https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/1.jpg)</span><br><span class="line">**figure 1.1**</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>It can not be rendered properly.Then I changed the format of html like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span></span><br><span class="line"></span><br><span class="line">![1.jpg](https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/1.jpg)</span><br><span class="line"></span><br><span class="line">**figure 1.1**</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Then it worked. I think it is hexo <strong>incompatibility</strong> issue.</p>
<p>Every time I add a centered picture and picture title, I write like the above code. It’s too complicated. If hexo support markdown template,m, I will write like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image_mid &#x27;/image/a.png&#x27;  &#x27;Figure1.1&#x27;  &#x27;1.jpg&#x27; %&#125;</span><br></pre></td></tr></table></figure>
<p>But there is no plugin in Hexo can implement this functionality. And theme <code>_partials</code> and <code>_macro</code> is njk can not used in markdown.</p>
<p>So I write my own plugin <code>image-mid</code>.</p>
<p>In <code>node_modules/hexo/lib/plugins/tag</code>, add new file called <code>image_mid.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> img = <span class="built_in">require</span>(<span class="string">&#x27;./img&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; encodeURL, escapeHTML &#125; = <span class="built_in">require</span>(<span class="string">&#x27;hexo-util&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Asset image tag</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Syntax:</span></span><br><span class="line"><span class="comment"> *   &#123;% image_mid path [figure] [text] %&#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">path</span></span></span><br><span class="line"><span class="comment"> *   1. support post_asset</span></span><br><span class="line"><span class="comment"> *   1. support relative path like /images/a.jpg, will find in &quot;source&quot; folder =&gt; sources/images/a.jpg</span></span><br><span class="line"><span class="comment"> *   1. support http:// and https:// </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">figure</span></span></span><br><span class="line"><span class="comment"> *   Optional parameter, is image title which is below the image.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">text</span></span></span><br><span class="line"><span class="comment"> *   Optional parameter, will be displayed when the image fails to load</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImage</span>(<span class="params">id, path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> image = <span class="title function_">getImageFromAsset</span>(id, path, text, ctx);</span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        image = <span class="title function_">getImageFromRelativePath</span>(path, text, ctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        image = <span class="title function_">getImageFromInternalPath</span>(path, text, ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!image) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;can not render image tag. By path:&#x27;</span>, path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromAsset</span>(<span class="params">id, path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">PostAsset</span> = ctx.<span class="title function_">model</span>(<span class="string">&#x27;PostAsset&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> asset = <span class="title class_">PostAsset</span>.<span class="title function_">findOne</span>(&#123;<span class="attr">post</span>: id, <span class="attr">slug</span>: path&#125;);</span><br><span class="line">    <span class="keyword">if</span> (asset) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(<span class="title function_">resolve</span>(<span class="string">&#x27;/&#x27;</span>, asset.<span class="property">path</span>)), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">urlConcat</span>(<span class="params">base, path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (base.<span class="title function_">endsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">startsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> base.<span class="title function_">substring</span>(<span class="number">0</span>, base.<span class="property">length</span>-<span class="number">1</span>) + path;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> base + path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">startsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> base + path;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base + <span class="string">&#x27;/&#x27;</span> + path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeLastSlash</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">endsWith</span>(<span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> path.<span class="title function_">substring</span>(<span class="number">0</span>, path.<span class="property">length</span>-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromRelativePath</span>(<span class="params">path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> base_path = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">var</span> image_path = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>.<span class="property">cdn_url_prefix</span>) &#123;</span><br><span class="line">            base_path = <span class="title function_">removeLastSlash</span>(ctx.<span class="property">config</span>.<span class="property">jsdelivr_cdn</span>.<span class="property">cdn_url_prefix</span>) +<span class="string">&#x27;@master/&#x27;</span>;</span><br><span class="line">            image_path = <span class="title function_">urlConcat</span>(base_path, path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!image_path) &#123;</span><br><span class="line">        image_path = <span class="title function_">resolve</span>(base_path, path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(image_path), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getImageFromInternalPath</span>(<span class="params">path, text, ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">indexOf</span>(<span class="string">&#x27;http://&#x27;</span>) &gt; <span class="number">0</span> || path.<span class="title function_">indexOf</span>(<span class="string">&#x27;https://&#x27;</span>) &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">img</span>(ctx)([<span class="title function_">encodeURL</span>(path), <span class="string">&quot;&#x27;&#x27; &#x27;&quot;</span>+text+<span class="string">&quot;&#x27;&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> =  <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">assetImgMidTag</span>(<span class="params">args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = args.<span class="property">length</span>;</span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;image path is not set. args:&#x27;</span>, args, <span class="string">&#x27;file:&#x27;</span>, <span class="variable language_">this</span>.<span class="property">full_source</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> path = args[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">var</span> figure = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> text = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        figure = escapeHTML(args[<span class="number">1</span>]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (args.<span class="property">length</span> === <span class="number">3</span>) &#123;</span><br><span class="line">        text = escapeHTML(args[<span class="number">2</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// Find image html tag</span></span><br><span class="line">      <span class="keyword">var</span> image = <span class="title function_">getImage</span>(<span class="variable language_">this</span>.<span class="property">_id</span>, path, text, ctx);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`&lt;div align=center&gt;&lt;br/&gt;<span class="subst">$&#123;image&#125;</span>&lt;br/&gt;&lt;strong&gt;<span class="subst">$&#123;figure&#125;</span>&lt;/strong&gt;&lt;br/&gt;&lt;/div&gt;`</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>In file <code>node_modules/hexo/lib/plugins/tag/index.js</code>, add the following code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;image_mid&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;./image_mid&#x27;</span>)(ctx));</span><br><span class="line">tag.<span class="title function_">register</span>(<span class="string">&#x27;img_mid&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;./image_mid&#x27;</span>)(ctx));</span><br></pre></td></tr></table></figure>
<p>Then in your markdown file. Write like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% image_mid &#x27;/image/a.png&#x27;  &#x27;Figure1.1&#x27;  &#x27;1.jpg&#x27; %&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>It will generate the html like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div align=&quot;center&quot;&gt;&lt;br&gt;&lt;img src=&quot;/image/a.png&quot; class=&quot;&quot;&gt;&lt;br&gt;&lt;strong&gt;&lt;/strong&gt;&lt;br&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>If you install <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3JlbnppYmVpL2hleG8tY2RuLWpzZGVsaXZyL2Jsb2IvbWFzdGVyL3JlYWRtZS1jbi5tZA==">jsdelivr_cdn plugin<i class="fa fa-external-link-alt"></i></span>. And you write your _config.yml in Hexo root like this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jsdelivr_cdn:</span></span><br><span class="line">  <span class="attr">use_cdn:</span> <span class="literal">true</span> </span><br><span class="line">  <span class="attr">cdn_url_prefix:</span> <span class="string">write</span> <span class="string">your_cdn_root_path</span> <span class="string">like</span> <span class="string">&#x27;https://cdn.jsdelivr.net/gh/&lt;username for github&gt;/&lt;assets repo name&gt;/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>The html will be generated like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">&quot;center&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/gh/&lt;username for github&gt;/&lt;assets repo name&gt;@master/image/a.png&quot;</span> <span class="attr">class</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The effect is as follows:</p>
<div align=center><br/><img src="https://cdn.jsdelivr.net/gh/chilly/blog_cdn@master/images/4096/2.png" class="" alt="2.png"><br/><strong>在4旁边生成4</strong><br/></div>
<p>The image tag is generated as CDN path.</p>
<p>This <code>image_mid</code> is support:</p>
<ul>
<li>post asset path</li>
<li>relative path</li>
<li>http/https path</li>
<li>And post asset path and relative path can be generated as CDN path.</li>
</ul>
<p>Use it and write your comments.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/18/Architect-week4-hashmap/hashmap-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/18/Architect-week4-hashmap/hashmap-design/" class="post-title-link" itemprop="url">HashMap Design (1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-18 14:39:57" itemprop="dateCreated datePublished" datetime="2017-10-18T14:39:57+08:00">2017-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 11:29:21" itemprop="dateModified" datetime="2023-10-06T11:29:21+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.3k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="before"><a class="markdownIt-Anchor" href="#before"></a> Before</h1>
<p>Thanks for inviting me to answer the question: “Design a HashMap”. The description of the question is here:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Design methods like *put, get, containsKey, </span><br><span class="line">containsValue, remove* etc and answer the *complexity*.</span><br></pre></td></tr></table></figure>
<p>All of us knows “HashMap”. It is not “HashTable” see <strong>Figure 1.1</strong>. It means there does not exist a big array to store all of data.</p>
<div align=center>
<p><img src="/images/Architect-week4-hashmap/hashtable.png" alt="hashtable.png" /></p>
<p><strong>Figure 1.1</strong> hashtable</p>
</div>
<p>Compute hash(key) and put the value into array[hash(key)]. If array[hash(key)] is stored by other data, you <strong>must not</strong> put it into another slot. See <strong>Figure 1.2</strong>. You should create space for storing your new data.</p>
<div align=center>
<p><img src="/images/Architect-week4-hashmap/hashmap.png" alt="hashmap.png" /></p>
<p><strong>Figure 1.2</strong> hashmap</p>
</div>
<h1 id="complexity"><a class="markdownIt-Anchor" href="#complexity"></a> Complexity</h1>
<p>How to design it? We should have a hash function. And create an array/list called <strong>slot/bucket</strong> to store pointers/references which point to real data. Simple? But we should not implement the code immediately. Consider the functions and <strong>complexity</strong> first.</p>
<p>I assume complexity of hash function is <strong>O(hash)</strong>. And the complexity of Operator is <strong>T(n)</strong>. It means doing the operator n times. We look at <strong>put</strong> function. O(hash) often is done in constant time as O(1). But in special case like hash(Big Integer or Long String), the complexity of hash function will be O(x), x is related with the length of Big Integer or Long String. Em…Those are extreme cases, and we don’t care! So we just consider O(hash) as O(1).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">put(key,value)</span><br><span class="line"></span><br><span class="line">T(n) = O(hash) + O(create one space) + O(insert into new space) + T(n-1)</span><br><span class="line">O(create one space) is O(1) </span><br><span class="line">so</span><br><span class="line">T(n) = O(1) + O(insert into new space) + T(n-1)</span><br></pre></td></tr></table></figure>
<p>So what’s the O(insert into new space) ? I don’t know. If it is a single linklist, it will be O(1). We can insert the data into the head of linklist. But if we use other data structures? I will not discuss here. I should list other operaters first.</p>
<p>We assume our hash function is extreme good. The function will decentralize keys homogeneously. According to <strong>pigeon hole principle</strong>, the length of every space is no more than (N/m + 1). <strong>N</strong> is the total number of your data. <strong>m</strong> is the number of slots.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">get(key)</span><br><span class="line"></span><br><span class="line">T(n) = O(hash) + O(look up key from space) + O(return value) + T(n-1)</span><br><span class="line">If key is bind with value, so you find the key, and you also find the value.</span><br><span class="line">So complexity is no more than</span><br><span class="line">T(n) &lt;= O(hash) + O(N/m + 1) +O(1) + T(n-1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if m &gt;&gt; n (m is much bigger than n), then</span><br><span class="line">T(n) &lt;= O(1)+O(1) + T(n-1) = O(1) + T(n-1)</span><br><span class="line"></span><br><span class="line">if n &gt;&gt; m, then</span><br><span class="line">T(n) &lt;= O(1) + O(N) + T(n-1) = O(N) + T(n-1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>and containsKey</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">containsKey(key)</span><br><span class="line">T(n) = O(hash) + O(look up key from space) + T(n-1)</span><br></pre></td></tr></table></figure>
<p>Emm…The complexity of containsKey is similar with that of get(key). <em>contain(key)</em> is equal with <em>get(key)</em> ? Maybe.<br />
and next is <em>containsValue</em></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">containsValue(value)</span><br><span class="line"></span><br><span class="line">T(n) = O(find value in all space) + T(n-1) </span><br></pre></td></tr></table></figure>
<p>In the simple hashmap, there dose not exist value -&gt; key mappings. so the complexity is O(n). We should iterator all values to find the target one.</p>
<p>And next is remove</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">remove(key)</span><br><span class="line"></span><br><span class="line">T(n)  = O(hash) + O(look up key from space) + O(remove key-value) + T(n-1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>If in put(key,value), we use single linklist and insert key-value into head every time. We find the key-value is O(N/m +1) and remove it is O(1). So</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">remove(key)</span><br><span class="line"></span><br><span class="line">T(n) = O(N/m + 1) + T(n-1)</span><br></pre></td></tr></table></figure>
<h1 id="optimize"><a class="markdownIt-Anchor" href="#optimize"></a> Optimize?</h1>
<p>Can we use other data structures to optimize some operation? Yes. But we should consider other factors. like <strong>More complex, more bugs.</strong> and <strong>Effect of optimizing operation</strong>. For example, we consider the operation <strong>containsValue(value)</strong> is bad performance O(n). We can use another kind of hashmap structure to store value -&gt; key mapping. So if we call containsValue(value), we will first call getKey(value) to get key, and then call get(key) to find the value. It sounds good! But how often we will call containsValue(value)? Maybe in every 1000 operations, only 1 operation is containsValue(value) and 999 are <em>containsKey/put/get/remove</em>. There is a little better effect <strong>vs</strong> more complex code. Which do you choose? And if you don’t optimize containsValue, will user think your application is too slow to use?</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/12/Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%8E%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87/" class="post-title-link" itemprop="url">Lambda表达式与图灵完备</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-12 21:34:25" itemprop="dateCreated datePublished" datetime="2017-10-12T21:34:25+08:00">2017-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-05 23:27:54" itemprop="dateModified" datetime="2023-10-05T23:27:54+08:00">2023-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="引子"><a class="markdownIt-Anchor" href="#引子"></a> 引子</h1>
<p>这篇还是用中文写吧。我基本上没有看到中文的推导过程。当然英文的也各种缺失推导过程。有空的话再用英文写一篇（我肯定没有空）。</p>
<p>首先是lambda表达式。用过Python, Java, JS的，都应该知道。否则意味着你肯定没有好好学。</p>
<p>我是从国外的视频中看到lambda表达式和图灵机等价这一观点的。然后人家就进行了简单的推导。然而我根本就看不懂。我很怀疑我的英语水平，于是又仔细看了几遍视频，仍然不懂。我觉得我需要研究一下，因为视频中的很多推导都明白了。但是就有一步推导，讲解者说了这过程比较复杂，然后就带过了。我非常想知道这推导过程怎么来的。所以搜索了许多资料，加上自己的思考，写了下面的文字。</p>
<h1 id="图灵完备"><a class="markdownIt-Anchor" href="#图灵完备"></a> 图灵完备</h1>
<p>图灵完备是个什么意思？通俗的意思就是能实现正整数加减法，if判断跳转，while循环，以及可以构造简单数据结构的都称为图灵完备。图灵完备的语言无法处理停机问题。具备图灵完备的假象机器就是图灵机。你认为正整数加减法，if判断跳转，while循环很简单，所以你这个人也是图灵机的一种。</p>
<p>所有编程语言都会将图灵完备作为最基础的目标。你看比特币智能合约这么火，它也说自己是图灵完备的。这样看来图灵完备是检测这门编程语言是否能通用的前提。当然Java、Python、JS等等都是图灵完备的。</p>
<h1 id="lambda表达式"><a class="markdownIt-Anchor" href="#lambda表达式"></a> lambda表达式</h1>
<p>在推导之前先看看什么是lambda表达式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">f</span>(x) -&gt; x</span><br><span class="line"><span class="title function_">f</span>(x,y) -&gt; x</span><br></pre></td></tr></table></figure>
<p>我认为以上都是lambda表达式。其中f,x都是变量，不光可以代表值还可以代表函数。f(x)代表一次f对x的调用。<strong>-&gt;</strong> 是说最终得到x, 或者结果为x.</p>
<h1 id="lambda表达式图灵完备推导"><a class="markdownIt-Anchor" href="#lambda表达式图灵完备推导"></a> lambda表达式图灵完备推导</h1>
<p>下面开始推导，首先的前提条件是赋值和等价这两个操作是最初存在的。为什么要提这个事情呢？因为不提这个事情就无法进行if的判断，也没有办法得到结果。其实图灵机的定义中其实也暗含了赋值和等价判断这两个基础操作。所有人都认为理所当然，只有我特意将这两个操作提出来。</p>
<p>推导之前我们必须有的基础操作</p>
<ul>
<li>赋值</li>
<li>判断等价</li>
<li>调用，使用**()<strong>表示，也可以使用</strong>.**表示</li>
</ul>
<p>另外我们还应该清楚一件事，就是单参lambda完全等价于多参lambda表达式。在最初的1920+年Church这伟大的人物提出来lambda的时候就是使用的单参。但是我们为了推导方便，我故意使用多参。</p>
<p>问题: 多参为什么等价于单参lambda?</p>
<p>答:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">f(x,y) -&gt; z</span><br><span class="line">t -&gt; (x,y) 这里的括号无二义的时候可以去掉，就是 t -&gt; x,y</span><br><span class="line"></span><br><span class="line">所以 f(t) -&gt; z</span><br><span class="line">证毕</span><br></pre></td></tr></table></figure>
<p>下面开始真正的推导：</p>
<p>首先定义True与False</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">False: x -&gt; x  , 这样写你是不是更明白? (f,x) -&gt; x</span><br><span class="line">True: f,x -&gt; f  这样写你是不是更明白?  (f,x) -&gt; f</span><br></pre></td></tr></table></figure>
<p>然后就可以定义IF判断了。你看看False的定义是不是就是<code>False ? f : x</code>. True的定义是不是<code>True ? f : x</code>.所以False返回了x,而True返回f.我们将IF定义为多元组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IF(False,f,x) -&gt; x</span><br><span class="line">IF(True, f,x) -&gt; f</span><br><span class="line">同时认为</span><br><span class="line">Fst(f,x) -&gt; f 等同于IF(True,f,x)</span><br><span class="line">Snd(f,x) -&gt; x 等同于IF(False,f,x)</span><br><span class="line">这其实就是投影操作。</span><br></pre></td></tr></table></figure>
<p>下面我们再来定义正整数。False在我们计算机界经常被认为是0.所以我们0的定义就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: f,x -&gt; x</span><br></pre></td></tr></table></figure>
<p>正整数1的定义，我们认为调用了一次f,即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1: f,x -&gt; f(x)</span><br></pre></td></tr></table></figure>
<p>下面正整数2，3…，n的定义就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2: f,x -&gt; f(f(x))</span><br><span class="line">3: f,x -&gt; f(f(f(x)))</span><br><span class="line">...</span><br><span class="line">n: f,x -&gt; f(f(...f(x)...)) 这里应有有n个f调用</span><br></pre></td></tr></table></figure>
<p>我们下面为了更加方便我们这样简写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2: f,x -&gt; 2.f(x)</span><br><span class="line">3: f,x -&gt; 3.f(x)</span><br><span class="line">...</span><br><span class="line">n: f,x -&gt; n.f(x)</span><br></pre></td></tr></table></figure>
<p>我们下面来定义加法操作。例如n + m. 这个问题不好想，所以先想特例。例如5 = 2 + 3, 那么怎么得到5呢，就是5次函数调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">5: f,x -&gt; f(f(f(f(f(x))))) == f(f(f(2.f(x)))) == 3.f(m) == 3.f(2.f(x))  其中2.f(x) 替换成m，然后再替换回来。</span><br><span class="line">替换一下</span><br><span class="line">n+m: f,x -&gt; n.f(m.f(x))</span><br></pre></td></tr></table></figure>
<p>定义下乘法操作.例如n*m. 同样先想特例： 6 = 3 * 2. 怎么得到6呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6: f,x -&gt; f(f(f(f(f(f(x)))))) == 2.f(2.f(2.f(x))) == 3.2.f(x)  其中2.f(x)替换为z所以就变成了3.z(x) 再替换回来就是3.2.f(x)</span><br></pre></td></tr></table></figure>
<p>下面是定义n++操作，这个在数学上叫做Successor,所以我叫这个lambda为Succ. 其实从n到n+1是很简单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Succ: n,f,x -&gt; f(n.f(x))  就是多调一次f就行了</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面是定义n–操作，这个在数学上叫做Predecessor. 这个是最复杂的。我看视频就是没看懂这里。问题是怎么从n变成n-1。我知道n-1怎么变成n。那有没有方法将n-1带入公式，最后再同时消除呢？就这么干！当年Church可是苦想n天。我辈比较幸运，直接知道人家的想法了。看这篇文章的你们就更加幸运，因为我把所有被省略的推理过程也写出来了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">先定义： PSucc(n) -&gt; (Snd n,Succ(Snd n))</span><br><span class="line">那么PSucc((0,0)) -&gt; (0,1)</span><br><span class="line">那么我们对PSucc(0)做n次操作就是</span><br><span class="line">n.PSucc((0,0)) = PSucc(PSucc(...PSucc((0,1))...)) 记住这里只有n-1个PSucc调用，因为其中一个PSucc((0,0))已经变成了(0,1)了</span><br><span class="line">               = (n-1, n)</span><br><span class="line"></span><br><span class="line">那我们定义</span><br><span class="line">Pred(n) -&gt; Fst n.PSucc((0,0)) = n-1</span><br><span class="line">Pred就是Predecessor</span><br></pre></td></tr></table></figure>
<p>现在好办了，只要有了加减法，所有的一切操作就都好办了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">n-m的减法就是执行n--操作m次。</span><br><span class="line">SUB(n,m) -&gt; m.Pred(n)</span><br></pre></td></tr></table></figure>
<p>下面再定义一些AND,OR,NOT就非常简单了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AND(a,b) -&gt; IF(a,b,False) 这个意思就是如果a是真的，那就看b是不是真的。否则，那一定返回False.</span><br><span class="line">OR(a,b) -&gt; IF(a,True,b) </span><br><span class="line">NOT(a) -&gt; IF(a,False,True)</span><br></pre></td></tr></table></figure>
<p>下面再定义while循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHILE(n,f) -&gt; n.f</span><br></pre></td></tr></table></figure>
<p>再来定义点简单的数据结构，例如链表, 这里还是学习了一下Lisp</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>)</span><br><span class="line">&gt; x</span><br><span class="line">(<span class="number">1</span> . <span class="number">2</span> )</span><br><span class="line">这创建了一个头是<span class="number">1</span>，尾是<span class="number">2</span>的cons对象。</span><br><span class="line">对cons的操作有两个，car及cdr，分别是读取cons的头和尾元素：</span><br><span class="line">&gt; (<span class="name">car</span> (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; (<span class="name">cdr</span> (<span class="name">cons</span> <span class="number">1</span> <span class="number">2</span>))</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>cons代表的是构建一个链表。 car代表是前一个节点，cdr代表的是后一个节点。那么我们用lambda表达式也写一个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">构造链表cons: cons(a,b) -&gt; (a,b)</span><br><span class="line">获取前一个节点car: car(a,b) -&gt; a</span><br><span class="line">获取后一个节点cdr: cdr(a,b) -&gt; b</span><br></pre></td></tr></table></figure>
<p>我们将0判断、False判断、null判断这三种操作认为是等价的。文章开始也说了，等价判断是先决条件。所以0判断一定是预先存在的。所以lambda表达式图灵完备了。</p>
<p>再说一点，图灵完备，意味着无法停机。停机证明不是本文的重点，不再证明。(对对对，就是笔者不会证明。你们随便吐槽)</p>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>看了这篇文章你能学习到什么？你能证明1+2 == 3 ？还是会写链表了？lambda证明到底有什么用？根本就没有编程来的实在！你说的太对了。我也这样认为。那这篇文章到底有什么用？</p>
<pre><code>就是为了装逼呀!!!
</code></pre>
<p>你看blockchain智能合约这么火，最后还不忘加上<code>图灵完备</code>字样。为啥？为了装逼呀~~~学计算机的这么多人，懂得图灵完备没有几个，懂得怎么证明图灵完备估计也没有几个。以后你们大可以吹嘘自己知道如何证明图灵完备。</p>
<p>看到一条微博，说：<strong>“太难了，我大脑停机了。”</strong> 就回复：“你竟然不是图灵完备的!!”</p>
<p>以后有谁再说**“我无法思考了”**,你们就接话：“你竟然不是图灵完备的!!”</p>
<p>对，以后谁在你们面前装逼说自己会图灵完备的证明，你们就接话：“我也会!!”</p>
<p><strong>这才是这篇文章的正确打开方式。</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/10/07/jdk9/Java9-modular-feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/10/07/jdk9/Java9-modular-feature/" class="post-title-link" itemprop="url">Java9:modular Feature</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-10-07 10:04:15" itemprop="dateCreated datePublished" datetime="2017-10-07T10:04:15+08:00">2017-10-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 12:12:55" itemprop="dateModified" datetime="2023-10-06T12:12:55+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>4 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="起源"><a class="markdownIt-Anchor" href="#起源"></a> 起源</h1>
<p>这次写写JAVA9的modular，俗称模块化。这个应该是Java9的最出彩的地方。之前Java的那个项目叫做Jigsaw。 为什么会有这个项目呢？原因在于之前Java使用package作为管理的。大家为了图省事，里面写的class都是public class。 也就是说包外都可用。大家都使用各种包管理工具ivy, maven, gradle啥的，A依赖C的1.0版本, B依赖于C的2.0版本。然后A,B又被自己的工程所依赖。C的1.0版本和2.0版本中有相同的类，不同的函数定义。见下图：</p>
<div align=center>
<p><img src="/images/jdk9/modular/modular_jar_hell.png" alt="jarhell.png" /></p>
<p><strong>图 1</strong> 运行时依赖不同版本的类</p>
</div>
<p>这就会导致JVM运行时不知道该用哪个类，这就是jar hell问题。不过jar hell还有许多种,这个只是比较常见的一种。</p>
<p>之前jdk自身的package也有许多，写着写着自己都搞不明白到底谁依赖谁了。然后大家就都需要依赖整个jdk的jar。但现在不一样了，只需要依赖一部分模块就行了。module是package的集合。而一个module可以依赖其他的module, 例如所有的module都依赖于java.base这个基础的module。</p>
<h1 id="使用ideintellij"><a class="markdownIt-Anchor" href="#使用ideintellij"></a> 使用IDE，Intellij</h1>
<p>说了这么多，不会用还是白搭。首先我们先用Intellij搭一个java9的工程。目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">    |</span><br><span class="line">    module name</span><br><span class="line">        |</span><br><span class="line">        src</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">			|</span><br><span class="line">			module-info.java</span><br><span class="line">    |</span><br><span class="line">    module name</span><br><span class="line">        |</span><br><span class="line">        src</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">			|</span><br><span class="line">			module-info.java</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里有一个module-info.java。是写什么呢？首先我们将第一个module name写为one, 第二个module写为two. <span class="exturl" data-url="aHR0cDovL3huLS1wYWNrYWdlY2hpbGx5Yy00NjZ2bXUyMDgzYTg2dmQuaW5mbw==">第一个package是chillyc.info<i class="fa fa-external-link-alt"></i></span>。第二个package name是info.chillyc.我们写一个最简单的Hello World代码，在代码里chillyc.info.Hello依赖于info.chillyc.World</p>
<p>Hello.java的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> chillyc.info;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> info.chillyc.World.WORLD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;chillyc.info.Hello&quot;</span> + WORLD);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>World.java的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> info.chillyc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">World</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WORLD</span> <span class="operator">=</span> <span class="string">&quot;WORLD&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>one的module-info.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> one &#123;</span><br><span class="line">    <span class="keyword">requires</span> two;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>two的module-info.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> two &#123;</span><br><span class="line">    <span class="keyword">exports</span> info.chillyc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呃，上面这些写成多个package，也不需要写module-info.java, 不是更省事吗？是是是，的确更省事，这些是为了整个java的生态环境。你一个人爽不叫爽，大家一起爽才行。</p>
<p>顺便一提，在IDE中Project上右键出来New…可以new出来新的module(自动带上了module-info.java)。 这个使用起来更加方便。我记得很久以前其实有package-info.java这个东西的。但是因为只是用来做文档声明的，大家嫌麻烦，都弃之不用了。我并不担心大家不用module-info.java. 因为这个东西还可以严格限制模块外可以调用哪些类。而且必须写模块依赖才行。所以如果你使用了module，那未来你一定有再次用到module的时候. 另外使用了module之后，你打成的最终jar应该更小巧。</p>
<p>仔细的研究一下module-info.java文件，里面有requires和exports。requires是依赖，exports是导出。这点倒是和JS很像。这两句任何一句缺失，你的程序编译时都会报错。错误类似：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">只注释掉exports info.chillyc; 报错：</span><br><span class="line">The module &#x27;two&#x27; does not export the package &#x27;info.chillyc&#x27; to module &#x27;one&#x27;</span><br><span class="line"></span><br><span class="line">只注释掉require two; 报错：</span><br><span class="line">The module &#x27;one&#x27; does not have the module &#x27;two&#x27; in requirements</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>讲完了。你会用了吗？是不是很简单？…的确很简单。但是我觉得这依旧没有什么用。别人使用我的类的时候，如果我没有在module-info中exports出来，那他们要么重新写一个；要么让我改一下代码。</p>
<p>但是module的确让我们的工程代码更加清晰。不过怕就怕你把整个工程的package全部都exports出来，那这东西就没有什么用了。很多时候，我们封装好一个component,只希望暴露出少量的几个类。但是因为测试或者内部调用的方便，一般都会将class定义为public的。那这个时候使用module就可以很好的解决这个问题。</p>
<h1 id="更实用的"><a class="markdownIt-Anchor" href="#更实用的"></a> 更实用的</h1>
<p>对了，写点更加实用的。我们希望将各个module打成jar包，以后就可以单独使用某些module。这部分不能使用Intellij的IDE，因为它还没有支持。首先将Project的目录树变为如下的模样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">    |</span><br><span class="line">    src</span><br><span class="line">        |</span><br><span class="line">        module name</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">            |</span><br><span class="line">            module-info.java</span><br><span class="line">    	|</span><br><span class="line">    	module name</span><br><span class="line">            |</span><br><span class="line">            package name</span><br><span class="line">                |</span><br><span class="line">                class name</span><br><span class="line">            |</span><br><span class="line">            module-info.java</span><br></pre></td></tr></table></figure>
<p>然后开始敲命令了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">首先确定你的javac, java, jlink什么的是不是java9的版本。</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> mods</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">javac -d mods --module-source-path src $(find src -name <span class="string">&quot;*.java&quot;</span>)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行完之后就可以看到mods里面存放了编译好的class文件。继续执行打包命令,注意jar是jdk9里的才行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> mlib</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jar --create --file=mlib/two@1.0.jar --module-version=1.0 -C modt/two .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jar --create --file=mlib/one@1.0.jar --module-version=1.0 --main-class=chillyc.info.Hello -C modt/one .</span></span><br></pre></td></tr></table></figure>
<p>执行jar文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java -p mlib -m one</span></span><br></pre></td></tr></table></figure>
<p>这个问题在于我每次执行就需要带上一个mlib的文件。这个文件很容易被被人直接拿去了反编译了。现在有更好的解决方案了：编译成一个image.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">jlink --module-path jmods:mlib --add-modules one --output oneapp</span></span><br><span class="line">但是实际上上面这个要看你的Path是否正确，如果写成绝对路径应该像下面这样：</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home/bin/jlink --module-path /Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home/jmods:mlib --add-modules one --output oneapp</span></span><br></pre></td></tr></table></figure>
<p>这样就有一个oneapp目录。这个目录里面你再也找不到你的one@1.0.jar这个东西了。如果你要执行，敲下面的命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java -m one</span></span><br></pre></td></tr></table></figure>
<p>通过如下命令可以看一下bin/java这里的modules</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java --list-modules</span></span><br><span class="line">结果:</span><br><span class="line">java.base@9</span><br><span class="line">one@1.0</span><br><span class="line">two@1.0</span><br></pre></td></tr></table></figure>
<p>java.base其实就是java9的默认模块，所有模块都会依赖java.base。上面打包成oneapp中的jmods就是java的基础模块。我觉得这个东西还是比较有用的。另外bin/java中里面暗含了这些模块，所以也可以直接执行刚才的jar。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bin/java -jar [你的相对路径]/one@1.0.jar</span> </span><br></pre></td></tr></table></figure>
<h1 id="结束"><a class="markdownIt-Anchor" href="#结束"></a> 结束</h1>
<p>嗯。modular…其实也没有真正解决Jar Hell的问题。不过如果出现冲突，那么java9的提示会比较友好。另外没有一堆的classpath,这样ps命令时不会眼痛。编译成模块image这点对防止反编译还是有点用处的。但是这个image不能直接放到一个没有Java的环境中使用。那就是说，编译好的image, 仍然达不到开箱即用的效果。希望image这东西在Java10可以开箱即用，不再依赖OS和Jdk。(虽然官方文档说，编译出来的image文件可以放在没有JVM环境的地方使用。但是我Mac下编译出来的，为什不能在linux上使用呢？一点都不跨平台。这至少说明image依赖于OS…)</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmpldGJyYWlucy5jb20vaWRlYS8yMDE3LzAzL3N1cHBvcnQtZm9yLWphdmEtOS1tb2R1bGVzLWluLWludGVsbGlqLWlkZWEtMjAxNy0xLw==">Intellij的官方教程<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvcHJvamVjdHMvamlnc2F3L3F1aWNrLXN0YXJ0">Jigsaw quick start<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvcHJvamVjdHMvamlnc2F3L3RhbGtzL2ludHJvLW1vZHVsYXItZGV2LWoxLTIwMTYucGRm">modular开发手册 2016年版<i class="fa fa-external-link-alt"></i></span><br />
<span class="exturl" data-url="aHR0cDovL29wZW5qZGsuamF2YS5uZXQvamVwcy8yMjA=">modular images<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/29/jdk9/Java9-Flow-feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/29/jdk9/Java9-Flow-feature/" class="post-title-link" itemprop="url">Java9:Flow Feature</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-29 21:00:04" itemprop="dateCreated datePublished" datetime="2017-09-29T21:00:04+08:00">2017-09-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 12:12:17" itemprop="dateModified" datetime="2023-10-06T12:12:17+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>6 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>LP强烈要求用中文写。嗯，好吧，用中文写吧。</p>
<h1 id="flow-简介"><a class="markdownIt-Anchor" href="#flow-简介"></a> Flow 简介</h1>
<p>今天试用了一下jdk9, 最主要关注Flow这个新增的功能。结果发现，这个Flow其实是一个final class，构造函数还是private,没有任何正常方法将其实例化。这个是新功能？我抱着学习的心态看了一下java doc. 发现主要是几个interface. Interface…都是接口，到底有没有实现？</p>
<p>然后不知道怎么查到了reactive-stream, 其实Java的JVM Flow就是按照reactive-stream的API规范写的。</p>
<p>reactive-stream是什么？就是反向压力流（back pressure），其实你称其为反向控制流也行。官方说法是：一个异步非阻塞反向控制流处理的标准。嗯，相当拗口。</p>
<p>什么是反向控制？这里还是抄袭一下别人的图吧。图的出处在<span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkub3JhY2xlLmNvbS9kb2NzL0RPQy0xMDA2NzM4">这里<i class="fa fa-external-link-alt"></i></span>。</p>
<div align=center>
<p><img src="/images/jdk9/flow/flow1.png" alt="flow1.png" /></p>
<p><strong>图 1</strong> 正常流处理</p>
</div>
<p>下面是反向的流处理：</p>
<div align=center>
<p><img src="/images/jdk9/flow/flow2.png" alt="flow2.png" /></p>
<p><strong>图 2</strong> 反向流处理</p>
</div>
<p>看到了吧，反向的流处理<strong>图 2</strong>是Subcriber需要多少数据，就给多少数据。不要不给。正常的流处理<strong>图 1</strong>是管你要多少，我有多少给你多少。图1的问题就导致数据在管道里积压，或者在Subscriber里面积压。所以正常的流一般处理时要么数据就丢弃掉了，要么JVM就OOM了。所以反向的流好棒好棒的!</p>
<p>嗯，感觉也不是，因为有可能反向的流在Publisher的地方挤压了…其实你的程序性能不行，处理不完，积压不可避免。所以这反向的鬼东西有什么用呢？除非你的Publisher是根据你处理的数据的性能来生产数据。这听起来很酷，这很像当年教务系统的排队选课，以及魔兽世界中的等等等…其实就是处理性能不行，只能反推给最初的生产者<strong>人</strong>。当然还有一种使用场景是消除峰值，当大量数据瞬间涌入时会造成整个系统崩溃。但如果你的系统在限定的时间内慢慢处理这些数据，还是完全没有问题的。这样就增加了系统的稳定性。</p>
<p>Java9其实只是将这个标准写入了JVM中而已。我顺便看了一下Publisher以及Subscriber的实现类，很多都是incubate包的(即实验中)。只有一个类是特别的存在：SubmissionPublisher。</p>
<h1 id="flow-使用"><a class="markdownIt-Anchor" href="#flow-使用"></a> Flow 使用</h1>
<p>这个Flow使用起来，真的好麻烦。最初我知道Flow这个Feature的时候，我以为只需要将数据push到流里，然后有一个default的Consumer获取到数据。这个Flow自己给我搞定了反向控制。No,No,No. Java9啥都没有做。啥都需要你自己写。如果没有SubmissionPublisher，那你需要根据那几个Interface自己去实现。这是什么鬼，我是不是可以宣布我写了一个可以实现全世界所有功能的框架呢？我的框架就是下面这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Everything</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doEverything</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是非常棒?! Java9宣称的Flow就和我上面宣称的没有啥区别,只是它的接口更多而已。好了，它还是给出了一个SubmissionPublisher。 我就先原谅它吧… 可是怎么使用呢？我再次抄袭了<span class="exturl" data-url="aHR0cHM6Ly9jb21tdW5pdHkub3JhY2xlLmNvbS9kb2NzL0RPQy0xMDA2NzM4">这边的blog的代码<i class="fa fa-external-link-alt"></i></span>。我也不知道为啥变得这么厚颜无耻，不知脸红的抄袭，可能是跟腾讯阿里学的吧。</p>
<h2 id="publisher和subscriber简单示例"><a class="markdownIt-Anchor" href="#publisher和subscriber简单示例"></a> Publisher和Subscriber简单示例</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MySubscriber</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Flow</span>.Subscriber&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">            subscription.request(<span class="number">1</span>); <span class="comment">//这里要使用Long.MAX_VALUE就会被认为获取无穷的数据。</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T item)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Got : &quot;</span> + item);</span><br><span class="line">            subscription.request(<span class="number">1</span>); <span class="comment">//这里也可以使用Long.MAX_VALUE</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Register Subscriber</span></span><br><span class="line">        MySubscriber&lt;String&gt; subscriber = <span class="keyword">new</span> <span class="title class_">MySubscriber</span>&lt;&gt;();</span><br><span class="line">        publisher.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Publish items</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Publishing Items...&quot;</span>);</span><br><span class="line">        String[] items = &#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;x&quot;</span>&#125;;</span><br><span class="line">        Arrays.asList(items).stream().forEach(i -&gt; publisher.submit(i));</span><br><span class="line">        publisher.close();</span><br><span class="line">        Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要的函数是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 反向控制获取数据个数。</span></span><br><span class="line"><span class="comment">//代码里两处request(1)都不能丢，否则数据无法正常获取</span></span><br><span class="line">subscription.request(<span class="number">1</span>)</span><br><span class="line"><span class="comment">// 发布数据，相当于数据输入</span></span><br><span class="line">publisher.submit(i)</span><br><span class="line"><span class="comment">// 关闭publisher，没有该函数则Subscriber.onComplete()不会被调用。</span></span><br><span class="line">publisher.close()  </span><br><span class="line"><span class="comment">// 因为是异步的流处理</span></span><br><span class="line"><span class="comment">// 所以没能提供同步的接口，可以自己在Subcriber中加入同步策略</span></span><br><span class="line"><span class="comment">// 我这里简化了,如果你去掉这段代码，那你可能什么都看不到</span></span><br><span class="line">Thread.sleep(<span class="number">20000</span>);</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Publishing Items...</span><br><span class="line">Got : 1</span><br><span class="line">Got : x</span><br><span class="line">Got : 2</span><br><span class="line">Got : x</span><br><span class="line">Got : 3</span><br><span class="line">Got : x</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>
<h2 id="flow的processor接口"><a class="markdownIt-Anchor" href="#flow的processor接口"></a> Flow的Processor接口</h2>
<p>Flow还有一个重要的Processor接口，这个其实就是函数变换。其实一般的函数变换操作都可以在Subscriber中实现，Processor并没有什么卵用。不过如果让我去定义接口，我仍然会给出Processor. 为啥？这样会防止别人来喷我…嗯，其实给出了Processor接口，一样有人来喷，例如我…</p>
<p>看下图就知道我在说什么了。竟然无图可盗了…</p>
<div align=center>
<p><img src="/images/jdk9/flow/withProcessor.png" alt="withProcessor.png" /></p>
<p><strong>图 3</strong> 带有Processor的流</p>
</div>
<div align=center>
<p><img src="/images/jdk9/flow/withoutProcessor.png" alt="withoutProcessor.png" /></p>
<p><strong>图 4</strong> 没有Processor的流</p>
</div>
<p>如果增加另外一个流，就可以完全实现Processor的功能。所以表达流的<strong>最小原语</strong>不应该存在Processor这东西。但是Reactive-Stream说：我的这个就是规范。那好吧，就加一个吧。不过增加Processor的好处在于：你可以只写一个流，里面有很多Processor。而不是写很多流，将Subscriber和Publisher混在一起写。虽然你已经在Processor中将Publisher,Subscriber混在一起写了…嗯…呃…总而言之，你一定要相信规范，Processor存在一定有它的道理。</p>
<p>下面也给一个Process的例子：是过滤用的Processor.(这段代码是我自己写的，在Oracle官方文档中本应存在这段代码，但是他们不小心忘记写了…忘记写了…我看到的官方文档最后由 Bob Rhubart-Oracle 于 2016-9-26 下午2:03修改,版本号为6)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyFilterProcessor</span>&lt;T,K <span class="keyword">extends</span> <span class="title class_">T</span>&gt; <span class="keyword">extends</span> <span class="title class_">SubmissionPublisher</span>&lt;K&gt; <span class="keyword">implements</span> <span class="title class_">Flow</span></span><br><span class="line">            .Processor&lt;T, K&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Function&lt;? <span class="built_in">super</span> T, Boolean&gt; function;</span><br><span class="line">        <span class="keyword">private</span> Flow.Subscription subscription;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyFilterProcessor</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, Boolean&gt; function)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">            <span class="built_in">this</span>.function = function;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Flow.Subscription subscription)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.subscription = subscription;</span><br><span class="line">            subscription.request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T item)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="type">boolean</span>) function.apply(item)) &#123;</span><br><span class="line"></span><br><span class="line">                submit((K)item);</span><br><span class="line">            &#125;</span><br><span class="line">            subscription.request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">            close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//Create Publisher</span></span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> <span class="title class_">SubmissionPublisher</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Create Processor and Subscriber</span></span><br><span class="line">        MyFilterProcessor&lt;String, String&gt; filterProcessor = <span class="keyword">new</span> <span class="title class_">MyFilterProcessor</span>&lt;&gt;(s -&gt; s.equals(<span class="string">&quot;x&quot;</span>));</span><br><span class="line"></span><br><span class="line">        MySubscriber&lt;Integer&gt; subscriber = <span class="keyword">new</span> <span class="title class_">MySubscriber</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Chain Processor and Subscriber</span></span><br><span class="line">        publisher.subscribe(filterProcessor);</span><br><span class="line">        filterProcessor.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Publishing Items...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] items = &#123;<span class="string">&quot;1&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;x&quot;</span>&#125;;</span><br><span class="line">        Arrays.asList(items).stream().forEach(i -&gt; publisher.submit(i));</span><br><span class="line">        publisher.close();</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Publishing Items...</span><br><span class="line">Got : 1</span><br><span class="line">Got : 2</span><br><span class="line">Got : 3</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>
<p>重要的代码片段是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(<span class="type">boolean</span>) function.apply(item)) &#123;</span><br><span class="line">	submit((K)item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的submit就是数据再发布，相信大家都能看懂，不再叙述。</p>
<h1 id="flow-性能测试"><a class="markdownIt-Anchor" href="#flow-性能测试"></a> Flow 性能测试</h1>
<p>到底这个东西性能怎么样？我是不是随便写一个Flow的实现都比它快？如果它性能差，我按它这个规范写有什么意义？为了好看吗？<br />
好吧。我自己用无锁队列实现了一下。功能就是简单的计数，看看各自的最强性能。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">无锁队列执行结果：</span><br><span class="line">class chillyc.info.speed.old.XFlow:27qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:171629qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:7586111qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:8095748qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:7640866qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6845523qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6516655qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6191659qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:5742711qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:6657964qps</span><br><span class="line">class chillyc.info.speed.old.XFlow:5720992qps</span><br></pre></td></tr></table></figure>
<p>JVM jdk9 Flow执行结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Concurrent.Flow 测试结果： 设置无穷索取, request(Long.MAX_VALUE)</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:39688qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6798618qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6556238qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6506791qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6545895qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:7129085qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:7005827qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:6818252qps</span><br></pre></td></tr></table></figure>
<p>性能对比图：</p>
<div align=center>
<p><img src="/images/jdk9/flow/speed.png" alt="性能对比" /></p>
<p><strong>图 5</strong> 性能对比图</p>
</div>
<p>个人感觉前两次都可以忽略不计，无锁队列的实现中，前两次线程还没有完全启动，数据还没有完全填充。不过从另外一个侧面反映出jdk9 Flow启动效率非常高。我们除去前两次计算一下平均值。看到两者相差不大:无锁队列比jdk9 Flow平均快了17000+qps.</p>
<p>实验和数据量，buffer大小都有关系，变量太多，没有一一实验，并且两者的qps都是六七百万量级，所以我认为两者差别不大。JDK9的Flow实现的挺不错的，竟然能和我顺手写的性能差不多。我心中不由的赞叹一番。</p>
<h1 id="flow-bug"><a class="markdownIt-Anchor" href="#flow-bug"></a> Flow bug</h1>
<p>因为测试了jdk9 Flow的无限索取时的性能。我想再测测每次取一个导致的最差性能（request(1)）。结果就发现了bug.<br />
测试输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:55296qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br><span class="line">class chillyc.info.speed.jdk9flow.Jdk9Flow:0qps</span><br></pre></td></tr></table></figure>
<p>从结果上分析，经过一段时间之后，jdk9的Flow就无法处理数据了。这…真的能用吗？</p>
<h1 id="结束语"><a class="markdownIt-Anchor" href="#结束语"></a> 结束语</h1>
<p>本来应该带着虔诚敬畏的心态学习JDK9的…结果变成了吐槽大会了…罪过罪过，实在不该这样…顺便一提，jshell非常好用，tab功能提示很强大，就是我机器性能有点差，感觉很卡顿…</p>
<p>对了，不要以为我只会讨论jdk9…那是因为ReactJS 16发布的比较晚。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/24/Architect-week3-whatsapp/Class-Diagram/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/24/Architect-week3-whatsapp/Class-Diagram/" class="post-title-link" itemprop="url">Class-Diagram-Architect-Week3-Whatsapp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-24 22:18:23" itemprop="dateCreated datePublished" datetime="2017-09-24T22:18:23+08:00">2017-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:42:44" itemprop="dateModified" datetime="2023-10-06T20:42:44+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>I will write an article to design Class Diagram. <a href="../../Architect-week3-whatsapp/">In before article, I draw some usecases and component diagrams.</a></p>
<h1 id="4-transform-component-diagram-into-class-diagram"><a class="markdownIt-Anchor" href="#4-transform-component-diagram-into-class-diagram"></a> 4. Transform component diagram into class diagram</h1>
<h2 id="41-mark-noun-as-entity"><a class="markdownIt-Anchor" href="#41-mark-noun-as-entity"></a> 4.1 Mark noun as entity</h2>
<p>I like OOM(Object Oriented Model). Because our world is built by things. And we describe those things as noun, like sky, bird, hand, clothes. In OOD(Object Oriented Design), things are object/class entities. So there is the equation:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">things == noun == entities     (4.1.1)</span><br></pre></td></tr></table></figure>
<p>Here, I will describe our system again. <strong>Clients</strong> will send <strong>message</strong> to our “Messager Service”. <strong>User</strong> will chat with someone. User can chat with many people in one <strong>chat room</strong>. <strong>Chatting</strong> is real-time. But if all clients of user are offline, system will send offline <strong>messages</strong> to one of user’s mobile client.</p>
<p>Why mobile client? Because web/pc client are hardly woke up. Emmm…Should we add a constraint? <strong>“User only use one client to login/chat.”</strong> Without this constraint, system should boradcast chat messages?</p>
<p>But here our key point is marking noun. I already marking them as <strong>“BOLD”</strong>. But <strong>client</strong> is not in “Server” rectangle in component diagram. I will draw client class diagram later.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init.png" alt="class-init.png" /></p>
<p><strong>Figure 4.1.1</strong> init classes</p>
</div>
<h2 id="42-add-relationship-between-entities"><a class="markdownIt-Anchor" href="#42-add-relationship-between-entities"></a> 4.2 Add relationship between entities</h2>
<p>In Figure 4.1.1 Chatting class is the most important class. But Chatting means a chat message. So I change it to be “ChatMsg”. In ChatMsg class, there should be who send the message, who will receive it, and what’s the status of the message. Many users will receive the same ChatMsg Object. And one ChatMsg only contain one Message. If one ChatMsg is not exist, can the Message in it be exist? I think there should be strong relationship between Message and ChatMsg. And I call the relationship as “co-exist”. I draw solid diamond line between ChatMsg and Message. Other relationship with ChatMsg is not co-exist, but without User, the ChatMsg is meaningless. So I draw hollow diamond line between User and ChatMsg. Status is addition feature of ChatMsg. Without Status, we can not show chat status to our users. I draw arrow line between them. Now we draw Figure 4.2.1</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init2.png" alt="class-init.png" /></p>
<p><strong>Figure 4.2.1</strong> init classes 2</p>
</div>
<p>Emmm…Does ChatRoom relate with ChatMsg? Yes. We consider users chat with each other in one chat room. When one chat message generated, the system will send it to the users who are in the ChatRoom. So I put Collection<User> into ChatRoom. So here it is:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init3.png" alt="class-init.png" /></p>
<p><strong>Figure 4.2.2</strong> init classes 3</p>
</div>
<h2 id="43-think-twice"><a class="markdownIt-Anchor" href="#43-think-twice"></a> 4.3 Think twice</h2>
<p>Here, another problem should be considered. If we join/leave ChatRoom, the users of ChatRoom will be changed. Can we see ChatMsg even if we leave the ChatRoom?  If the status of ChatMsg is sent, and then someone join the chatroom, should  the ChatMsg be delivered to him? Can new comer see old ChatMsgs?<br />
There are many requirements:</p>
<ol>
<li>new comer can see old chat messages. But someone quit the room, he can not see any chat messages be occurred in the room.</li>
<li>new comer can not see old chat messages. And someone quit the room, he will see nothing chat messages.</li>
<li>new comer can not see old chat messages. But even someone quit the room, he can see chat messages before he left in any time.</li>
</ol>
<p>And there will be corresponding solutions too!</p>
<ol>
<li>Do nothing, the class digram supports the requirements 1.</li>
<li>If ChatRoom is changed, we log it. So ChatRoom should contain version. The solution also supports requirement 1 and 3. But the performance of the system will be lower than 1 or 3.</li>
<li>We store Collection&lt;User&gt; in each ChatMsg Object, and Collection&lt;User&gt; is only the snapshot of ChatRoom. It seems there is no relationship between ChatMsg and ChatRoom. And it will cost more spaces (memory/disk) than 1 or 2.</li>
</ol>
<p>I will choose solution 2. The solution can adapt many requirements, and it stores the relationship between ChatRoom and ChatMsg. And I fill more field of Class Message and User. I call “ChatRoom history” as “ChatRoomSnapshot”. When ChatRoom is changing, the system will generate ChatRoomSnapshot to store old ChatRoom. The id of ChatRoomSnapshot and related ChatRoom must be the same. So the relationship between ChatRoom and ChatRoomSnapshot is weak. I just draw a line between them. In Message, I prefer JSONObject as its content.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/classes-init4.png" alt="class-init.png" /></p>
<p><strong>Figure 4.3.1</strong> init classes 4</p>
</div>
<p>All of above are our system “Server” entities. Is it enough? Those entities seem like static or immutable. And in component diagram, there are many components. Which component is related with the class diagram? The answer is none. Figure 4.3.1 only draw basic entities. Those entities will be used in each components. And now, I will draw details of each component, and “give life” to those entities.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/09/13/Architect-week3-whatsapp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/09/13/Architect-week3-whatsapp/" class="post-title-link" itemprop="url">Architect:week3-Whatsapp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-09-13 20:06:17" itemprop="dateCreated datePublished" datetime="2017-09-13T20:06:17+08:00">2017-09-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:55:07" itemprop="dateModified" datetime="2023-10-06T20:55:07+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/architect/" itemprop="url" rel="index"><span itemprop="name">architect</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>6k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>5 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="origin"><a class="markdownIt-Anchor" href="#origin"></a> Origin</h1>
<p>I joined leetcode system design group to discuss how to design software. This is week3 topic:</p>
<p><strong>Messenger service like What’s App</strong> with the following functionalities</p>
<ol>
<li>One to One text messaging</li>
<li>Group Chat, Storage</li>
<li>Read/Delivery/Sent status</li>
</ol>
<p>Gist:</p>
<ol>
<li>We are having a conversation between two parties. A -&gt; B. Think of this process. What happens and how do you explain to interviewer</li>
<li>Asynchronous - meaning, “You are on a flight and you receive messages once you land. So those messages were waiting some where!” (Hope you got it). How would you design it</li>
<li>Horizontal scaling, Load Balancer</li>
<li>For Read/Delivery/Sent status -&gt; 3 way handshake protocol can give you an idea.</li>
</ol>
<p>This is a good topic. I will try to design it.</p>
<h1 id="scenario"><a class="markdownIt-Anchor" href="#scenario"></a> Scenario</h1>
<p>First of all, what’s the scenarios? The scenarios will correct my design. The scenario is in which way people use our software. So let’s think scenario first. The scenario should be atomic, and can not split into two or more scenarios. The scenario is a completed interaction. For example, The scenario like:</p>
<ol>
<li>User A send message to the system.</li>
<li>The system send message to User B.</li>
</ol>
<p>Step 1 or Step 2 is not a scenario. Step 1 with Step 2 is a completed scenario.<br />
And our chat system will be like:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/init-system.png" alt="init-system" /></p>
<p><strong>Figure 2.1</strong> init system</p>
</div>
<p>Er…It’s too simple…So let’s write more scenarios:</p>
<h2 id="scenario-1-send-and-get-message-in-realtime"><a class="markdownIt-Anchor" href="#scenario-1-send-and-get-message-in-realtime"></a> Scenario 1: send and get message in realtime</h2>
<ol>
<li>User A send message to the system.</li>
<li>The system send message to user B.</li>
</ol>
<h2 id="scenario-2-send-message-and-get-it-after-a-while-because-user-is-offline"><a class="markdownIt-Anchor" href="#scenario-2-send-message-and-get-it-after-a-while-because-user-is-offline"></a> Scenario 2: send message and get it after a while, because user is offline.</h2>
<ol>
<li>User A send message to the system.</li>
<li>At this time, user B is offline.</li>
<li>User B is online.</li>
<li>The system send message to User B.</li>
</ol>
<h3 id="scenario-3-read-old-messages"><a class="markdownIt-Anchor" href="#scenario-3-read-old-messages"></a> Scenario 3: read old messages</h3>
<ol>
<li>User can read old messages of chat in receive-time order.</li>
</ol>
<h2 id="scenario-4-group-chat-in-realtime"><a class="markdownIt-Anchor" href="#scenario-4-group-chat-in-realtime"></a> Scenario 4: group chat in realtime</h2>
<ol>
<li>User A, B, and C join a chat group</li>
<li>A send message to the system</li>
<li>B and C receive the message from system.</li>
</ol>
<h2 id="scenario-5-group-chat-when-someone-is-offline"><a class="markdownIt-Anchor" href="#scenario-5-group-chat-when-someone-is-offline"></a> Scenario 5: group chat when someone is offline</h2>
<ol>
<li>User A, B, and C join a chat group</li>
<li>User A send message to the system.</li>
<li>C will receive the message in realtime.</li>
<li>At this time, user B is offline.</li>
<li>When User B is online, the system send message to User B in create-time order.</li>
</ol>
<h2 id="scenario-6-chat-status-changing"><a class="markdownIt-Anchor" href="#scenario-6-chat-status-changing"></a> Scenario 6: chat status changing</h2>
<ol>
<li>User A chat with B</li>
<li>When A is typing words, B will get “A is typing…” message from system.</li>
<li>When A press “send” button, A will get “the message is sending” from system.</li>
<li>When B’s app receive the message in background, A will get “the message is delivered”.</li>
<li>When B open the chat with A, and scroll to the message, A will get “the message has been read.”</li>
</ol>
<p>Here, scenario 5 and 4 is similar to 2 and 1. So can we consider scenario 2 and 1 are group chat with only one person? Can I chat with myself? And there should be more scenarios be considered. For example:</p>
<ol>
<li>User sign in</li>
<li>User sign up</li>
<li>User quit</li>
<li>Invite other user to use the app</li>
<li>Find a user</li>
<li>Add relationship with other user, family, friends, enemy, lover, couple, and so on. Others should comfire the relationship.</li>
<li>Break the relationship.</li>
<li>Rebuild the relationship with the same user. Er…Are you crazy? …Trust me, most of lovers will repeat break-rebuild relationship scenarios. If you don’t believe it, you must be younger than me.</li>
<li>Build a chat group, or invite other user one by one to join chat/group chat.</li>
<li>Exit a chat group, but can not exit one-one chat, unless breaking the relationship.</li>
<li>Type message with emoji, gif, png, voice, and other rich text.</li>
<li>Search old messages</li>
<li>Delete old messages.</li>
<li>Set/Show online/offline or other user status to one or more users.</li>
<li>Can we chat face to face?</li>
<li>Change user own info</li>
</ol>
<p>In this article, we can not talk all above. It’s too complicated. I will only focus on group chat and chat status changing scenarios.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/scenarios.png" alt="scenarios" /></p>
<p><strong>Figure 2.2</strong> scenarios relationship</p>
</div>
<p>Like Figure 2.2 describles, one-one chat is a special case of group chat. So here use inherit arrow. The interaction of scenario 6 will be included from group chat scenarios. But scenario 3 is alone. If scenario 3 is discarded, our message service will be like “Snapchat”. And I use “User” actor instead of “User A” or “User B”. Why I always write a rectangle as “Messager service”? Because the rectangle warns us, our service has its own boundary! We will not consider other scenarios. If those scenarios inside of rectangle do not be implemented, our service is useless. And if you want to add more functionalities, the rectangle will be bigger and bigger. So thinking about your limit time and money, can you add more functionalities? The correct thing is creating worked well service, notwriting piles and piles of functionalities. Mmmmm…sound like: I use your “Messager service”, will you add “beautify photo”? <strong>NO!!!</strong></p>
<h1 id="how-to-design"><a class="markdownIt-Anchor" href="#how-to-design"></a> How to design?</h1>
<p>Seems like we always talk about how user use our messager service. Er…Correct! So here I will write something about how to design it. I don’t know how to build the system. I only knows there should be a client and a server…So like that:</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/init-components.png" alt="init-components" /></p>
<p><strong>Figure 3.1</strong> init components</p>
</div>
<p>Now, we have first components diagram. Let’s do more thinking. If we store data, we will have database. If we connect with others, there should have a channel mananger. My chat groups should be controlled by group manager. If some user is offline, can we send offline message to them by APNS? Adding schedule component for sending message to offline user is a good idea. There should have a component for transforming “chat message” to service data, and doing reverse. And another component called “chat service” controls all component to work togather.</p>
<div align=center>
<p><img src="/images/Architect-week3-whatsapp/more-components.png" alt="more-components" /></p>
<p><strong>Figure 3.2</strong> decompose components</p>
</div>
<p>In Figure 3.2, I decompose “Client” into “Interface”, “Transform” and “Channel”, and decompose “Server” into other small components. How to use line to connect those components? The answer is if the connection between components exists, connecting them. It’s nosense!! And another way to deal with the connections is following data flows. In Message services, there exists at least two data flows.</p>
<ol>
<li>User -&gt; Client Interface -&gt; Transform message to bytes/data -&gt; send to Channel -&gt; Server Channel Mgr receive bytes/data -&gt; Transfrom into server data -&gt; according to data, pull group data from Group Mgr and store message into Database.</li>
<li>According to group info, sending message to other group members -&gt;  Transfrom server data into bytes -&gt; send to Channel Mgr -&gt; delivery message to Client Channel -&gt; Transform bytes to message -&gt; display message to User.</li>
<li>Schedule reading what cannot be deliveried -&gt; send message through Chat Service -&gt; Transfrom server data into bytes …</li>
</ol>
<p>Er…Can we connect Group Mgr with DAO? <strong>YES</strong>. One point is you can change all diagrams in any time. And another point is, if you don’t draw line between Group Mgr and DAO, you can implement the system as well. For example,</p>
<ol>
<li>we can store group info into files</li>
<li>we use Chat Service as proxy to store group info. Chat Service will call DAO to store group info, if chat exist. If the group members are all silence, the group will be destroyed after a while.</li>
</ol>
<p>Is there a formal way to draw those components and lines? <strong>NO.</strong> This is why the software is attractive. <strong>Every software is artwork.</strong> Do you remember your first program? Always print: “Hello World!” It’s boring! Can we make the world different?</p>
<p>End? No. I will write how to decompose conponent into classes later.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/08/05/code-comments/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/08/05/code-comments/" class="post-title-link" itemprop="url">代码论千言：如何评价别人的代码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-08-05 09:56:02" itemprop="dateCreated datePublished" datetime="2017-08-05T09:56:02+08:00">2017-08-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:56:41" itemprop="dateModified" datetime="2023-10-06T20:56:41+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>3.2k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>3 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="引子"><a class="markdownIt-Anchor" href="#引子"></a> 引子</h1>
<pre><code>遇到一个陌生人，只看到他沾满泥土的鞋子。
夏日地铁里，闻到了周围人的汗臭。
朋友聚会，似乎有些人眼屎没擦干净。
初次相亲见面，就一直在说对方不好看。
你看到别人的种种不足，当面指出来，为什么没有人感谢你？
不光没有人感谢，似乎还有人恶言相向，某些人还因此要打你。
你做错了吗？
                                 ————《帐前卒的寓言》
</code></pre>
<div align=center>
<p><img src="/images/code-comments/not_to_know.jpg" alt="I don't want to know" /></p>
</div>
<p>Code Review作为编码社会活动，一直被人诟病。每个人似乎都知道Code Review好，但是推广起来却有种种困难。而“用IDE编程”这事似乎根本就不用推广。这到底是为什么？因为Code Review中不可避免要指出别人的代码不足。我们也经常会遇到：</p>
<ul>
<li>评价/建议后，编码者却不修改；</li>
<li>总是同一种错误，一犯再犯；</li>
<li>抵制你的评价意见，寻求他人再次Review。</li>
</ul>
<p>我们review别人的代码，不是专门为代码点赞，那是“鼓励师”要做的事情。我们主要是指出别人的代码哪里写的不好。我想，即使是最和善、最理智的程序员也肯定不喜欢那些评论。即便如此，我们还是要评论，要让别人接受我们的观点。不过为了让别人乐于接受，肯定要有恰当的鼓励。另外，在评论别人的代码之前，我们最好知道是谁写的代码。如果是匿名的，当然可以肆无忌惮的评论。但Code Review是一种非匿名的社交活动：我们都知道编码者是谁，编码者也知道评价者是谁。与说话的技巧一样：“对什么人,说什么话”。所以我们首先需要了解编码者。</p>
<h1 id="读代码识人心"><a class="markdownIt-Anchor" href="#读代码识人心"></a> 读代码识人心</h1>
<pre><code>比鬼神更可怕的，是人心。
                    ————《盗墓笔记》
</code></pre>
<p>读懂人心，实在是太难了。通过代码去读懂人心，那就更难了。如果和编码者经常在一起，性格喜好自然能略知一二。如果你从来没有接触过编码者，只看代码能了解什么呢？我们无法从代码中看出那人的血型、星座、爱好；也难看出勇敢、乐观、顽强、抑郁或悲伤；更看不出他是表现型、分析性还是实干型。当然以上那些性格特点对我们评价代码也没有什么卵用。从代码中读懂人心，只需关注三个方面：</p>
<ul>
<li>是否认真编码</li>
<li>是否对技术有激情</li>
<li>编码水平怎么样</li>
</ul>
<p>为什么只关注这三个方面？认真的编码者对细节格外关心，指明他代码细节的缺陷，他的技术水平一定会有提升。有激情的编码者一定会迫不及待的使用新的技术、新的语法、新的组件。应该告诉他们这些新的技术、语法、组件在代码里用的是否恰当。高水平的编码者乐于提高自己的编程技巧，也喜欢破坏现有的规则，他们看重的只有逻辑错误和运行时问题。Review时，投其所好，才能让编码者信任你，然后才可能接受你的建议。如果编码者编码不认真、技术没激情、水平也不咋样，请问该怎么办？这我们后面会说。</p>
<h2 id="认真的编码者"><a class="markdownIt-Anchor" href="#认真的编码者"></a> 认真的编码者</h2>
<p>编码者是否想到你所想到的细节，是否还考虑了你没有想到的点？是否遵循了code style规范中每一条细节？是否考虑了边界情况？在特殊处理的地方，有没有写详细的注释？当他看到你的评论时，不管同意与否，他是否每一条都认真回复了。</p>
<h2 id="有激情的编码者"><a class="markdownIt-Anchor" href="#有激情的编码者"></a> 有激情的编码者</h2>
<p>编码者是否尝试了新的技术：新的组件、新的语法糖？是否愿意解决一些别人不碰的难题？不那么美观的代码是否充满了不断尝试的味道？是否规避了存在问题的第三方组件？是否尝试写过一些公用组件？是否对旧的问题有新的思路?</p>
<h2 id="高水平的编码者"><a class="markdownIt-Anchor" href="#高水平的编码者"></a> 高水平的编码者</h2>
<p>编码水平有优劣，但这个优劣大多数只存在于人的内心。有时候你看了一眼别人的代码，你心里想：“这段代码能写的更简单，更容易。” 所以优劣大多是和自己比较的：技术比自己好，还是比自己差。如果你熟悉整个团队，那么你就能知道这个人的编码水平大概处于整个团队的什么位置。</p>
<p>但是编码者提交的代码量太少，或者大多是log/print/bean，无法了解他这三个方面的特质，那就用comments多交流几次。</p>
<h1 id="书写评论"><a class="markdownIt-Anchor" href="#书写评论"></a> 书写评论</h1>
<div align=center>
<p><img src="/images/code-comments/write.jpeg" alt="write comments" /></p>
</div>
初识，最好多点赞，并建议如何编码。如果对方是新入职的人员，最好一次性的指出程序要修改的地方。一是他有时间修改；二是新人需要了解公司里的编码规范；三是提升他的编码水平。
<p>在review的过程中不要否定新技术，也不要轻易肯定新技术，<strong>适用才是评判依据</strong>。为什么使用这些新技术？是旧的写起来麻烦，还是旧的无法满足需求，还是只为尝鲜？对于调研团队，我们鼓励使用各种新的技术。不管是挖坑还是填坑，需要通过他们的使用情况，了解多种新技术的功能特性、成熟度、性能优劣和适用条件。对于功能交付团队，不管是上线还是开发软件给客户使用，能满足需求的同时，一定要为了稳定不折腾。否则后期就会被bug所累，疲于奔命。</p>
<p>表达相同意思的一段文字可以有不同的写法。工作要有乐趣，不要评论千篇一律、枯燥乏味。下面我要说几种评论的风格:</p>
<ul>
<li>
<p>吐槽。针对熟识的同事或者针对技术水平很高的人。幽默风趣，又让人容易接受。</p>
</li>
<li>
<p>委婉建议。针对有激情的人，不应该抹杀别人的技术追求。多以疑问句为主，让其自己反思。</p>
</li>
<li>
<p>批评。针对多次犯同一错误的新人。他们犯的错误一般都是非常容易改正。例如，多写常量定义、使用linux换行符、打印不用System.out等等。有时用感叹句让批评的语气再严厉一点，否则下次新人还会犯同样的错误。</p>
</li>
<li>
<p>直白陈述。可能大多数评论采用的是这种句式。另外针对编码“得过且过”的<strong>老码农</strong>，你可能需要多写点：除了点明问题所在，还应该建议他怎样去修改代码。这样可以减少他的返工次数，消减他的抵触情绪。</p>
</li>
<li>
<p>讥讽。除非是你的好基友，否则不要用，不要用，不要用，说三遍，不要树敌。</p>
</li>
</ul>
<h1 id="当面交流"><a class="markdownIt-Anchor" href="#当面交流"></a> 当面交流</h1>
<div align=center>
<p><img src="/images/code-comments/communicate.jpeg" alt="communicate" /></p>
</div>
既然当面交流，不妨听听编码者怎么看待你的评论。不要一言不合就暴跳如雷，要问问他想怎么修改，或者为什么不想修改。
<p>出发点还是**“利”**字。但是受益者可能不同的：是编码者得利，还是团队得利，还是公司得利。这就要看你的三寸不烂之舌，如何既讨人欢心又让人听你指示。程序员这群理智的动物，有时最看不惯的就是阿谀奉承。大家都是靠技术混饭吃的，虽然糖衣炮弹固然重要，但更重要的是言明利弊。</p>
<p>有些人即使你心平气和的交流，仍然不愿意修改他们的代码，这时候就要关注问题的边界。如果在容忍的边界里，或者对建议置之不理，或者允许开发者以后再修改。如果是边界之外，就应该据理力争。那边界究竟是怎样划定的呢？我写在下面：</p>
<ul>
<li>代码中存在bug。bug会导致各种错误，有些会导致数据错乱、文件错乱等难以修复的问题。</li>
<li>代码难以理解，日后难维护。当然如果写这代码的人永不离职，自己维护尚可。可人要是离职了，还要看后继者是否愿意担风险去重构这些代码。</li>
<li>长时间运行有问题。那多久会出问题呢？看多久再次部署，如果每天都部署一次，两天就算长时间了。但是为了让团队每个人都休息好、有自己的假期、以及不在休假时被打扰，还是尽量考虑长远一点。如果你最长假期有10天，那至少要考虑软件运行大半个月没问题。</li>
<li>数据量大、访问量大时，代码运行缓慢或者宕机。如果估算运行部署几天后数据/访问量就会到达这个规模，那一定要尽早修改代码。</li>
<li>改动后将大量节省他人的时间。如果将代码抽取为模块或者组件后，有更大的收益。特别是他人即将开始这部分工作时，一定要尽快的抽取出相关代码。不抽取的话，一是别人也要写相关代码；二是一旦有修改，相同功能的代码都会修改；三是即使后期再抽取了组件，也没人愿意重构。</li>
</ul>
<p>我们都是执着的技术人，我们心中自有不可逾越的底线，我们也希望所有的编码者不要越过这条底线。我们把这底线告诉给编码者，这也是Code Review中评审者的义务。但建议也写了，见面也谈过了，编码者和审阅者两方就是各不相让。那没有其他办法，只能通过公司里的人事关系去解决：</p>
<ul>
<li>如果是你的下属，都已经讲明白道理，还是不执行，那是这个下属不称职。</li>
<li>如果是你的上级，你已经告知了他风险，他觉得你的建议没有道理，那就请他说出自己的道理。当然你觉得是他是一个傻X领导，拍拍屁股走人就是；但如果你<strong>越职言事</strong>，那就是大忌了。</li>
<li>如果是你的平级，告知他上级代码的风险，之后就交给他的上级处理吧。</li>
</ul>
<p>当然你需要知道，为了权衡：有时为了紧急上线，有时为了更大的利，即使逾越了你的底线，也要先把代码merge了再说。。</p>
<p>Code Review是为了什么？最终是为了获利。在公司，什么都不考虑，只为把代码写的完美无缺，那才是真的傻。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://chillyc.info/2017/07/27/code-review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/icon.svg">
      <meta itemprop="name" content="帐前卒">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="帐前卒专栏">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 帐前卒专栏">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/27/code-review/" class="post-title-link" itemprop="url">Code Review工程实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2017-07-27 21:07:24" itemprop="dateCreated datePublished" datetime="2017-07-27T21:07:24+08:00">2017-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-06 20:57:51" itemprop="dateModified" datetime="2023-10-06T20:57:51+08:00">2023-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>11 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文分三个部分：先讲Review代码的流程，再讲Review的技巧，以及如何推动公司层面Code Review.</p>
<ol>
<li>Review流程这一部分比较简短。流程多变,但都是为了发现代码的问题，反复建议提交者修改。</li>
<li>Review技巧我这部分分两个章节介绍。一章主要讲如何阅读代码，reivew的重点在于阅读。与读文章一样，也分粗读和细读。另外一章讲review代码的重点考察点，比较散乱也比较长。如何评论别人的代码并不是本文的内容。下面的言论也不是评论别人代码时用到的，所以请大家注意一下。以后会写一篇文章详细阐述如何评论别人的代码。</li>
<li>推动公司进行Code Review， 这一章节纯属于个人的愚见，大家有更好的想法也欢迎讨论。</li>
</ol>
<h1 id="第一章-review流程"><a class="markdownIt-Anchor" href="#第一章-review流程"></a> 第一章 Review流程</h1>
<div align=center>
<p><img src="/images/code-review/reviewstate.png" alt="reviewflow" /></p>
</div>
写完代码后，发送diff给指定人review。待给出意见后，修改代码，继续提交diff，直到review通过。通过review的代码由审阅者自动或者手工Merge代码到指定分支。多人协作review时，第一位阅读者给出粗略意见，第二位看意见是否给的恰当，再补充其他意见。多人同时review,也可将代码用投影仪打到大屏，共同review一段代码。
<p>这里需要思考几个问题：</p>
<ol>
<li>review的分工。有多人参与时需要考虑这个问题。最好有一个总负责人。</li>
<li>review的策略。项目初期应该主要考察代码结构是否符合规范，即代码是否放到了相应的位置。项目中期应该以逻辑正确、简化代码、重构现有代码为主要考察点。项目后期主要看程序性能相关的优化问题。</li>
<li>review通过的策略。 什么样的代码才能通过review。 是不是需要完全符合checklist? 我个人并不赞同完全遵照checklist。后面我会细说。</li>
<li>如何反馈已修改？review代码的工具一般是gitlab, reviewboard, gerrit。这些工具都提供了comments这一功能。review的时候可以写下comments。 如果对照comments进行修改，那么在comments后回复已经修改即可。</li>
<li>如何反馈拒绝？这个最好找审阅者当面说清楚:为什么不按照建议编写代码。如果认为自己文笔非凡的也可以在review工具中写明白。</li>
<li>review修改后再次review的策略。要对照之前的comments看看编码者是如何修改的。当然也要看看有什么新加入的代码。</li>
<li>代码没有必要写完后再review。可以写一部分review一部分。</li>
</ol>
<h1 id="第二章-阅读代码的技巧"><a class="markdownIt-Anchor" href="#第二章-阅读代码的技巧"></a> 第二章 阅读代码的技巧</h1>
<div align=center>
<p><img src="/images/code-review/code.png" alt="代码" /></p>
</div>
如何阅读别人提交的代码？首先要了解这代码的上下文和需求，不能不负责的指点江山。要充分了解需求，才能考虑如何实现，然后才能审阅别人的代码。不能因为读不懂别人的代码就拒绝别人的代码。这事开源界常发生，但公司内部最好杜绝发生。大家都是同事，低头不见抬头见，没必要关系僵化。你是能炒别人鱿鱼还是你自己要离职呢？看不懂代码可能有三种：一种使用了混淆、一种提交者写的烂、一种审查者能力不足。
<p>混淆代码一般都是有特殊原因的，但不会是故意刁难审阅者。比如说机密的模块、需要隐藏秘钥或算法。这部分代码讲明白意思即可，一般也不需要review。</p>
<p>如果提交者写的太烂，一般都是i,j,k的命名导致。审阅者更应该读懂后，指出哪些地方需要改进：比如少写了注释，改个好名字等。写的烂并不会导致你读不懂，一般是你不愿意花时间去读。如果你说事不关己，没必要看烂的代码。这种心态也不适合进行Code Review，只适合小作坊编程。不如谦虚谨慎、虚怀若谷。</p>
<p>最后一个原因：请先提高自身的编程能力！有许多算法精妙难懂，在自己编程水平不足的时候决不能以读不懂为由拒掉。</p>
<p>当你有足够的编程能力时，review代码时请遵照下面的流程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">粗读（知道大概写了哪些内容） </span><br><span class="line">=&gt; 抽取重点（架构/类的定义/代码结构）</span><br><span class="line">=&gt; 细读代码（简化/重构）</span><br><span class="line">=&gt; 逻辑判断 (各分支)</span><br><span class="line">=&gt; 细节优化（资源释放，线程安全、算法效率）</span><br></pre></td></tr></table></figure>
<ol>
<li>通过粗读，我们需知提交者改动了什么。是大量修改？还是大量新增？有没有针对性的测试？没有改动配置文件? 有没有改动数据库？</li>
<li>我们再仔细看看设计是否恰好符合了需求。是顺序的代码，用到了多线程？还是使用了设计模式？抑或用了第三方组件/架构？是集中式，还是分布式？数据是怎么存储的？单元测试有没有测重点？还有没有更好的设计？</li>
<li>再细读一遍代码。挑出繁琐的代码与相似的代码。看是否有简化或重构的可能。嵌套是否太深。是否有难懂的代码。</li>
<li>仔细寻找逻辑判读的语句if，while，for等。主要看每一个分支是否符合需求，是否是笔误。</li>
<li>最后把你的注意力集中在资源释放、线程安全、算法效率上。看看有没有优化的空间。</li>
</ol>
<h2 id="第三章-代码考察点"><a class="markdownIt-Anchor" href="#第三章-代码考察点"></a> 第三章 代码考察点</h2>
<p>如果你使用IDE，例如IDEA. 在IDEA中点击Analyze =&gt; Inspect Code … 就可以做静态检查。主要检查拼写、静态变量、包和类名等. 提交者应该用这些工具在提交代码前自查，修改一些简单的语法优化和单词拼写错误，然后再交给别人审核。</p>
<p>编写代码如同写文章一样；审阅代码和审阅文章也有相通之处。这里大部分技巧来自审阅文章的方法。我这里不讲Java语法的东西，也不讲性能优化的事情。那些代码太特殊，太依赖于特定的语言和上下文。我这里将以Java代码为例，但你也可以将这些技巧用于审阅其他的语言。我审阅代码时一般考察以下几点：</p>
<h3 id="31-优雅即正义"><a class="markdownIt-Anchor" href="#31-优雅即正义"></a> 3.1 优雅即正义</h3>
<p>什么是优雅的代码？我觉得整齐划一的代码不一定是优雅的代码。python的代码都是优雅的？其实不管什么语言，总会写出烂代码。简练的代码不一定是优雅的代码。优雅的代码不仅格式让人舒服，而且简练易读。读过之后，清楚代码到底做了什么事，了解它在运行时大概是什么样子的，知道在哪里改动代码来满足新的需求。</p>
<p>如果你是一个熟知数据结构、算法、设计模式、成熟的架构、编程语法、常用中间件、操作系统的程序员，通读了代码，却无法回答以上问题，那就不是优雅的代码。一定是哪里写的比较混乱，或者隐藏了一些时序因果。不是优雅的代码，就一定有需要改动的地方。</p>
<h3 id="32-姓谁名何"><a class="markdownIt-Anchor" href="#32-姓谁名何"></a> 3.2 姓谁名何</h3>
<p>名字很重要。你所知道的各大公司。Google是什么？是一个名字。阿里巴巴是什么？也是一个名字。你能数出来的各大品牌，都是一个个名字,所以名字很重要。名字能让你区分事物。你不应该把所有的变量都命名为a,b,c,i,j,k.各位的家长也没有给大家取名叫你，我，他。所以当你review类名/变量名/函数名的时候，请想想能否起一个更好记更易懂的名字。</p>
<h3 id="33-份内之事"><a class="markdownIt-Anchor" href="#33-份内之事"></a> 3.3 份内之事</h3>
<p>一个类/函数能做完的事情，不要在类/函数外完成。下面是一个执行远程cmd并返回结果的代码片段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResultEntity result = CommandUtil.exeCommandUtil(user, location, cmd, host, opt); </span><br><span class="line">result.setSubmitTime(time); </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>为什么result的提交时间不能在exeCommandUtil里面补全？这函数如果出现了十几、二十几处。那每一处都要多写一行代码。能清楚的分辨类和函数的职责并不是一件容易的事情，需要大量的经验积累。其实我们大多数人连本职工作是什么都不知道，就更难写出知道自己要干什么的类/函数了。现实中我们经常遇到本应该那人份内之事，你却要催促他完成。本应该他将工作进度告知你，你却要不断询问他完成的怎么样了。本应该他代码处理的事情，非要你帮他二次处理一下。</p>
<h3 id="34-看了代码开始怀疑人生"><a class="markdownIt-Anchor" href="#34-看了代码开始怀疑人生"></a> 3.4 看了代码，开始怀疑人生</h3>
<p>很多时候看代码看不懂，或者很迷茫。说白了，是审阅者和编码者脑回路不匹配导致。主要是因为编码者实现了太多的子类，或者类的层次太深，或者子类之间没有什么共同点。有时候，编码者用消息中间件实现了组件之间的分离，代码中隐藏了生产者与消费者之间联系。我们人类是按照时序思考的，任何破坏时序因果的代码都会让我们感觉迷茫。但这样的代码并不代表质量不高。只是希望改动后能更容易读懂。对于子类中没有什么共同点的可能需要拆开重构；对于消息分离的需要多加些注释，在注释中告诉读者下一阶段的处理流程是什么。如果是生产者，需要在注释中告诉读者，生产的某一消息，将被哪些消费者使用。如果是消费者，可以在注释中说明一下可能获取怎样的消息。</p>
<h3 id="35-逸马毙犬于道"><a class="markdownIt-Anchor" href="#35-逸马毙犬于道"></a> 3.5 逸马毙犬于道</h3>
<p>有些人写代码总免不了说废话。精炼自己/别人的代码。代码越精简，开发/阅读速度就越快。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This function is for adding user</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUser</span><span class="params">()</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我觉得上面的开发者绞尽脑汁才写出了那一行注释。再如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="36-言不达意"><a class="markdownIt-Anchor" href="#36-言不达意"></a> 3.6 言不达意</h3>
<p>需求是增加加入组织、退出组织的接口。实现者为了开发方便，将功能放入到了一个handler里面，然后用一个enum Type来标示操作类型。而Type使用了位与操作来判断可能的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (JOIN.isContainType(type)) &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		join(group);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		LOG.warn(<span class="string">&quot;join group with wrong.params:&quot;</span> + JSON.toJSONString(params), e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (EXIT.isContainType(type)) &#123;</span><br><span class="line">    <span class="comment">// do exit.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>type可能是多个操作的集合吗？那<em>JOIN</em>这个单一操作怎么可能包含多操作type？名字也有问题。是不是改成下面的代码更好？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (op.isContainOp(JOIN)) &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		join(group);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		LOG.warn(<span class="string">&quot;join group with wrong.params:&quot;</span> + JSON.toJSONString(params), e);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (op.isContainOp(EXIT)) &#123;</span><br><span class="line">     <span class="comment">// do exit group.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再想想，其实op只可能是单一操作。看上下文请求这一个接口不可能既加入组织又退出组织。这实在太混乱了。万一不小心将EXIT判断写到JOIN前面，岂不是先退出组织再加入组织？所以合理的代码只能是下面这种</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(op) &#123;</span><br><span class="line">    <span class="keyword">case</span> JOIN:</span><br><span class="line">        <span class="comment">// do join group</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> EXIT:</span><br><span class="line">        <span class="comment">// do exit group</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="37-01日志图灵在世"><a class="markdownIt-Anchor" href="#37-01日志图灵在世"></a> 3.7 0/1日志,图灵在世</h3>
<p>打印log的代码和下面两句非常类似：一条是正确的日志，一条是错误的日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log.info(<span class="string">&quot;user is login&quot;</span>);</span><br><span class="line">log.warn(<span class="string">&quot;user op error.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>输出日志可能是这样的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user is login</span><br><span class="line">user is login</span><br><span class="line">user is login</span><br><span class="line">user op error.</span><br><span class="line">user op error.</span><br><span class="line">user is login</span><br><span class="line">user is login</span><br></pre></td></tr></table></figure>
<p>What the FFFFFFFF… 我看日志我怎么知道是谁login了？又是谁做了什么导致错误了？那与只打印0, 1又有什么区别？例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">0</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>以后都改成这个就好了。还省代码和时间。甚至连脑子都省了。</p>
<h3 id="38-那不是一个人在战斗"><a class="markdownIt-Anchor" href="#38-那不是一个人在战斗"></a> 3.8 那不是一个人在战斗</h3>
<p>思维要保持一惯性,比如函数签名。如果某个变量一直出现在另外一个变量之前，那么请保持变量的相对位置不变。另外变量名也要尽可能的一致。审阅这些代码的时候，我总有一种错觉：那不是一个人写的代码，一定有人在帮他写代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(String srcPath, String dstPath)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mv</span><span class="params">(String srcPath, String dstPath)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String path)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">innerCopy</span><span class="params">(<span class="type">boolean</span> force, String dest, String src)</span>;</span><br></pre></td></tr></table></figure>
<p>src都应该在dst前面。取名最好都是srcPath和dstPath，innerCopy最好这样写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">innerCopy</span><span class="params">(String srcPath,String dstPath, <span class="type">boolean</span> force)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="39-不做标题党"><a class="markdownIt-Anchor" href="#39-不做标题党"></a> 3.9 不做标题党</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getScript</span><span class="params">(String appId, JSONArray jobSysParams, JSONArray appParams, String userId)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	...</span><br><span class="line">	ExecShellUtils.execShell(script);</span><br><span class="line">	<span class="keyword">return</span> Path.join(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>起初我看到这个函数名时，我觉得这应该是一个获取用户在某个应用下的脚本。当看到ExecShellUtils.execShell，我觉得这函数应该是直接执行了这个脚本。然后又看到return Path.join()，这怎么又返回了这个脚本的路径？这样的话，函数名应该叫execScriptAndReturnScriptPath()。</p>
<h3 id="310-请站在巨人的肩上"><a class="markdownIt-Anchor" href="#310-请站在巨人的肩上"></a> 3.10 请站在巨人的肩上</h3>
<p>多使用jdk,自有库和被验证的第三方库的类和函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Cluster&gt; clusterMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCluster</span><span class="params">(String clusterId, Cluster cluster)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ClusterManage.class) &#123;</span><br><span class="line">            clusterMap.put(clusterId, cluster);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Cluster <span class="title function_">getCluster</span><span class="params">(String clusterId)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ClusterManage.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> clusterMap.get(clusterId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Cluster&gt; <span class="title function_">getAllCluster</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clusterMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ClusterManage.class) &#123;</span><br><span class="line">            clusterMap.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完全等价于下面的代码，ConcurrentHashMap的性能还要比上面的快许多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClusterManager</span>  &#123;</span><br><span class="line">     <span class="keyword">private</span> Map&lt;String, Cluster&gt; clusterMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">     ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再如将流变为String的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">inputStream2String</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (( i = is.read() ) != -<span class="number">1</span>) &#123;</span><br><span class="line">			bos.write(i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(EXCEPTION_TYPE.READ_FILE_ERROR);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (is != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				is.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bos.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以使用apache提供的commons.io替换。另外上面的代码还破坏了谁申请谁释放的原则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">inputStream2String</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        IOUtils.toString(is);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(EXCEPTION_TYPE.READ_FILE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>甚至你可以连这个函数都不写了。直接调用IOUtils.toString()。</p>
<h3 id="311-多歧路今安在"><a class="markdownIt-Anchor" href="#311-多歧路今安在"></a> 3.11 多歧路，今安在</h3>
<p>下面的代码if中的判断条件太多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (((optLocal.immediate != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">             ((optLocal.immediate == <span class="number">1</span>) ||</span><br><span class="line">              (difftime(now(), srun_begin_time) &gt;=</span><br><span class="line">               optLocal.immediate))) ||</span><br><span class="line">            ((rc != ESLURM_NODES_BUSY) &amp;&amp; (rc != ESLURM_PORTS_BUSY) &amp;&amp;</span><br><span class="line">             (rc != ESLURM_PROLOG_RUNNING) &amp;&amp;</span><br><span class="line">             (rc != SLURM_PROTOCOL_SOCKET_IMPL_TIMEOUT) &amp;&amp;</span><br><span class="line">             (rc != ESLURM_INTERCONNECT_BUSY) &amp;&amp;</span><br><span class="line">             (rc != ESLURM_DISABLED))) &#123;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// do something</span></span><br><span class="line">             &#125;</span><br></pre></td></tr></table></figure>
<p>改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">intervalTime</span> <span class="operator">=</span> difftime(now(), srun_begin_time)</span><br><span class="line"><span class="keyword">if</span> (isExpired(intervalTime, optLocal.immediate) || isSlurmdConnectedOK(rc)) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="312-云深不知处"><a class="markdownIt-Anchor" href="#312-云深不知处"></a> 3.12 云深不知处</h3>
<p>嵌套太深不行呀。这里是一个通信协议解析的例子。下面是循环解析的函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (isConnected()) &#123;</span><br><span class="line">                Cmd cmd=<span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span>((cmd = read())!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">switch</span>(cmd.getCmd()) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">&quot;PING&quot;</span>: &#123;</span><br><span class="line">                            writePong();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                connect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception) &#123;</span><br><span class="line">            cleanConnection();</span><br><span class="line">            reConnect();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里代码函数幸好不长。如果长且分支多，那读代码就很容易迷失自我。应考虑拆分成多个函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">	    parse();        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isConnected()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> Exception(...);</span><br><span class="line">        &#125;</span><br><span class="line">        Cmd cmd=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((cmd = read())!=<span class="literal">null</span>) &#123;</span><br><span class="line">            processCmd(cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception) &#123;</span><br><span class="line">        cleanConnection();</span><br><span class="line">        reConnect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processCmd</span><span class="params">(Cmd cmd)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(cmd.getCmd()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;PING&quot;</span>: &#123;</span><br><span class="line">            processPing();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPing</span><span class="params">()</span> &#123;</span><br><span class="line">    writePong();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="313-己之长彼之短"><a class="markdownIt-Anchor" href="#313-己之长彼之短"></a> 3.13 己之长，彼之短</h3>
<p>以Java为例，这是一种面向对象的语言。面向对象并不是main必须放在某个类中这么狭义，需要有一切皆对象的观念才行。对象才是主题，代码总是围绕&quot;对象做了什么事&quot;来发展。如果你用C写面向对象的代码：就要写结构体，在结构体里再用函数指针。那代码看起来不舒服，写起来也不舒服。在Javascript中函数才是一等公民，要用函数式的想法去写代码。</p>
<h3 id="314-数据放在哪里"><a class="markdownIt-Anchor" href="#314-数据放在哪里"></a> 3.14 数据放在哪里？</h3>
<p>是使用关系型数据库存储还是key-value存储？是集中存放还是分布式的？上线/发布后数据量规模？这些是否都在代码里体现了？是否有遵循范式、是否有索引加速、列是否设计的恰当、主外键设置、有没有离线查询分析的优化设计、针对业务量增大后的数据划分处理，旧的数据如何兼容等。</p>
<h3 id="315-知难行亦难"><a class="markdownIt-Anchor" href="#315-知难行亦难"></a> 3.15 知难,行亦难</h3>
<p>代码写的复杂，那有没有写mock testcase? 是否输入的数据集都有考虑？单元测试有没有覆盖大部分分支？循环分支测试时0循环和1循环是否都测试到了？if分支是不是每一个谓词都测试到了？</p>
<h1 id="第四章-推动公司层面进行code-review"><a class="markdownIt-Anchor" href="#第四章-推动公司层面进行code-review"></a> 第四章 推动公司层面进行Code Review</h1>
<p>首先的首先，你要推动某件事情，你一定要先成为一个坚定的人，一个让人信服的人。那大家才会觉得你推动去做的事可行。这不是一朝一夕的事情。如果公司的大部分研发没有时间进行Code Review，这将是一件极为困难的事情。因为困难所以值得认真去做。</p>
<p>我们不能考虑以下场景：</p>
<pre><code>你振臂一呼：咱们Code Review吧。
研发人员纷纷表示赞同。
然后没两天就搭建了一个Code Review平台。
然后大家就顺顺利利开始Code review了。
老板高层纷纷表示祝贺。
</code></pre>
<p>这不叫你推动了Code Review. 这只能叫你赶上了好时候。因为没有你的振臂一呼，其他虾兵蟹将也能振臂一呼，只是早晚而已。所以这种事情太顺利，顺利到高层基层都统一意见：觉得这件事可行。还是那句话：你只是赶上了好时候。我们不讨论那么顺利的局面。我想说的是如何从最不利的局面开始推动。</p>
<h2 id="41-战略篇"><a class="markdownIt-Anchor" href="#41-战略篇"></a> 4.1 战略篇</h2>
<p>推动公司层面Code Review的战略思想是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利益为先、攻心为上、权谋次之、政令最下</span><br></pre></td></tr></table></figure>
<h3 id="利益为先没有永远的朋友只有永远的利益"><a class="markdownIt-Anchor" href="#利益为先没有永远的朋友只有永远的利益"></a> 利益为先：没有永远的朋友，只有永远的利益</h3>
<p>最为重要的一条：利益为先。公司里做事情，大家的目标就是完成KPI，而完成KPI在老板那里就是实现净利。每个公司都应该是盈利的公司，不管是现在盈利还是将来盈利。从来没有公司以不盈利为荣，因为根本就不值得炫耀。你要做的事情，首先要符合“赚钱”这一条基本原则。虽然Code Review的本质是提高效率、提高开发质量、减少成本，最终赚钱。但是Code Review投资回报周期特别长，大家特别是<em>老板和投资人</em>看不到这么深远，也没有那么多耐心。所以Code Review只能是辅助盈利的手段。先摒弃掉技术公司一定要Code Review的想法。如果同事们加班加点都不能在deadline之前完成项目交付/上线赚钱, 那说明他们的时间已经100%用在直接赚钱上了。那你能做的事就是等待，千万别提Code Review。</p>
<h3 id="攻心为上让每个人都想code-review"><a class="markdownIt-Anchor" href="#攻心为上让每个人都想code-review"></a> 攻心为上：让每个人都想Code Review</h3>
<p>每个人都忍住不去Code Review。当你振臂一呼的时候，事情就成了。如果每一个人都知道Code Review的好处，每一个人都感受到Code Review的甜头，无往不利。</p>
<h3 id="权谋次之求好心人帮帮你吧"><a class="markdownIt-Anchor" href="#权谋次之求好心人帮帮你吧"></a> 权谋次之：求好心人帮帮你吧</h3>
<p>希望有好心的Lead/CTO可以帮你，那就先和他们打好关系吧。在他们困难时出手相助，并解决问题。事后再宣传一下Code Review的妙处。用不了太久大家就会想尝试一下Code Review. 大家虽然带着尝试的心，但实践效果不错。这样大家就能坚定不移的进行Code Review.</p>
<h3 id="政令最下如果你是ctoteam-lead"><a class="markdownIt-Anchor" href="#政令最下如果你是ctoteam-lead"></a> 政令最下：如果你是CTO/Team Lead</h3>
<p>宣布从今天起，所有提交的代码都必须经过Code Reivew. 首先大部分人会质疑，但是你身处高位，可能不会有人对你说不不不不。但是反抗的心似乎已经埋下。如果结果稍稍不好，可能怨声载道。不过如果结果是好的，属下们还是会高呼“英明领导”。</p>
<p>战略思想必须贯彻始终。需要大家摆正心态，不要在意一时的得失。即使现在无法推动Code Review，不代表以后没有机会。下面的章节将介绍推动的阶段和每个阶段对应的策略。</p>
<h2 id="42-阶段篇"><a class="markdownIt-Anchor" href="#42-阶段篇"></a> 4.2 阶段篇</h2>
<p>我们将推动Code Review这件事情划分为四个阶段。这四个阶段一定是顺序发展的。但是每个阶段又可能直接退化到第一阶段。我称之为“逆水行舟，不进则退”。</p>
<div align=center>
<p><img src="/images/code-review/review_pharse.png" alt="reviewpharse" /></p>
</div>
### 准备阶段
这个阶段要注意三点：培训、播种、除草。这一阶段的重点是让大家或多或少的知道Code Review；激发少部分人尝试Code Review的欲望；削弱反对派的声音。当某个团队中大部分都是赞同派时就可以开始下一阶段。
<p><em>培训</em></p>
<p>首先看公司的情况。如果可以在全公司范围培训的。尽可能多培训几次。培训的主题抛砖引玉：首先如何写高质量的代码云云,然后再培训如何改进自己的代码云云,最后培训如何review别人的代码。一是宣传自己，二是让大家知道原来代码还可以这么写，三是培养一下自己的演讲技巧，四是减缓反对Code Review的情绪，五是增强赞同派的信心。所以多做培训总是有好处的。</p>
<p><em>播种</em></p>
<ul>
<li>有一部分人可以通过培训成为种子。</li>
<li>你也需要找一些有力的帮手。这些帮手应该和你都是君子之交：平时点头问候、也不礼尚往来、也无直接利害关系。但是他们有应该有一个共同点：必须是各个团队的技术负责人或者技术最牛的人。你和他们怎么交流呢？抱着虚心学习的心态用Code Review交流。看过这些人的代码，你可能需要帮忙修复逻辑错误、优化代码。也可以和他们讨论一下设计/架构的问题。提出更好的解决方案，但也不能质疑别人之前的设计。这里review一定不能使用checklist。 你要是指出这些人的代码里多加了几个空格这种无伤大雅的问题。那你就别想继续推Code Review了。</li>
<li>培养应届生。他们是最容易成为种子的人。以后也会成为公司的中坚力量。</li>
<li>老板。你应该让老板知道不进行Code Review的危害。让他觉得我们应该找个时间尝试一下。</li>
</ul>
<p><em>除草</em></p>
<p>有些人极力反对Code Review。他们觉得这占用了他们的编码时间；也可能源自他们之前的尝试。这群人的技术水平可能参差不齐，但是工作年限一般较长。技术大牛觉得你们这群杂兵就不要review我的代码了，反正我也汲取不到什么营养，还可能从我这里偷学点什么。技术一般的老人觉得我的代码怎么能公开呢?万一写的不好，威信全无。你需要慢慢转化他们的思维。你需要通过Code Review帮他们找出代码<em>运行时</em>确实会出现的bug。慢慢的，他们会觉得这种方法可以提升他们的效率，减少他们排错的时间。记住三点：绝对不要提无伤大雅的修改意见；绝对不要让别人大面积修改代码（即使你觉得代码结构实在混乱）；绝对不要拿出你的checklist对照排查。这是一场温和的变革，不能意见不合就排挤/打压/遣散反对的人。总之一句话，<em>化敌为友</em>。我们需要将反对者影响的比例控制在某个阈值以下。</p>
<h3 id="试点论证"><a class="markdownIt-Anchor" href="#试点论证"></a> 试点论证</h3>
<p>现在已经有一个团队愿意尝试这件事了。这一阶段重要是让团队成员自发得出一条结论：</p>
<pre><code>Code Review有利可图。
</code></pre>
<p>这结论应源于：</p>
<ol>
<li>自身能力的提升。知道代码有哪些地方可以更优雅一些，能看出运行时错误，减少了debug时间，学习到编码技巧。</li>
<li>团队效率的提升。顺利看懂团队写的所有代码，修复其他成员引入的bug。</li>
<li>当自己请假时，有他人可以暂代你的工作。不会打扰你休假。</li>
<li>代码稳健。不为线上bug奔波。</li>
</ol>
<p>结论已出，会进入推广阶段。</p>
<h3 id="推广阶段"><a class="markdownIt-Anchor" href="#推广阶段"></a> 推广阶段</h3>
<p>从一个团队，到其他的团队。这并不是一件非常困难的事情。只要那些团队有时间，就有尝试Code Review的机会。另外团队间交流/协作必不可少。以Code Review方式交流代码，潜移默化相关的团队。这一阶段结束的标志是大部分研发团队尝试使用Code Review，并保持3个月。</p>
<p>这一阶段的重点在于<em>奖和速</em>。</p>
<p>奖励对Code Review的推动有贡献的人。迅速的推广传播也至关重要。公司不会有那么多时间等待你推广，这期间会有大量的变数（人员流动、团队重组、高层空降、KPI变更等等），所以越快越好。</p>
<h3 id="巩固阶段"><a class="markdownIt-Anchor" href="#巩固阶段"></a> 巩固阶段</h3>
<p>恭喜已经进入到了巩固阶段。这个阶段结束的标志就是研发团队进行review活动的比例和频率在持续下降。某些进行Code Review的团队已经放弃这一活动。</p>
<p>这一阶段的重点在于<em>罚</em>。</p>
<p>惩罚不愿意进行Code Review的人/团队。这一阶段可以形成规范的Code Review checklist。 可以帮助研发团队整齐划一的编写代码。而在其他几个阶段我都不建议使用checklist进行教条式的Code Review。</p>
<h2 id="43-小结"><a class="markdownIt-Anchor" href="#43-小结"></a> 4.3 小结</h2>
<p>想要在公司层面大范围推动某件事，首先要让人信服。对于Code Review来说，需要基层和高层都赞同才行。要让赞同派发声，也要让反对派闭嘴。在大面积推广之前，你应该小心谨慎，步步为营,增加研发团队的认同感。始终要灌输Code Review有利可图这一理念。因为是你主导此事，所以一定要亲力亲为，决不能眼高手低：不review代码，也不写代码。但世间之事，哪能努力后就一定成功？倘若风云变幻，打回准备阶段。那也不必灰心，大侠请从头再来。</p>
<p>如果你技术水平还未到平均水平，仍要强推Code Review. 要么修炼自身技术；要么煽动技术大牛去推动Code Review。</p>
<h1 id="第五章-总结"><a class="markdownIt-Anchor" href="#第五章-总结"></a> 第五章 总结</h1>
<p>第一章流程部分：多人review需要注意分工协作,但是多人也容易导致无人负责。这一章主要是建立代码交流的流程。至于怎么反馈建议，使用什么工具，怎么保证这个通道畅通，并没有限制。</p>
<p>Code Review技巧分了两个章节。希望阅读后能有所启发。阅读代码的方式和阅读文章相似。但是读文章并没有跳转、递归、循环。在Code Review的考察点章节，可能有你似曾相识的言论，那就权当加深印象。我所写的是在Code Review经常/反复出现的代码问题，供大家参考。如果编码者看完这两章后若有所思，就已经达到目的。</p>
<p>第四章公司层面推动。仁者见仁，智者见智。从最不利的局面开始，如何一步步推进Code Review. 某些在公司顺风顺水、一呼百应的人完全可以忽略本文。我希望高级研发工程师和技术系高层看完后，能打开新的思路推动Code Review. Code Review这件事，毕竟和我们的职业活动息息相关，希望大家重视。</p>
<p><em>希望有人看过此文重燃起推动Code Review的念想</em>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/80/">80</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2017 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">帐前卒</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Word count total: </span>
    <span title="Word count total">1.6m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">24:10</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/bookmark.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/search/local-search.min.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha256-3574TpfThVfeAhg+I4+N39EJiLN3QUkuEsMVe8hWAR4=" crossorigin="anonymous">


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"chilly/blog_comments","issue_term":"url","theme":"github-dark"}</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.18.1/source/js/third-party/comments/utterances.min.js"></script>

</body>
</html>
